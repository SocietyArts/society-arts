<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Finder | Society Arts</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
    
    <!-- Fonts - Familjen Grotesk + Domine -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/auth.css">
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Shared Header Functions -->
    <script src="js/shared/header.js"></script>
    
    <style>
        /* ========================================
           STYLE FINDER - A++ BRAND STYLES
           ======================================== */
        
        /* Unified Header Override */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--color-surface, #F9F8F6);
            border-bottom: 1px solid var(--color-tan-20, #E7E2DC);
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .hamburger-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-brown, #3E2318);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            transition: background-color 0.15s ease;
        }
        
        .hamburger-btn:hover {
            background-color: var(--color-tan-10, #F3F1EE);
        }
        
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        
        .logo-image {
            height: 22px;
            width: auto;
        }
        
        .logo:hover {
            opacity: 0.85;
        }
        
        /* Cart Button */
        .cart-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-brown, #3E2318);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            transition: background-color 0.15s ease;
        }
        
        .cart-btn:hover {
            background-color: var(--color-tan-10, #F3F1EE);
        }
        
        /* New Project Button */
        .new-project-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            background-color: var(--color-brown, #3E2318);
            color: white;
            text-decoration: none;
        }
        
        .new-project-btn:hover {
            background-color: rgba(62, 35, 24, 0.85);
            color: white;
        }
        
        /* Style Finder Page Layout */
        .style-finder-page {
            display: flex;
            min-height: 100vh;
            padding-top: 64px;
            background: var(--color-beige, #EAE4DA);
        }
        
        /* Filter Sidebar */
        .filter-sidebar {
            width: 240px;
            background: var(--color-surface, #F9F8F6);
            border-right: 1px solid var(--color-tan-20, #E7E2DC);
            overflow-y: auto;
            padding: 20px 16px;
            flex-shrink: 0;
            height: calc(100vh - 64px);
            position: sticky;
            top: 64px;
        }
        
        /* Filter Section Labels - A++ Typography */
        .filter-section {
            margin-bottom: 24px;
        }
        
        .filter-section h3 {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-brown-60, #8B7B75);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-tan-20, #E7E2DC);
            border-radius: 8px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown, #3E2318);
            background: white;
            cursor: pointer;
            transition: border-color 0.15s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--color-tan-40, #CFC5B9);
        }
        
        .filter-select:hover {
            border-color: var(--color-tan-40, #CFC5B9);
        }
        
        /* Reset/Apply Buttons - A++ Brand */
        .filter-actions {
            position: sticky;
            bottom: 0;
            background: var(--color-surface, #F9F8F6);
            padding: 16px 0;
            border-top: 1px solid var(--color-tan-20, #E7E2DC);
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .filter-actions .reset-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: 1.5px solid var(--color-brown, #3E2318);
            border-radius: 9999px;
            cursor: pointer;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-brown, #3E2318);
            transition: all 0.15s ease;
        }
        
        .filter-actions .reset-btn:hover {
            background: var(--color-tan-10, #F3F1EE);
        }
        
        /* Apply Button - PRIMARY BROWN (not orange!) */
        .filter-actions .apply-btn {
            flex: 1;
            padding: 10px 16px;
            background: var(--color-brown, #3E2318);
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.15s ease;
        }
        
        .filter-actions .apply-btn:hover {
            background: rgba(62, 35, 24, 0.85);
        }
        
        /* Main Content - A++ Brand */
        .styles-main {
            flex: 1;
            overflow-y: auto;
            background: var(--color-beige, #EAE4DA);
            display: flex;
            flex-direction: column;
        }
        
        /* Sticky Search Header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--color-beige, #EAE4DA);
            padding: 16px 24px;
            border-bottom: 1px solid var(--color-tan-20, #E7E2DC);
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        
        .search-input-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px;
            border: 1px solid var(--color-tan-20, #E7E2DC);
            border-radius: 9999px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown, #3E2318);
            background: white;
            transition: all 0.15s ease;
        }
        
        .search-input::placeholder {
            color: var(--color-brown-40, #B2A7A3);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-tan-40, #CFC5B9);
            box-shadow: 0 0 0 3px rgba(62, 35, 24, 0.08);
        }
        
        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-brown-60, #8B7B75);
            padding: 4px;
            display: none;
            border-radius: 50%;
            line-height: 1;
        }
        
        .search-clear-btn:hover {
            background: var(--color-tan-20, #E7E2DC);
            color: var(--color-brown, #3E2318);
        }
        
        .search-clear-btn.visible {
            display: block;
        }
        
        /* Active Filter Pills - A++ Brand */
        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-pills:empty {
            display: none;
        }
        
        .filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--color-brown, #3E2318);
            color: white;
            border-radius: 9999px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 500;
        }
        
        .filter-pill-remove {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-size: 14px;
        }
        
        .filter-pill-remove:hover {
            color: white;
        }
        
        .reset-all-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1.5px solid var(--color-brown, #3E2318);
            border-radius: 9999px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-brown, #3E2318);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .reset-all-btn:hover {
            background: var(--color-tan-10, #F3F1EE);
        }
        
        /* Search Hint & Results */
        .search-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .search-hint {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 12px;
            color: var(--color-brown-60, #8B7B75);
        }
        
        .results-count {
            font-family: 'Familjen Grotesk', sans-serif;
            color: var(--color-brown-60, #8B7B75);
            font-size: 14px;
            white-space: nowrap;
        }
        
        /* Scrollable content area */
        .styles-content {
            flex: 1;
            padding: 24px;
        }
        
        /* Sort Dropdown - A++ Brand */
        .sort-container {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .sort-container label {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown-60, #8B7B75);
        }
        
        .sort-select {
            padding: 8px 12px;
            border: 1px solid var(--color-tan-20, #E7E2DC);
            border-radius: 8px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown, #3E2318);
            background: white;
            cursor: pointer;
            min-width: 150px;
            transition: border-color 0.15s ease;
        }
        
        .sort-select:focus {
            outline: none;
            border-color: var(--color-tan-40, #CFC5B9);
        }
        
        /* Quality Filter - A++ Brand */
        .quality-filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .quality-filter-container label {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown-60, #8B7B75);
        }
        
        .quality-filter-select {
            padding: 8px 12px;
            border: 1px solid var(--color-tan-20, #E7E2DC);
            border-radius: 8px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            color: var(--color-brown, #3E2318);
            background: white;
            cursor: pointer;
            min-width: 130px;
            transition: border-color 0.15s ease;
        }
        
        .quality-filter-select:focus {
            outline: none;
            border-color: var(--color-tan-40, #CFC5B9);
        }
        
        /* Style Grid - A++ Brand */
        .styles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .style-card {
            background: var(--color-tan-5, #F9F8F6);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(62, 35, 24, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .style-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(62, 35, 24, 0.12);
        }
        
        /* Multi-select mode */
        .style-card.selected {
            outline: 3px solid var(--color-orange-dark, #C73314);
            outline-offset: -3px;
        }
        
        .style-card .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--color-brown-60, #8B7B75);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            opacity: 0;
            transition: opacity 0.2s ease, background 0.15s ease, border-color 0.15s ease;
        }
        
        .style-card:hover .select-checkbox,
        .style-card.selected .select-checkbox,
        .multi-select-active .style-card .select-checkbox {
            opacity: 1;
        }
        
        .style-card.selected .select-checkbox {
            background: var(--color-orange-dark, #C73314);
            border-color: var(--color-orange-dark, #C73314);
        }
        
        .style-card.selected .select-checkbox svg {
            color: white;
        }
        
        .style-card-image {
            aspect-ratio: 1;
            background: var(--color-tan-10, #F3F1EE);
            position: relative;
            overflow: hidden;
        }
        
        .style-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .style-card-image .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-brown-60, #8B7B75);
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 12px;
        }
        
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            z-index: 2;
            color: var(--color-brown-60, #8B7B75);
        }
        
        .favorite-btn:hover {
            transform: scale(1.1);
            color: var(--color-orange-dark, #C73314);
        }
        
        .favorite-btn.active {
            color: var(--color-orange-dark, #C73314);
        }
        
        .favorite-btn.active svg {
            fill: var(--color-orange-dark, #C73314);
        }
        
        /* Three-dot menu - bottom right of image, show on hover */
        .menu-btn-horizontal {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2;
        }
        
        .style-card:hover .menu-btn-horizontal {
            opacity: 1;
        }
        
        .menu-btn-horizontal .dot {
            width: 4px;
            height: 4px;
            background: var(--color-brown-60, #8B7B75);
            border-radius: 50%;
        }
        
        .menu-btn-horizontal:hover {
            background: white;
        }
        
        .menu-btn-horizontal:hover .dot {
            background: var(--color-brown, #3E2318);
        }
        
        .style-card-info {
            padding: 8px 12px 12px;
        }
        
        /* Card Title - A++ Typography: Familjen Grotesk SemiBold 17px */
        .style-card-name {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 17px;
            font-weight: 600;
            color: var(--color-brown, #3E2318);
            margin: 0;
            line-height: 1.3;
        }
        
        .style-card-tagline {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 13px;
            color: var(--color-brown-60, #8B7B75);
            margin-top: 4px;
        }
        
        /* Multi-select action bar */
        .multi-select-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-brown, #3E2318);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 32px rgba(62, 35, 24, 0.3);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        
        .multi-select-bar.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .multi-select-count {
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
        }
        
        .multi-select-bar button {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Familjen Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s ease;
        }
        
        .multi-select-bar button:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .multi-select-bar button.cancel-btn {
            background: transparent;
            opacity: 0.7;
        }
        
        .multi-select-bar button.cancel-btn:hover {
            opacity: 1;
            background: transparent;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border, #ddd);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--color-accent, #C75B3F);
            color: white;
            border-color: var(--color-accent, #C75B3F);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: var(--color-text-secondary, #666);
            font-size: 0.875rem;
        }
        
        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border, #ddd);
            border-top-color: var(--color-accent, #C75B3F);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Style Detail Modal */
        .style-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .style-modal.active {
            display: flex;
        }
        
        .style-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .style-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--color-surface, #f5f5f5);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .style-modal-gallery {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            padding: 1.5rem;
            background: var(--color-surface, #f5f5f5);
        }
        
        .style-modal-gallery img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .style-modal-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .style-modal-info {
            padding: 1.5rem;
        }
        
        .style-modal-id {
            font-size: 0.875rem;
            color: var(--color-text-secondary, #999);
            margin-bottom: 0.25rem;
        }
        
        .style-modal-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
        }
        
        .style-modal-tagline {
            font-size: 1rem;
            color: var(--color-accent, #C75B3F);
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .style-modal-description {
            color: var(--color-text-secondary, #666);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .style-modal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .style-tag {
            background: var(--color-surface, #f5f5f5);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            color: var(--color-text-secondary, #666);
        }
        
        .style-modal-attributes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .attribute-item {
            background: var(--color-surface, #f5f5f5);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        
        .attribute-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary, #999);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .attribute-value {
            font-weight: 500;
            color: var(--color-text, #333);
        }
        
        /* Admin Edit Button in Style Modal */
        .style-modal-info .admin-edit-btn {
            margin-top: 1.5rem;
        }
        
        /* Style Modal Actions */
        .style-modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .style-modal-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--color-border, #e5e5e5);
            background: white;
        }
        
        .style-modal-action-btn:hover {
            background: var(--color-surface-alt, #f5f5f5);
        }
        
        .style-modal-action-btn.favorite {
            color: #dc2626;
        }
        
        .style-modal-action-btn.favorite.active {
            background: #fee2e2;
            border-color: #fca5a5;
        }
        
        .style-modal-action-btn.primary {
            background: var(--color-text-primary, #3D3530);
            color: white;
            border-color: var(--color-text-primary, #3D3530);
        }
        
        .style-modal-action-btn.primary:hover {
            opacity: 0.9;
        }
        
        .style-modal-admin-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border, #e5e5e5);
        }
        
        .style-modal-action-btn.admin {
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .style-modal-action-btn.admin:hover {
            background: #fee2e2;
        }
        
        /* Lightbox for zoomed images */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
        }
        
        .lightbox-image {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            cursor: default;
        }
        
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            padding: 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .lightbox-nav:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .lightbox-prev {
            left: 1rem;
        }
        
        .lightbox-next {
            right: 1rem;
        }
        
        .lightbox-counter {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.875rem;
        }
        
        .lightbox-zoom-hint {
            position: absolute;
            bottom: -40px;
            right: 0;
            color: rgba(255,255,255,0.7);
            font-size: 0.75rem;
        }
        
        /* Zoomed state */
        .lightbox-image.zoomed {
            max-width: none;
            max-height: none;
            cursor: grab;
        }
        
        .lightbox-image.zoomed.dragging {
            cursor: grabbing;
        }
        
        /* Context Menu / Dropdown */
        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 3000;
            overflow: hidden;
        }
        
        .context-menu.active {
            display: block;
        }
        
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9375rem;
            color: var(--color-text, #333);
        }
        
        .context-menu-item:hover {
            background: var(--color-surface, #f5f5f5);
        }
        
        .context-menu-item svg {
            width: 20px;
            height: 20px;
            color: var(--color-text-secondary, #666);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--color-border, #e5e5e5);
            margin: 0.25rem 0;
        }
        
        .context-menu-item.danger {
            color: #dc3545;
        }
        
        .context-menu-item.danger svg {
            color: #dc3545;
        }
        
        /* Collection Modal */
        .collection-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .collection-modal.active {
            display: flex;
        }
        
        .collection-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .collection-modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--color-border, #e5e5e5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collection-modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
        }
        
        .collection-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-secondary, #666);
        }
        
        .collection-modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .collection-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .collection-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--color-border, #ddd);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .collection-item:hover {
            border-color: var(--color-accent, #C75B3F);
            background: rgba(199, 91, 63, 0.05);
        }
        
        .collection-item.selected {
            border-color: var(--color-accent, #C75B3F);
            background: rgba(199, 91, 63, 0.1);
        }
        
        .collection-item-icon {
            width: 40px;
            height: 40px;
            background: var(--color-surface, #f5f5f5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .collection-item-info {
            flex: 1;
        }
        
        .collection-item-name {
            font-weight: 500;
        }
        
        .collection-item-count {
            font-size: 0.75rem;
            color: var(--color-text-secondary, #999);
        }
        
        .create-collection-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border, #e5e5e5);
        }
        
        .create-collection-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border, #ddd);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .create-collection-btn {
            padding: 0.5rem 1rem;
            background: var(--color-accent, #C75B3F);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 4000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }
        
        .confirm-modal.active {
            display: flex;
        }
        
        .confirm-modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .confirm-modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .confirm-modal-title {
            margin: 0 0 0.5rem;
            font-size: 1.25rem;
        }
        
        .confirm-modal-text {
            color: var(--color-text-secondary, #666);
            margin-bottom: 1.5rem;
            font-size: 0.9375rem;
        }
        
        .confirm-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .confirm-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .confirm-btn-cancel {
            background: var(--color-surface, #f5f5f5);
            color: var(--color-text, #333);
        }
        
        .confirm-btn-cancel:hover {
            background: var(--color-border, #e5e5e5);
        }
        
        .confirm-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .confirm-btn-danger:hover {
            background: #c82333;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .filter-sidebar {
                display: none;
            }
            
            .styles-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .style-modal-gallery {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .lightbox-nav {
                padding: 0.5rem;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Unified Header - A++ Brand -->
    <header class="site-header">
        <div class="header-left">
            <button class="hamburger-btn" onclick="toggleNavSidebar()" aria-label="Open menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="index.html" class="logo">
                <img src="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Wordmark_Brown%401x.png" alt="Society Arts" class="logo-image">
            </a>
        </div>
        <div class="header-right">
            <button class="cart-btn" onclick="window.location.href='under-construction.html?feature=Shopping%20Cart'" aria-label="Cart">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
            </button>
            <a href="story-builder.html" class="new-project-btn">New Project</a>
            
            <!-- Auth Section -->
            <div class="header-auth" id="headerAuth">
                <!-- Sign In Button (shown when logged out) -->
                <button class="btn btn-secondary" id="signInBtn" onclick="openAuthModal()">
                    Log In
                </button>
                
                <!-- User Menu (shown when logged in) -->
                <div class="user-menu-container" id="userMenuContainer" style="display: none;">
                    <button class="user-avatar-btn" id="userAvatarBtn" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userInitials">U</span>
                        </div>
                        <span class="user-name" id="userName">User</span>
                        <svg class="user-menu-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="dropdownUserName">User</div>
                            <div class="user-dropdown-email" id="dropdownUserEmail">user@example.com</div>
                            <span class="user-dropdown-role" id="dropdownUserRole" style="display: none;">Admin</span>
                        </div>
                        <button class="user-dropdown-item" onclick="openProfileModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Profile
                        </button>
                        <button class="user-dropdown-item" id="adminUsersBtn" onclick="openAdminUsersModal()" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Manage Users
                        </button>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item logout" onclick="handleLogout()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation Sidebar Overlay -->
    <div class="nav-overlay" id="navOverlay" onclick="closeNavSidebar()"></div>
    
    <!-- Navigation Sidebar -->
    <nav class="nav-sidebar" id="navSidebar">
        <div class="nav-header">
            <img src="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Wordmark_Brown%401x.png" alt="Society Arts" class="nav-logo">
            <button class="nav-close-btn" onclick="closeNavSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="nav-content">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="story-builder.html" class="nav-link">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                        </span>
                        Story Builder
                    </a>
                </li>
                <li class="nav-item">
                    <a href="style-finder.html" class="nav-link active">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="13.5" cy="6.5" r="2"></circle>
                                <circle cx="17.5" cy="10.5" r="2"></circle>
                                <circle cx="8.5" cy="7.5" r="2"></circle>
                                <circle cx="6.5" cy="12.5" r="2"></circle>
                                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"></path>
                            </svg>
                        </span>
                        Style Finder
                    </a>
                </li>
                <li class="nav-divider"></li>
                <li class="nav-item">
                    <a href="projects.html" class="nav-link">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </span>
                        Your Work
                    </a>
                </li>
                <li class="nav-item">
                    <a href="favorites.html" class="nav-link">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </span>
                        Favorites
                    </a>
                </li>
                <li class="nav-divider"></li>
                <li class="nav-item">
                    <a href="under-construction.html?feature=Prints%20%26%20Pricing" class="nav-link">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </span>
                        Prints & Pricing
                    </a>
                </li>
                <li class="nav-item">
                    <a href="under-construction.html?feature=Help" class="nav-link">
                        <span class="nav-link-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </span>
                        Help
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Main Content -->
    <div class="style-finder-page">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar">
            <div id="activeFiltersDisplay" class="active-filters" style="display:none;"></div>
            
            <div class="filter-section">
                <h3>Search</h3>
                <input type="text" class="filter-select" id="sidebarSearch" placeholder="Search styles...">
            </div>
            
            <div class="filter-section">
                <h3>Art Type</h3>
                <select class="filter-select" id="filterArtType">
                    <option value="">All Art Types</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Medium</h3>
                <select class="filter-select" id="filterMedium">
                    <option value="">All Mediums</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Culture</h3>
                <select class="filter-select" id="filterCulture">
                    <option value="">All Cultures</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Era</h3>
                <select class="filter-select" id="filterEra">
                    <option value="">All Eras</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Palette</h3>
                <select class="filter-select" id="filterPalette">
                    <option value="">All Palettes</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Lighting</h3>
                <select class="filter-select" id="filterLighting">
                    <option value="">All Lighting</option>
                </select>
            </div>
            
            <div class="filter-section">
                <button class="clear-filters-btn" id="clearFiltersBtn">Clear All Filters</button>
            </div>
            
            <!-- Reset/Apply Buttons -->
            <div class="filter-actions">
                <button class="reset-btn" id="resetFiltersBtn">Reset</button>
                <button class="apply-btn" id="applyFiltersBtn">Apply</button>
            </div>
        </aside>
        
        <!-- Styles Grid -->
        <main class="styles-main">
            <!-- Sticky Header -->
            <div class="sticky-header">
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search styles... (try: photography black white)">
                        <button class="search-clear-btn" id="searchClearBtn" title="Clear search"></button>
                    </div>
                    <div class="sort-container">
                        <label for="sortSelect">Sort:</label>
                        <select class="sort-select" id="sortSelect">
                            <option value="quality">Quality: High to Low</option>
                            <option value="qualityAsc">Quality: Low to High</option>
                            <option value="newest">Newest Arrivals</option>
                            <option value="featured">Featured</option>
                            <option value="nameAsc">Name: A to Z</option>
                            <option value="nameDesc">Name: Z to A</option>
                        </select>
                    </div>
                    <div class="quality-filter-container">
                        <label for="qualityFilter">Min:</label>
                        <select class="quality-filter-select" id="qualityFilter">
                            <option value="0">All</option>
                            <option value="6">6+</option>
                            <option value="7">7+</option>
                            <option value="8">8+</option>
                            <option value="9">9+</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                
                <!-- Active Filter Pills -->
                <div class="filter-pills" id="filterPills">
                    <!-- Filter pills inserted dynamically -->
                </div>
                
                <div class="search-meta">
                    <span class="search-hint">Tip: Use multiple words to narrow results</span>
                    <span class="results-count" id="resultsCount">Loading...</span>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="styles-content">
                <div class="styles-grid" id="stylesGrid">
                    <!-- Styles will be inserted here -->
                </div>
                
                <div class="pagination" id="pagination">
                    <button class="pagination-btn" id="prevPageBtn" disabled> Previous</button>
                    <span class="pagination-info" id="paginationInfo">Page 1 of 1</span>
                    <button class="pagination-btn" id="nextPageBtn">Next </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Multi-select Action Bar -->
    <div class="multi-select-bar" id="multiSelectBar">
        <span class="multi-select-count"><span id="selectedCount">0</span> selected</span>
        <button onclick="bulkFavorite()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            Favorite
        </button>
        <button onclick="bulkAddToProject()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
            </svg>
            Add to Project
        </button>
        <button onclick="bulkUnlist()" id="bulkUnlistBtn" style="display: none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
            </svg>
            Unlist
        </button>
        <button class="cancel-btn" onclick="clearSelection()"> Cancel</button>
    </div>
    
    <!-- Style Detail Modal -->
    <div class="style-modal" id="styleModal">
        <div class="style-modal-content">
            <button class="style-modal-close" id="styleModalClose"></button>
            <div class="style-modal-gallery" id="styleModalGallery">
                <!-- Images inserted here -->
            </div>
            <div class="style-modal-info">
                <div class="style-modal-id" id="styleModalId"></div>
                <h2 class="style-modal-name" id="styleModalName"></h2>
                <div class="style-modal-tagline" id="styleModalTagline"></div>
                
                <!-- Action Buttons -->
                <div class="style-modal-actions" id="styleModalActions">
                    <button class="style-modal-action-btn favorite" id="styleModalFavoriteBtn" onclick="toggleStyleFavorite()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span id="styleModalFavoriteBtnText">Favorite</span>
                    </button>
                    <button class="style-modal-action-btn primary" onclick="addStyleToProject()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add to Project
                    </button>
                </div>
                
                <p class="style-modal-description" id="styleModalDescription"></p>
                <div class="style-modal-tags" id="styleModalTags"></div>
                <div class="style-modal-attributes" id="styleModalAttributes">
                    <!-- Attributes inserted here -->
                </div>
                
                <!-- Admin Actions (shown only for super admins) -->
                <div class="style-modal-admin-actions" id="styleModalAdminActions" style="display: none;">
                    <button class="style-modal-action-btn" id="adminEditStyleBtn" onclick="openEditStyleModal(currentModalStyleId)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Edit Style
                    </button>
                    <button class="style-modal-action-btn admin" onclick="flagStyleForReview()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" y1="22" x2="4" y2="15"></line>
                        </svg>
                        Flag for Review
                    </button>
                    <button class="style-modal-action-btn admin" onclick="unlistStyle()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                        </svg>
                        Unlist Style
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lightbox for zoomed images -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="lightboxClose"></button>
            <button class="lightbox-nav lightbox-prev" id="lightboxPrev"></button>
            <img class="lightbox-image" id="lightboxImage" src="" alt="Zoomed style image">
            <button class="lightbox-nav lightbox-next" id="lightboxNext"></button>
            <div class="lightbox-counter" id="lightboxCounter">1 / 10</div>
            <div class="lightbox-zoom-hint">Click image to zoom in/out</div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" id="menuSave">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save
        </button>
        <button class="context-menu-item" id="menuAddToCollection">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            Add to Collection
        </button>
        <div class="context-menu-divider"></div>
        <button class="context-menu-item" id="menuReportSwap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Flag for Review
        </button>
        <button class="context-menu-item danger" id="menuReportDelete">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Unlist Style
        </button>
    </div>
    
    <!-- Collection Modal -->
    <div class="collection-modal" id="collectionModal">
        <div class="collection-modal-content">
            <div class="collection-modal-header">
                <h3>Add to Collection</h3>
                <button class="collection-modal-close" id="collectionModalClose"></button>
            </div>
            <div class="collection-modal-body">
                <div class="collection-list" id="collectionList">
                    <!-- Collections inserted here -->
                </div>
                <div class="create-collection-form">
                    <input type="text" class="create-collection-input" id="newCollectionName" placeholder="New collection name...">
                    <button class="create-collection-btn" id="createCollectionBtn">Create</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-icon"></div>
            <h3 class="confirm-modal-title">Unlist This Style?</h3>
            <p class="confirm-modal-text">This will remove the style from the public gallery. It can be restored later by an admin.</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-btn confirm-btn-cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-btn confirm-btn-danger" id="confirmUnlist">Yes, Unlist</button>
            </div>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- AUTH MODAL -->
    <!-- ============================================ -->
    <div class="auth-modal-overlay" id="authModalOverlay">
        <div class="auth-modal" id="authModal">
            <button class="auth-modal-close" onclick="closeAuthModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <!-- Welcome View (Default) -->
            <div class="auth-view" id="authViewWelcome">
                <div class="auth-header">
                    <h1 class="auth-title">Welcome</h1>
                    <p class="auth-subtitle">Start exploring and creating  sign in to never lose your results.</p>
                </div>
                
                <div class="auth-social-buttons">
                    <!-- Google -->
                    <button class="auth-social-btn" onclick="signInWithGoogle()">
                        <span class="auth-social-icon google">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                        </span>
                        Continue with Google
                    </button>
                    
                    <!-- Apple (Coming Soon) -->
                    <button class="auth-social-btn disabled" onclick="showUnderConstruction('Apple')">
                        <span class="auth-social-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                            </svg>
                        </span>
                        Continue with Apple
                    </button>
                    
                    <!-- Facebook (Coming Soon) -->
                    <button class="auth-social-btn disabled" onclick="showUnderConstruction('Facebook')">
                        <span class="auth-social-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#1877F2">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </span>
                        Continue with Facebook
                    </button>
                </div>
                
                <div class="auth-divider">
                    <span class="auth-divider-line"></span>
                    <span class="auth-divider-text">or</span>
                    <span class="auth-divider-line"></span>
                </div>
                
                <form class="auth-form" onsubmit="handleEmailSubmit(event)">
                    <div class="auth-input-group">
                        <input type="email" class="auth-input" id="authEmailInput" placeholder="Email address" required>
                    </div>
                    <button type="submit" class="auth-submit-btn" id="authEmailBtn">Continue with Email</button>
                </form>
                
                <div class="auth-footer">
                    Already have an account? <span class="auth-footer-link" onclick="showAuthView('signin')">Sign In</span>
                </div>
            </div>
            
            <!-- Sign In View -->
            <div class="auth-view" id="authViewSignin" style="display: none;">
                <div class="auth-header">
                    <h1 class="auth-title">Welcome Back</h1>
                    <p class="auth-subtitle">Sign in to your account</p>
                </div>
                
                <div class="auth-social-buttons">
                    <!-- Google -->
                    <button class="auth-social-btn" onclick="signInWithGoogle()">
                        <span class="auth-social-icon google">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                        </span>
                        Continue with Google
                    </button>
                    
                    <!-- Apple (Coming Soon) -->
                    <button class="auth-social-btn disabled" onclick="showUnderConstruction('Apple')">
                        <span class="auth-social-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                            </svg>
                        </span>
                        Continue with Apple
                    </button>
                    
                    <!-- Facebook (Coming Soon) -->
                    <button class="auth-social-btn disabled" onclick="showUnderConstruction('Facebook')">
                        <span class="auth-social-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#1877F2">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </span>
                        Continue with Facebook
                    </button>
                </div>
                
                <div class="auth-divider">
                    <span class="auth-divider-line"></span>
                    <span class="auth-divider-text">or</span>
                    <span class="auth-divider-line"></span>
                </div>
                
                <div id="authSigninMessage"></div>
                
                <form class="auth-form" onsubmit="handleSignIn(event)">
                    <div class="auth-input-group">
                        <label class="auth-input-label">Email</label>
                        <input type="email" class="auth-input" id="signinEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-input-label">Password</label>
                        <div class="auth-password-wrapper">
                            <input type="password" class="auth-input" id="signinPassword" placeholder="Enter your password" required>
                            <button type="button" class="auth-password-toggle" onclick="togglePasswordVisibility('signinPassword')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="auth-forgot-link">
                        <a onclick="showAuthView('forgot')">Forgot password?</a>
                    </div>
                    <button type="submit" class="auth-submit-btn" id="signinBtn">Sign In</button>
                </form>
                
                <div class="auth-footer">
                    Don't have an account? <span class="auth-footer-link" onclick="showAuthView('welcome')">Sign Up</span>
                </div>
            </div>
            
            <!-- Sign Up View -->
            <div class="auth-view" id="authViewSignup" style="display: none;">
                <span class="auth-back-link" onclick="showAuthView('welcome')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </span>
                
                <div class="auth-header">
                    <h1 class="auth-title">Create Account</h1>
                    <p class="auth-subtitle">Join Society Arts today</p>
                </div>
                
                <div id="authSignupMessage"></div>
                
                <form class="auth-form" onsubmit="handleSignUp(event)">
                    <div class="auth-input-group">
                        <label class="auth-input-label">Display Name</label>
                        <input type="text" class="auth-input" id="signupName" placeholder="Enter your name" required>
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-input-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-input-label">Password</label>
                        <div class="auth-password-wrapper">
                            <input type="password" class="auth-input" id="signupPassword" placeholder="Create a password (min. 8 characters)" required minlength="8">
                            <button type="button" class="auth-password-toggle" onclick="togglePasswordVisibility('signupPassword')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-input-label">Confirm Password</label>
                        <div class="auth-password-wrapper">
                            <input type="password" class="auth-input" id="signupPasswordConfirm" placeholder="Confirm your password" required>
                            <button type="button" class="auth-password-toggle" onclick="togglePasswordVisibility('signupPasswordConfirm')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="auth-submit-btn" id="signupBtn">Create Account</button>
                </form>
                
                <p class="auth-terms">
                    By creating an account, you agree to our <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a>.
                </p>
                
                <div class="auth-footer">
                    Already have an account? <span class="auth-footer-link" onclick="showAuthView('signin')">Sign In</span>
                </div>
            </div>
            
            <!-- Forgot Password View -->
            <div class="auth-view" id="authViewForgot" style="display: none;">
                <span class="auth-back-link" onclick="showAuthView('signin')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </span>
                
                <div class="auth-header">
                    <h1 class="auth-title">Reset Password</h1>
                    <p class="auth-subtitle">Enter your email and we'll send you a link to reset your password.</p>
                </div>
                
                <div id="authForgotMessage"></div>
                
                <form class="auth-form" onsubmit="handleForgotPassword(event)">
                    <div class="auth-input-group">
                        <label class="auth-input-label">Email</label>
                        <input type="email" class="auth-input" id="forgotEmail" placeholder="Enter your email" required>
                    </div>
                    <button type="submit" class="auth-submit-btn" id="forgotBtn">Send Reset Link</button>
                </form>
                
                <div class="auth-footer">
                    Remember your password? <span class="auth-footer-link" onclick="showAuthView('signin')">Sign In</span>
                </div>
            </div>
            
            <!-- Under Construction View -->
            <div class="auth-view" id="authViewConstruction" style="display: none;">
                <span class="auth-back-link" onclick="showAuthView('welcome')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </span>
                
                <div class="under-construction">
                    <div class="under-construction-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <h2 id="constructionTitle">Coming Soon</h2>
                    <p id="constructionText">This login option is coming soon. Please use Google or email sign-in for now.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- PROFILE MODAL -->
    <!-- ============================================ -->
    <div class="auth-modal-overlay" id="profileModalOverlay">
        <div class="auth-modal profile-modal" id="profileModal">
            <button class="auth-modal-close" onclick="closeProfileModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="profile-header">
                <div class="profile-avatar-section">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="profileInitials">U</span>
                    </div>
                    <label class="profile-avatar-edit" for="avatarUpload">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </label>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                </div>
                <div class="profile-info">
                    <h2 id="profileName">User Name</h2>
                    <p id="profileEmail">user@example.com</p>
                    <span class="profile-role-badge" id="profileRole" style="display: none;">Admin</span>
                </div>
            </div>
            
            <div class="profile-section">
                <h3 class="profile-section-title">Account Information</h3>
                <div class="profile-field">
                    <span class="profile-field-label">Display Name</span>
                    <div class="profile-field-value">
                        <span class="profile-field-text" id="profileDisplayName">User</span>
                        <span class="profile-field-edit" onclick="editProfileField('displayName')">Edit</span>
                    </div>
                </div>
                <div class="profile-field">
                    <span class="profile-field-label">Email</span>
                    <div class="profile-field-value">
                        <span class="profile-field-text" id="profileEmailField">user@example.com</span>
                    </div>
                </div>
                <div class="profile-field">
                    <span class="profile-field-label">Password</span>
                    <div class="profile-field-value">
                        <span class="profile-field-text"></span>
                        <span class="profile-field-edit" onclick="editProfileField('password')">Change</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section" id="profileAdminSection" style="display: none;">
                <h3 class="profile-section-title">Admin Settings</h3>
                <div class="profile-field">
                    <span class="profile-field-label">Role</span>
                    <div class="profile-field-value">
                        <span class="profile-field-text" id="profileRoleText">Admin</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- EDIT STYLE MODAL (Admin Only) -->
    <!-- ============================================ -->
    <div class="auth-modal-overlay" id="editStyleModalOverlay">
        <div class="auth-modal edit-style-modal" id="editStyleModal">
            <button class="auth-modal-close" onclick="closeEditStyleModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="edit-style-header">
                <div class="edit-style-thumbnail" id="editStyleThumbnail">
                    <img src="" alt="Style thumbnail">
                </div>
                <div class="edit-style-meta">
                    <h3>Edit Style</h3>
                    <span class="edit-style-id" id="editStyleId">ABC-123</span>
                    <p class="edit-style-id-note">Style ID cannot be changed</p>
                </div>
            </div>
            
            <form class="auth-form" id="editStyleForm" onsubmit="handleSaveStyle(event)">
                <div class="edit-form-section">
                    <h4 class="edit-form-section-title">Basic Information</h4>
                    
                    <div class="edit-form-group">
                        <label class="edit-form-label">Style Name</label>
                        <input type="text" class="edit-form-input" id="editStyleName" placeholder="Enter style name" required>
                    </div>
                    
                    <div class="edit-form-group">
                        <label class="edit-form-label">Tagline</label>
                        <input type="text" class="edit-form-input" id="editStyleTagline" placeholder="Short description">
                    </div>
                    
                    <div class="edit-form-group">
                        <label class="edit-form-label">Description</label>
                        <textarea class="edit-form-input edit-form-textarea" id="editStyleDescription" placeholder="Full description"></textarea>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4 class="edit-form-section-title">Categories</h4>
                    
                    <div class="edit-category-grid">
                        <div class="edit-form-group">
                            <label class="edit-form-label">Art Type</label>
                            <select class="edit-form-select" id="editStyleArtType">
                                <option value="">Select art type...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Medium</label>
                            <select class="edit-form-select" id="editStyleMedium">
                                <option value="">Select medium...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Era</label>
                            <select class="edit-form-select" id="editStyleEra">
                                <option value="">Select era...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Culture</label>
                            <select class="edit-form-select" id="editStyleCulture">
                                <option value="">Select culture...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Palette</label>
                            <select class="edit-form-select" id="editStylePalette">
                                <option value="">Select palette...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Lighting</label>
                            <select class="edit-form-select" id="editStyleLighting">
                                <option value="">Select lighting...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Composition</label>
                            <select class="edit-form-select" id="editStyleComposition">
                                <option value="">Select composition...</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label class="edit-form-label">Complexity</label>
                            <select class="edit-form-select" id="editStyleComplexity">
                                <option value="">Select complexity...</option>
                                <option value="1">1 - Simple</option>
                                <option value="2">2 - Low</option>
                                <option value="3">3 - Medium</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Complex</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4 class="edit-form-section-title">Visibility</h4>
                    <div class="edit-form-group">
                        <label class="checkbox-wrapper">
                            <div class="checkbox" id="editStyleFeaturedCheckbox">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <span class="checkbox-label">Featured Style</span>
                        </label>
                    </div>
                    <div class="edit-form-group">
                        <label class="checkbox-wrapper">
                            <div class="checkbox" id="editStyleNewCheckbox">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <span class="checkbox-label">Mark as New</span>
                        </label>
                    </div>
                </div>
                
                <div class="edit-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditStyleModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveStyleBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/shared/supabase-client.js"></script>
    <script src="js/shared/auth.js"></script>
    <script src="js/shared/projects.js"></script>
    <script src="js/style-finder/style-data.js"></script>
    <script>
        // ============================================
        // DOM Elements
        // ============================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stylesGrid = document.getElementById('stylesGrid');
        const searchInput = document.getElementById('searchInput');
        const searchClearBtn = document.getElementById('searchClearBtn');
        const sidebarSearch = document.getElementById('sidebarSearch');
        const resultsCount = document.getElementById('resultsCount');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const filterPills = document.getElementById('filterPills');
        const styleModal = document.getElementById('styleModal');
        const styleModalClose = document.getElementById('styleModalClose');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxCounter = document.getElementById('lightboxCounter');
        const contextMenu = document.getElementById('contextMenu');
        const collectionModal = document.getElementById('collectionModal');
        const toast = document.getElementById('toast');
        const activeFiltersDisplay = document.getElementById('activeFiltersDisplay');
        const sortSelect = document.getElementById('sortSelect');
        const qualityFilter = document.getElementById('qualityFilter');
        const confirmModal = document.getElementById('confirmModal');
        
        // Note: toggleNavSidebar, closeNavSidebar are provided by header.js
        
        // Filter elements mapped to database columns
        const filterSelects = {
            art_type_id: document.getElementById('filterArtType'),
            primary_medium_id: document.getElementById('filterMedium'),
            culture_id: document.getElementById('filterCulture'),
            era_id: document.getElementById('filterEra'),
            primary_palette_id: document.getElementById('filterPalette'),
            primary_lighting_id: document.getElementById('filterLighting')
        };
        
        // Lookup table mapping for smart facets
        const filterConfig = {
            art_type_id: { lookup: 'art_types', label: 'Art Type' },
            primary_medium_id: { lookup: 'mediums', label: 'Medium' },
            culture_id: { lookup: 'cultures', label: 'Culture' },
            era_id: { lookup: 'eras', label: 'Era' },
            primary_palette_id: { lookup: 'palettes', label: 'Palette' },
            primary_lighting_id: { lookup: 'lighting', label: 'Lighting' }
        };
        
        // State for lightbox
        let lightboxImages = [];
        let lightboxIndex = 0;
        let isZoomed = false;
        
        // State for context menu
        let currentMenuStyleId = null;
        let currentMenuImageUrl = null;
        
        // ============================================
        // Initialize
        // ============================================
        async function initialize() {
            showLoading(true);
            
            try {
                await SocietyArts.initializeStyleData();
                populateFilterDropdowns();
                renderStyles();
                updateResultsCount();
                updatePagination();
            } catch (error) {
                console.error('Initialization failed:', error);
                stylesGrid.innerHTML = '<p style="text-align:center;color:#999;padding:2rem;">Failed to load styles. Please refresh the page.</p>';
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // UI Functions
        // ============================================
        function showLoading(show) {
            loadingOverlay.classList.toggle('active', show);
        }
        
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), duration);
        }
        
        // Populate dropdowns with counts (smart facets)
        function populateFilterDropdowns() {
            // Get actual filtered count (not sum of options)
            const totalFilteredStyles = SocietyArts.filteredStyles().length;
            
            Object.entries(filterSelects).forEach(([filterKey, selectEl]) => {
                if (filterKey === 'complexity') return; // Skip complexity
                
                const config = filterConfig[filterKey];
                if (!config) return;
                
                // Get options with counts
                const options = SocietyArts.getLookupOptionsWithCounts(config.lookup, filterKey);
                
                // Save current selection
                const currentValue = selectEl.value;
                
                // Clear and rebuild - show actual filtered count, not sum of options
                selectEl.innerHTML = `<option value="">All ${config.label}s (${totalFilteredStyles})</option>`;
                
                // Add options that have results, with counts
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = `${opt.name} (${opt.count})`;
                    selectEl.appendChild(option);
                });
                
                // Restore selection if still valid
                if (currentValue && [...selectEl.options].some(o => o.value === currentValue)) {
                    selectEl.value = currentValue;
                }
                
                console.log(`Populated ${filterKey} with ${options.length} options (with counts)`);
            });
        }
        
        function updateActiveFiltersDisplay() {
            const activeFilters = [];
            Object.entries(filterSelects).forEach(([key, el]) => {
                if (el.value) {
                    const selectedOption = el.options[el.selectedIndex];
                    activeFilters.push(selectedOption.textContent.split(' (')[0]); // Remove count
                }
            });
            
            if (activeFilters.length > 0) {
                activeFiltersDisplay.style.display = 'block';
                activeFiltersDisplay.textContent = `Active: ${activeFilters.join(', ')}`;
            } else {
                activeFiltersDisplay.style.display = 'none';
            }
        }
        
        function renderStyles() {
            const styles = SocietyArts.getCurrentPageStyles();
            
            if (styles.length === 0) {
                stylesGrid.innerHTML = '<p style="text-align:center;color:#999;padding:2rem;grid-column:1/-1;">No styles found matching your criteria.</p>';
                return;
            }
            
            stylesGrid.innerHTML = styles.map(style => `
                <div class="style-card" data-style-id="${style.id}">
                    <div class="style-card-image">
                        <img src="${style.thumbnail}" alt="${style.name}" 
                             onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>Image not available</div>'">
                        <button class="select-checkbox" 
                                onclick="event.stopPropagation(); toggleStyleSelection('${style.id}')"
                                title="Select for bulk action">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                        <button class="favorite-btn ${isStyleFavorited(style.id) ? 'active' : ''}" 
                                onclick="event.stopPropagation(); toggleFavorite('${style.id}', this)"
                                title="Add to favorites">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                        <button class="menu-btn-horizontal" 
                                onclick="event.stopPropagation(); openContextMenu(event, '${style.id}', '${style.thumbnail}')"
                                title="More options">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </button>
                    </div>
                    <div class="style-card-info">
                        <h3 class="style-card-name">${style.name || 'Untitled Style'}</h3>
                        ${style.tagline ? `<div class="style-card-tagline">${style.tagline}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.style-card').forEach(card => {
                card.addEventListener('click', () => openStyleModal(card.dataset.styleId));
            });
        }
        
        function updateResultsCount() {
            const total = SocietyArts.filteredStyles().length;
            resultsCount.textContent = `${total.toLocaleString()} style${total !== 1 ? 's' : ''}`;
        }
        
        function updatePagination() {
            const currentPage = SocietyArts.currentPage();
            const totalPages = SocietyArts.getTotalPages();
            
            prevPageBtn.disabled = currentPage === 0;
            nextPageBtn.disabled = currentPage >= totalPages - 1;
            paginationInfo.textContent = `Page ${currentPage + 1} of ${Math.max(1, totalPages)}`;
        }
        
        // ============================================
        // Search & Filter Handlers
        // ============================================
        let searchTimeout;
        async function handleSearch(value) {
            // Show/hide clear button
            searchClearBtn.classList.toggle('visible', value.length > 0);
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                showLoading(true);
                await SocietyArts.searchStyles(value);
                renderStyles();
                updateResultsCount();
                updatePagination();
                updateFilterPills();
                showLoading(false);
            }, 300);
        }
        
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        
        // Search clear button
        searchClearBtn.addEventListener('click', async () => {
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            showLoading(true);
            await SocietyArts.searchStyles('');
            renderStyles();
            updateResultsCount();
            updatePagination();
            updateFilterPills();
            showLoading(false);
        });
        
        sidebarSearch.addEventListener('input', (e) => {
            searchInput.value = e.target.value;
            handleSearch(e.target.value);
        });
        
        // Filter change handler - instant apply
        Object.entries(filterSelects).forEach(([filterKey, selectEl]) => {
            selectEl.addEventListener('change', async () => {
                console.log(`Filter changed: ${filterKey} = "${selectEl.value}"`);
                
                showLoading(true);
                
                const filters = {};
                Object.entries(filterSelects).forEach(([key, el]) => {
                    if (el.value) {
                        if (key === 'complexity') {
                            filters[key] = parseInt(el.value);
                        } else {
                            filters[key] = el.value;
                        }
                    }
                });
                
                console.log('Applying filters:', filters);
                
                await SocietyArts.applyFilters(filters);
                
                // Refresh dropdowns with new counts (smart facets)
                populateFilterDropdowns();
                
                renderStyles();
                updateResultsCount();
                updatePagination();
                updateActiveFiltersDisplay();
                updateFilterPills();
                
                showLoading(false);
            });
        });
        
        // Clear all filters (sidebar button)
        clearFiltersBtn.addEventListener('click', async () => {
            await resetAllFilters();
        });
        
        // Reset button (sticky footer)
        resetFiltersBtn.addEventListener('click', async () => {
            await resetAllFilters();
        });
        
        // Apply button (currently instant-apply, but kept for UX consistency)
        applyFiltersBtn.addEventListener('click', () => {
            showToast('Filters applied!', 1500);
        });
        
        async function resetAllFilters() {
            showLoading(true);
            Object.values(filterSelects).forEach(el => el.value = '');
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            if (sidebarSearch) sidebarSearch.value = '';
            qualityFilter.value = '0';
            await SocietyArts.setQualityThreshold(0);
            await SocietyArts.clearFilters();
            populateFilterDropdowns();
            renderStyles();
            updateResultsCount();
            updatePagination();
            updateActiveFiltersDisplay();
            updateFilterPills();
            showLoading(false);
        }
        
        // Update filter pills display
        function updateFilterPills() {
            const pills = [];
            const lookups = SocietyArts.getLookups();
            
            // Add search term pill
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                pills.push(`<span class="filter-pill">
                    Search: "${searchTerm}"
                    <button class="filter-pill-remove" data-action="clear-search"></button>
                </span>`);
            }
            
            // Add filter pills
            Object.entries(filterSelects).forEach(([filterKey, selectEl]) => {
                if (selectEl.value) {
                    const config = filterConfig[filterKey];
                    let displayValue = selectEl.value;
                    
                    if (config && lookups[config.lookup]) {
                        const item = lookups[config.lookup].find(l => l.id === selectEl.value);
                        if (item) displayValue = item.name;
                    } else if (filterKey === 'complexity') {
                        displayValue = selectEl.options[selectEl.selectedIndex].text;
                    }
                    
                    const label = config?.label || filterKey;
                    pills.push(`<span class="filter-pill">
                        ${label}: ${displayValue}
                        <button class="filter-pill-remove" data-filter="${filterKey}"></button>
                    </span>`);
                }
            });
            
            // Add quality filter pill
            const qualityValue = parseInt(qualityFilter.value);
            if (qualityValue > 0) {
                pills.push(`<span class="filter-pill">
                    Quality: ${qualityValue}+
                    <button class="filter-pill-remove" data-action="clear-quality"></button>
                </span>`);
            }
            
            // Add reset all button if there are any filters
            if (pills.length > 0) {
                pills.push(`<button class="reset-all-btn" id="resetAllPillsBtn">Reset All</button>`);
            }
            
            filterPills.innerHTML = pills.join('');
            
            // Add event listeners to pill remove buttons
            filterPills.querySelectorAll('.filter-pill-remove').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const filterKey = btn.dataset.filter;
                    const action = btn.dataset.action;
                    
                    if (action === 'clear-search') {
                        searchInput.value = '';
                        searchClearBtn.classList.remove('visible');
                        showLoading(true);
                        await SocietyArts.searchStyles('');
                    } else if (action === 'clear-quality') {
                        qualityFilter.value = '0';
                        showLoading(true);
                        await SocietyArts.setQualityThreshold(0);
                    } else if (filterKey) {
                        filterSelects[filterKey].value = '';
                        showLoading(true);
                        const filters = {};
                        Object.entries(filterSelects).forEach(([key, el]) => {
                            if (el.value) filters[key] = el.value;
                        });
                        await SocietyArts.applyFilters(filters);
                        populateFilterDropdowns();
                    }
                    
                    renderStyles();
                    updateResultsCount();
                    updatePagination();
                    updateActiveFiltersDisplay();
                    updateFilterPills();
                    showLoading(false);
                });
            });
            
            // Reset all button
            const resetAllBtn = filterPills.querySelector('#resetAllPillsBtn');
            if (resetAllBtn) {
                resetAllBtn.addEventListener('click', () => resetAllFilters());
            }
        }
        
        // Sort handler
        sortSelect.addEventListener('change', async () => {
            showLoading(true);
            await SocietyArts.setSort(sortSelect.value);
            renderStyles();
            updatePagination();
            showLoading(false);
        });
        
        // Quality filter handler
        qualityFilter.addEventListener('change', async () => {
            showLoading(true);
            await SocietyArts.setQualityThreshold(parseInt(qualityFilter.value));
            populateFilterDropdowns();
            renderStyles();
            updateResultsCount();
            updatePagination();
            showLoading(false);
        });
        
        // ============================================
        // Pagination
        // ============================================
        prevPageBtn.addEventListener('click', () => {
            SocietyArts.prevPage();
            renderStyles();
            updatePagination();
            document.querySelector('.styles-main').scrollTo(0, 0);
        });
        
        nextPageBtn.addEventListener('click', () => {
            SocietyArts.nextPage();
            renderStyles();
            updatePagination();
            document.querySelector('.styles-main').scrollTo(0, 0);
        });
        
        // ============================================
        // Multi-Select Functionality
        // ============================================
        let selectedStyles = new Set();
        const multiSelectBar = document.getElementById('multiSelectBar');
        const selectedCountEl = document.getElementById('selectedCount');
        const bulkUnlistBtn = document.getElementById('bulkUnlistBtn');
        
        function toggleStyleSelection(styleId) {
            const card = document.querySelector(`.style-card[data-style-id="${styleId}"]`);
            
            if (selectedStyles.has(styleId)) {
                selectedStyles.delete(styleId);
                card?.classList.remove('selected');
            } else {
                selectedStyles.add(styleId);
                card?.classList.add('selected');
            }
            
            updateMultiSelectBar();
        }
        
        function updateMultiSelectBar() {
            const count = selectedStyles.size;
            selectedCountEl.textContent = count;
            
            if (count > 0) {
                multiSelectBar.classList.add('visible');
                document.body.classList.add('multi-select-active');
                
                // Show unlist button only for admins
                const isAdmin = currentUser?.user_metadata?.role === 'admin' || 
                               currentProfile?.role === 'admin' || 
                               currentProfile?.role === 'super_admin';
                bulkUnlistBtn.style.display = isAdmin ? 'flex' : 'none';
            } else {
                multiSelectBar.classList.remove('visible');
                document.body.classList.remove('multi-select-active');
            }
        }
        
        function clearSelection() {
            selectedStyles.forEach(styleId => {
                const card = document.querySelector(`.style-card[data-style-id="${styleId}"]`);
                card?.classList.remove('selected');
            });
            selectedStyles.clear();
            updateMultiSelectBar();
        }
        
        async function bulkFavorite() {
            if (!currentUser) {
                showToast('Please sign in to favorite styles');
                openAuthModal();
                return;
            }
            
            const { supabase } = window.SocietyArts;
            const styleIds = Array.from(selectedStyles);
            let added = 0;
            
            for (const styleId of styleIds) {
                try {
                    // Check if already favorited using local function
                    if (!isStyleFavorited(styleId)) {
                        // Get style name and add to favorites
                        const style = await SocietyArts.getStyleById(styleId);
                        const styleName = style?.name || null;
                        
                        const { error } = await supabase
                            .from('user_favorites')
                            .insert({
                                user_id: currentUser.id,
                                style_id: styleId,
                                style_name: styleName
                            });
                        
                        if (error && error.code !== '23505') {
                            throw error;
                        }
                        
                        localFavorites.unshift({
                            style_id: styleId,
                            style_name: styleName,
                            created_at: new Date().toISOString()
                        });
                        added++;
                        
                        // Update button state
                        const btn = document.querySelector(`.style-card[data-style-id="${styleId}"] .favorite-btn`);
                        btn?.classList.add('active');
                    }
                } catch (error) {
                    console.error(`Failed to add favorite ${styleId}:`, error);
                }
            }
            
            showToast(`Added ${added} style${added !== 1 ? 's' : ''} to favorites`);
            clearSelection();
        }
        
        function bulkAddToProject() {
            if (!currentUser) {
                showToast('Please sign in to add to project');
                return;
            }
            
            const styleIds = Array.from(selectedStyles);
            
            // Store in session storage and redirect to story builder
            sessionStorage.setItem('pendingStyles', JSON.stringify(styleIds));
            window.location.href = 'story-builder.html?addStyles=pending';
        }
        
        async function bulkUnlist() {
            if (!currentUser) {
                showToast('Please sign in');
                return;
            }
            
            const styleIds = Array.from(selectedStyles);
            const confirmed = confirm(`Unlist ${styleIds.length} styles? They will no longer appear in search results.`);
            
            if (!confirmed) return;
            
            try {
                const { error } = await supabase
                    .from('styles')
                    .update({ status: 'unlisted' })
                    .in('id', styleIds);
                
                if (error) throw error;
                
                showToast(`${styleIds.length} styles unlisted`);
                clearSelection();
                SocietyArts.loadStyles().then(() => {
                    renderStyles();
                    updateResultsCount();
                });
            } catch (err) {
                showToast('Error unlisting styles');
                console.error(err);
            }
        }
        
        // ============================================
        // Favorites (Database-backed)
        // ============================================
        
        // Local favorites cache for style-finder
        let localFavorites = [];
        
        // Load user's favorites on auth
        async function loadUserFavoritesLocal() {
            if (!currentUser) {
                localFavorites = [];
                return [];
            }
            
            const { supabase } = window.SocietyArts;
            try {
                const { data, error } = await supabase
                    .from('user_favorites')
                    .select('style_id, style_name, created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                localFavorites = data || [];
                console.log(`Loaded ${localFavorites.length} favorites for user`);
                return localFavorites;
            } catch (error) {
                console.error('Failed to load favorites:', error);
                return [];
            }
        }
        
        // Check if a style is favorited
        function isStyleFavorited(styleId) {
            return localFavorites.some(f => f.style_id === styleId);
        }
        
        // Toggle favorite on a style
        async function toggleFavorite(styleId, btn) {
            // Check if user is logged in
            if (!currentUser) {
                showToast('Please sign in to save favorites');
                openAuthModal();
                return;
            }
            
            const { supabase } = window.SocietyArts;
            
            try {
                if (isStyleFavorited(styleId)) {
                    // Remove from favorites
                    const { error } = await supabase
                        .from('user_favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('style_id', styleId);
                    
                    if (error) throw error;
                    
                    localFavorites = localFavorites.filter(f => f.style_id !== styleId);
                    btn.classList.remove('active');
                    showToast('Removed from favorites');
                } else {
                    // Add to favorites - get style name first
                    const style = await SocietyArts.getStyleById(styleId);
                    const styleName = style?.name || null;
                    
                    const { error } = await supabase
                        .from('user_favorites')
                        .insert({
                            user_id: currentUser.id,
                            style_id: styleId,
                            style_name: styleName
                        });
                    
                    if (error) {
                        // Ignore duplicate key error
                        if (error.code !== '23505') {
                            throw error;
                        }
                    }
                    
                    localFavorites.unshift({
                        style_id: styleId,
                        style_name: styleName,
                        created_at: new Date().toISOString()
                    });
                    btn.classList.add('active');
                    showToast('Added to favorites');
                }
            } catch (error) {
                console.error('Failed to toggle favorite:', error);
                showToast('Failed to update favorites');
            }
        }
        
        // ============================================
        // Style Modal - Now shows all related attributes
        // ============================================
        async function openStyleModal(styleId) {
            showLoading(true);
            const style = await SocietyArts.getStyleById(styleId);
            showLoading(false);
            
            if (!style) return;
            
            lightboxImages = style.images;
            
            const galleryHtml = style.images.map((url, i) => 
                `<img src="${url}" alt="${style.name} - Image ${i + 1}" 
                      onclick="openLightbox(${i})"
                      onerror="this.style.display='none'">`
            ).join('');
            document.getElementById('styleModalGallery').innerHTML = galleryHtml;
            
            document.getElementById('styleModalId').textContent = style.id;
            document.getElementById('styleModalName').textContent = style.name || 'Untitled Style';
            document.getElementById('styleModalTagline').textContent = style.tagline || '';
            document.getElementById('styleModalDescription').textContent = style.description || 'No description available.';
            
            // Show tags from junction tables
            const allTags = [
                ...(style.artTypes || []),
                ...(style.mediums || []),
                ...(style.cultures || []),
                ...(style.eras || []),
                ...(style.palettes || []),
                ...(style.lighting || []),
                ...(style.compositions || [])
            ];
            
            document.getElementById('styleModalTags').innerHTML = allTags.length > 0 
                ? allTags.map(tag => `<span class="style-tag">${tag}</span>`).join('')
                : '';
            
            const attributes = [
                ['Art Types', style.artTypes?.join(', ')],
                ['Mediums', style.mediums?.join(', ')],
                ['Cultures', style.cultures?.join(', ')],
                ['Eras', style.eras?.join(', ')],
                ['Palettes', style.palettes?.join(', ')],
                ['Lighting', style.lighting?.join(', ')],
                ['Compositions', style.compositions?.join(', ')],
                ['Complexity', style.complexity ? `Level ${style.complexity}` : null],
                ['Best Format', style.best_format],
                ['Best Size', style.best_size],
                ['SREF Code', style.sref_code]
            ].filter(([_, value]) => value);
            
            document.getElementById('styleModalAttributes').innerHTML = attributes.map(([label, value]) => `
                <div class="attribute-item">
                    <div class="attribute-label">${label}</div>
                    <div class="attribute-value">${value}</div>
                </div>
            `).join('');
            
            // Track current style for actions
            currentModalStyleId = styleId;
            currentModalStyleName = style.name;
            
            // Update favorite button state
            updateFavoriteButtonState();
            
            // Show/hide admin actions based on role
            const adminActions = document.getElementById('styleModalAdminActions');
            if (adminActions) {
                adminActions.style.display = isSuperAdmin() ? 'flex' : 'none';
            }
            
            styleModal.classList.add('active');
        }
        
        // Variable to track current style in modal
        let currentModalStyleId = null;
        let currentModalStyleName = null;
        
        // Update favorite button appearance
        function updateFavoriteButtonState() {
            const btn = document.getElementById('styleModalFavoriteBtn');
            const btnText = document.getElementById('styleModalFavoriteBtnText');
            const svg = btn.querySelector('svg');
            
            if (!currentUser) {
                btn.style.display = 'none';
                return;
            }
            
            btn.style.display = 'inline-flex';
            
            // Check if favorited using local function
            const isFavorited = isStyleFavorited(currentModalStyleId);
            
            if (isFavorited) {
                btn.classList.add('active');
                btnText.textContent = 'Favorited';
                svg.setAttribute('fill', 'currentColor');
            } else {
                btn.classList.remove('active');
                btnText.textContent = 'Favorite';
                svg.setAttribute('fill', 'none');
            }
        }
        
        // Toggle favorite on current modal style
        async function toggleStyleFavorite() {
            if (!currentUser) {
                openAuthModal();
                return;
            }
            
            if (!currentModalStyleId) return;
            
            const { supabase } = window.SocietyArts;
            
            try {
                if (isStyleFavorited(currentModalStyleId)) {
                    // Remove from favorites
                    const { error } = await supabase
                        .from('user_favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('style_id', currentModalStyleId);
                    
                    if (error) throw error;
                    
                    localFavorites = localFavorites.filter(f => f.style_id !== currentModalStyleId);
                    showToast('Removed from favorites');
                } else {
                    // Add to favorites
                    const { error } = await supabase
                        .from('user_favorites')
                        .insert({
                            user_id: currentUser.id,
                            style_id: currentModalStyleId,
                            style_name: currentModalStyleName
                        });
                    
                    if (error && error.code !== '23505') {
                        throw error;
                    }
                    
                    localFavorites.unshift({
                        style_id: currentModalStyleId,
                        style_name: currentModalStyleName,
                        created_at: new Date().toISOString()
                    });
                    showToast('Added to favorites');
                }
                
                updateFavoriteButtonState();
                
                // Also update the card button if visible
                const cardBtn = document.querySelector(`.style-card[data-style-id="${currentModalStyleId}"] .favorite-btn`);
                if (cardBtn) {
                    cardBtn.classList.toggle('active', isStyleFavorited(currentModalStyleId));
                }
            } catch (error) {
                console.error('Failed to toggle favorite:', error);
                showToast('Failed to update favorite');
            }
        }
        
        // Add style to project (redirect to story builder)
        function addStyleToProject() {
            if (!currentModalStyleId) return;
            
            // Store selected style in sessionStorage
            const selectedStyles = JSON.parse(sessionStorage.getItem('selectedStyles') || '[]');
            if (!selectedStyles.includes(currentModalStyleId)) {
                selectedStyles.push(currentModalStyleId);
                sessionStorage.setItem('selectedStyles', JSON.stringify(selectedStyles));
            }
            
            // Redirect to story builder
            window.location.href = `/story-builder.html?addStyle=${currentModalStyleId}`;
        }
        
        // Flag style for review (admin only)
        async function flagStyleForReview() {
            if (!isSuperAdmin() || !currentModalStyleId) return;
            
            const reason = prompt('Enter reason for flagging this style:');
            if (!reason) return;
            
            try {
                // Update style status
                const { error } = await supabase
                    .from('styles')
                    .update({ 
                        status: 'flagged',
                        admin_notes: reason
                    })
                    .eq('id', currentModalStyleId);
                
                if (error) throw error;
                
                alert(`Style ${currentModalStyleId} has been flagged for review.`);
                styleModal.classList.remove('active');
            } catch (error) {
                console.error('Failed to flag style:', error);
                alert('Failed to flag style. Please try again.');
            }
        }
        
        // Unlist style (admin only)
        async function unlistStyle() {
            if (!isSuperAdmin() || !currentModalStyleId) return;
            
            if (!confirm(`Are you sure you want to unlist style "${currentModalStyleName}"? It will no longer appear in search results.`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('styles')
                    .update({ is_listed: false })
                    .eq('id', currentModalStyleId);
                
                if (error) throw error;
                
                alert(`Style ${currentModalStyleId} has been unlisted.`);
                styleModal.classList.remove('active');
                
                // Remove from grid
                const card = document.querySelector(`[data-style-id="${currentModalStyleId}"]`);
                if (card) card.remove();
            } catch (error) {
                console.error('Failed to unlist style:', error);
                alert('Failed to unlist style. Please try again.');
            }
        }
        
        styleModalClose.addEventListener('click', () => styleModal.classList.remove('active'));
        styleModal.addEventListener('click', (e) => {
            if (e.target === styleModal) styleModal.classList.remove('active');
        });
        
        // ============================================
        // Lightbox
        // ============================================
        function openLightbox(index) {
            lightboxIndex = index;
            updateLightbox();
            lightbox.classList.add('active');
        }
        
        function updateLightbox() {
            lightboxImage.src = lightboxImages[lightboxIndex];
            lightboxCounter.textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;
            lightboxImage.classList.remove('zoomed');
            isZoomed = false;
        }
        
        document.getElementById('lightboxClose').addEventListener('click', () => {
            lightbox.classList.remove('active');
        });
        
        document.getElementById('lightboxPrev').addEventListener('click', (e) => {
            e.stopPropagation();
            lightboxIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
            updateLightbox();
        });
        
        document.getElementById('lightboxNext').addEventListener('click', (e) => {
            e.stopPropagation();
            lightboxIndex = (lightboxIndex + 1) % lightboxImages.length;
            updateLightbox();
        });
        
        lightboxImage.addEventListener('click', (e) => {
            e.stopPropagation();
            isZoomed = !isZoomed;
            lightboxImage.classList.toggle('zoomed', isZoomed);
            if (isZoomed) {
                lightboxImage.style.width = '150%';
                lightboxImage.style.maxWidth = 'none';
            } else {
                lightboxImage.style.width = '';
                lightboxImage.style.maxWidth = '';
            }
        });
        
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                lightbox.classList.remove('active');
            }
        });
        
        // ============================================
        // Context Menu
        // ============================================
        function openContextMenu(event, styleId, imageUrl) {
            event.preventDefault();
            currentMenuStyleId = styleId;
            currentMenuImageUrl = imageUrl;
            
            const x = Math.min(event.clientX, window.innerWidth - 220);
            const y = Math.min(event.clientY, window.innerHeight - 200);
            
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('active');
        }
        
        document.addEventListener('click', () => {
            contextMenu.classList.remove('active');
        });
        
        document.getElementById('menuSave').addEventListener('click', async () => {
            if (!currentMenuStyleId) return;
            SocietyArts.saveStyle(currentMenuStyleId);
            showToast('Style saved to your collection!');
        });
        
        document.getElementById('menuAddToCollection').addEventListener('click', () => {
            if (!currentMenuStyleId) return;
            openCollectionModal();
        });
        
        document.getElementById('menuReportSwap').addEventListener('click', async () => {
            if (!currentMenuStyleId) return;
            const result = await SocietyArts.reportStyleForReview(currentMenuStyleId);
            showToast(result.message, 5000);
        });
        
        // Unlist style - show confirmation first
        let styleToUnlist = null;
        
        document.getElementById('menuReportDelete').addEventListener('click', () => {
            if (!currentMenuStyleId) return;
            styleToUnlist = currentMenuStyleId;
            confirmModal.classList.add('active');
        });
        
        document.getElementById('confirmCancel').addEventListener('click', () => {
            styleToUnlist = null;
            confirmModal.classList.remove('active');
        });
        
        document.getElementById('confirmUnlist').addEventListener('click', async () => {
            if (!styleToUnlist) return;
            
            confirmModal.classList.remove('active');
            showLoading(true);
            
            const result = await SocietyArts.unlistStyle(styleToUnlist);
            
            if (result.success) {
                renderStyles();
                updateResultsCount();
                updatePagination();
            }
            
            showLoading(false);
            showToast(result.message, 4000);
            styleToUnlist = null;
        });
        
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                styleToUnlist = null;
                confirmModal.classList.remove('active');
            }
        });
        
        // ============================================
        // Collection Modal
        // ============================================
        function openCollectionModal() {
            renderCollectionList();
            collectionModal.classList.add('active');
        }
        
        function renderCollectionList() {
            const collections = SocietyArts.getCollections();
            const styleCollections = SocietyArts.getStyleCollections(currentMenuStyleId);
            const styleCollectionIds = styleCollections.map(c => c.id);
            
            if (collections.length === 0) {
                document.getElementById('collectionList').innerHTML = 
                    '<p style="color:#999;text-align:center;padding:1rem;">No collections yet. Create one below!</p>';
                return;
            }
            
            document.getElementById('collectionList').innerHTML = collections.map(col => `
                <div class="collection-item ${styleCollectionIds.includes(col.id) ? 'selected' : ''}" 
                     onclick="toggleCollection('${col.id}')">
                    <div class="collection-item-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="collection-item-info">
                        <div class="collection-item-name">${col.name}</div>
                        <div class="collection-item-count">${col.styleIds.length} style${col.styleIds.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleCollection(collectionId) {
            const collections = SocietyArts.getStyleCollections(currentMenuStyleId);
            const isInCollection = collections.some(c => c.id === collectionId);
            
            if (isInCollection) {
                SocietyArts.removeFromCollection(collectionId, currentMenuStyleId);
                showToast('Removed from collection');
            } else {
                SocietyArts.addToCollection(collectionId, currentMenuStyleId);
                showToast('Added to collection');
            }
            
            renderCollectionList();
        }
        
        document.getElementById('collectionModalClose').addEventListener('click', () => {
            collectionModal.classList.remove('active');
        });
        
        collectionModal.addEventListener('click', (e) => {
            if (e.target === collectionModal) collectionModal.classList.remove('active');
        });
        
        document.getElementById('createCollectionBtn').addEventListener('click', () => {
            const input = document.getElementById('newCollectionName');
            const name = input.value.trim();
            
            if (!name) {
                showToast('Please enter a collection name');
                return;
            }
            
            SocietyArts.createCollection(name);
            input.value = '';
            renderCollectionList();
            showToast(`Collection "${name}" created`);
        });
        
        document.getElementById('newCollectionName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('createCollectionBtn').click();
            }
        });
        
        // ============================================
        // Keyboard Navigation
        // ============================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (confirmModal.classList.contains('active')) {
                    styleToUnlist = null;
                    confirmModal.classList.remove('active');
                } else if (lightbox.classList.contains('active')) {
                    lightbox.classList.remove('active');
                } else if (collectionModal.classList.contains('active')) {
                    collectionModal.classList.remove('active');
                } else if (styleModal.classList.contains('active')) {
                    styleModal.classList.remove('active');
                }
                contextMenu.classList.remove('active');
            }
            
            if (lightbox.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    document.getElementById('lightboxPrev').click();
                } else if (e.key === 'ArrowRight') {
                    document.getElementById('lightboxNext').click();
                }
            }
        });
        
        // ============================================
        // AUTHENTICATION SYSTEM
        // ============================================
        
        // Auth State
        let currentUser = null;
        let userProfile = null;
        let currentEditStyleId = null;
        
        // Initialize Auth on page load
        async function initializeAuth() {
            const { supabase } = window.SocietyArts;
            
            // Check current session
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                
                // Also update shared AuthState for projects.js functions
                if (window.SocietyArts?.AuthState) {
                    window.SocietyArts.AuthState.user = session.user;
                }
                
                await loadUserProfile();
                
                // Load user's favorites from database
                await loadUserFavoritesLocal();
                
                updateAuthUI();
            }
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event);
                
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    
                    // Also update shared AuthState
                    if (window.SocietyArts?.AuthState) {
                        window.SocietyArts.AuthState.user = session.user;
                    }
                    
                    await loadUserProfile();
                    
                    // Load user's favorites from database
                    await loadUserFavoritesLocal();
                    
                    // Re-render styles to show correct favorite states
                    renderStyles();
                    
                    updateAuthUI();
                    closeAuthModal();
                    showToast('Signed in successfully!');
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    localFavorites = [];
                    
                    // Clear shared AuthState
                    if (window.SocietyArts?.AuthState) {
                        window.SocietyArts.AuthState.user = null;
                        window.SocietyArts.AuthState.profile = null;
                    }
                    
                    updateAuthUI();
                    // Re-render to clear favorite states
                    renderStyles();
                    showToast('Signed out');
                }
            });
        }
        
        // Load user profile from database
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const { supabase } = window.SocietyArts;
            
            const { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                console.error('Error loading profile:', error);
                // Profile might not exist yet - create it
                if (error.code === 'PGRST116') {
                    await createUserProfile();
                }
                return;
            }
            
            userProfile = data;
            
            // Also update shared AuthState for consistency
            if (window.SocietyArts?.AuthState) {
                window.SocietyArts.AuthState.profile = data;
            }
            
            console.log('Loaded user profile:', userProfile);
        }
        
        // Create user profile if it doesn't exist
        async function createUserProfile() {
            if (!currentUser) return;
            
            const { supabase } = window.SocietyArts;
            
            const displayName = currentUser.user_metadata?.full_name || 
                               currentUser.user_metadata?.name || 
                               currentUser.email.split('@')[0];
            
            const { data, error } = await supabase
                .from('user_profiles')
                .insert({
                    id: currentUser.id,
                    email: currentUser.email,
                    display_name: displayName,
                    role: currentUser.email === 'steve@societyarts.com' ? 'super_admin' : 'user'
                })
                .select()
                .single();
            
            if (error) {
                console.error('Error creating profile:', error);
                return;
            }
            
            userProfile = data;
        }
        
        // Update UI based on auth state
        function updateAuthUI() {
            const signInBtn = document.getElementById('signInBtn');
            const userMenuContainer = document.getElementById('userMenuContainer');
            
            if (currentUser && userProfile) {
                // Show user menu, hide sign in button
                signInBtn.style.display = 'none';
                userMenuContainer.style.display = 'block';
                
                // Update user info
                const initials = getInitials(userProfile.display_name || currentUser.email);
                document.getElementById('userInitials').textContent = initials;
                document.getElementById('userName').textContent = userProfile.display_name || 'User';
                document.getElementById('dropdownUserName').textContent = userProfile.display_name || 'User';
                document.getElementById('dropdownUserEmail').textContent = currentUser.email;
                
                // Show role badge if admin
                const roleBadge = document.getElementById('dropdownUserRole');
                const adminUsersBtn = document.getElementById('adminUsersBtn');
                
                if (userProfile.role === 'admin' || userProfile.role === 'super_admin') {
                    roleBadge.textContent = userProfile.role === 'super_admin' ? 'Super Admin' : 'Admin';
                    roleBadge.style.display = 'inline-block';
                    adminUsersBtn.style.display = 'flex';
                } else {
                    roleBadge.style.display = 'none';
                    adminUsersBtn.style.display = 'none';
                }
                
                // Handle avatar
                const avatarEl = document.getElementById('userAvatar');
                if (userProfile.avatar_url) {
                    avatarEl.innerHTML = `<img src="${userProfile.avatar_url}" alt="Avatar">`;
                } else {
                    avatarEl.innerHTML = `<span id="userInitials">${initials}</span>`;
                }
            } else {
                // Show sign in button, hide user menu
                signInBtn.style.display = 'flex';
                userMenuContainer.style.display = 'none';
            }
        }
        
        function getInitials(name) {
            if (!name) return 'U';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // Check if current user is admin
        function isAdmin() {
            return userProfile && (userProfile.role === 'admin' || userProfile.role === 'super_admin');
        }
        
        function isSuperAdmin() {
            return userProfile && userProfile.role === 'super_admin';
        }
        
        // ============================================
        // AUTH MODAL FUNCTIONS
        // ============================================
        
        function openAuthModal() {
            document.getElementById('authModalOverlay').classList.add('open');
            showAuthView('welcome');
        }
        
        function closeAuthModal() {
            document.getElementById('authModalOverlay').classList.remove('open');
        }
        
        function showAuthView(view) {
            // Hide all views
            document.querySelectorAll('.auth-view').forEach(v => v.style.display = 'none');
            
            // Show requested view
            const viewElement = document.getElementById(`authView${view.charAt(0).toUpperCase() + view.slice(1)}`);
            if (viewElement) {
                viewElement.style.display = 'block';
            }
            
            // Clear any messages
            document.querySelectorAll('[id$="Message"]').forEach(el => el.innerHTML = '');
        }
        
        function showUnderConstruction(provider) {
            document.getElementById('constructionTitle').textContent = `${provider} Sign In Coming Soon`;
            document.getElementById('constructionText').textContent = `${provider} login is coming soon. Please use Google or email sign-in for now.`;
            showAuthView('construction');
        }
        
        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        // ============================================
        // AUTH HANDLERS
        // ============================================
        
        // Google Sign In
        async function signInWithGoogle() {
            const { supabase } = window.SocietyArts;
            
            // Always redirect to production URL (works for both local testing and production)
            const productionUrl = 'https://studio.societyarts.com';
            const currentPath = window.location.pathname;
            
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: productionUrl + currentPath
                }
            });
            
            if (error) {
                console.error('Google sign in error:', error);
                showAuthMessage('authSigninMessage', 'error', 'Failed to sign in with Google. Please try again.');
            }
        }
        
        // Email submit (check if user exists)
        async function handleEmailSubmit(event) {
            event.preventDefault();
            
            const email = document.getElementById('authEmailInput').value.trim();
            
            // Pre-fill email in signup form and show it
            document.getElementById('signupEmail').value = email;
            showAuthView('signup');
        }
        
        // Sign In
        async function handleSignIn(event) {
            event.preventDefault();
            
            const email = document.getElementById('signinEmail').value.trim();
            const password = document.getElementById('signinPassword').value;
            const btn = document.getElementById('signinBtn');
            
            btn.classList.add('loading');
            btn.disabled = true;
            
            const { supabase } = window.SocietyArts;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
            
            btn.classList.remove('loading');
            btn.disabled = false;
            
            if (error) {
                showAuthMessage('authSigninMessage', 'error', error.message);
                return;
            }
            
            // Success - auth state change will handle the rest
        }
        
        // Sign Up
        async function handleSignUp(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const btn = document.getElementById('signupBtn');
            
            // Validate passwords match
            if (password !== passwordConfirm) {
                showAuthMessage('authSignupMessage', 'error', 'Passwords do not match.');
                return;
            }
            
            btn.classList.add('loading');
            btn.disabled = true;
            
            const { supabase } = window.SocietyArts;
            
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name
                    },
                    emailRedirectTo: 'https://studio.societyarts.com/style-finder.html'
                }
            });
            
            btn.classList.remove('loading');
            btn.disabled = false;
            
            if (error) {
                showAuthMessage('authSignupMessage', 'error', error.message);
                return;
            }
            
            // Check if email confirmation is required
            if (data.user && !data.session) {
                showAuthMessage('authSignupMessage', 'success', 'Check your email for a confirmation link to complete your registration.');
            }
        }
        
        // Forgot Password
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            
            btn.classList.add('loading');
            btn.disabled = true;
            
            const { supabase } = window.SocietyArts;
            
            const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: 'https://studio.societyarts.com/style-finder.html'
            });
            
            btn.classList.remove('loading');
            btn.disabled = false;
            
            if (error) {
                showAuthMessage('authForgotMessage', 'error', error.message);
                return;
            }
            
            showAuthMessage('authForgotMessage', 'success', 'If an account exists with this email, you will receive a password reset link.');
        }
        
        // Logout
        async function handleLogout() {
            const { supabase } = window.SocietyArts;
            
            const { error } = await supabase.auth.signOut();
            
            if (error) {
                console.error('Logout error:', error);
            }
            
            closeUserMenu();
        }
        
        function showAuthMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="auth-message ${type}">${message}</div>`;
            }
        }
        
        // ============================================
        // USER MENU FUNCTIONS
        // ============================================
        
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            const btn = document.getElementById('userAvatarBtn');
            
            dropdown.classList.toggle('open');
            btn.classList.toggle('open');
        }
        
        function closeUserMenu() {
            document.getElementById('userDropdown').classList.remove('open');
            document.getElementById('userAvatarBtn').classList.remove('open');
        }
        
        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const userMenuContainer = document.getElementById('userMenuContainer');
            if (userMenuContainer && !userMenuContainer.contains(e.target)) {
                closeUserMenu();
            }
        });
        
        // ============================================
        // PROFILE MODAL FUNCTIONS
        // ============================================
        
        function openProfileModal() {
            closeUserMenu();
            
            if (!currentUser || !userProfile) return;
            
            // Populate profile data
            const initials = getInitials(userProfile.display_name);
            document.getElementById('profileInitials').textContent = initials;
            document.getElementById('profileName').textContent = userProfile.display_name || 'User';
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileDisplayName').textContent = userProfile.display_name || 'Not set';
            document.getElementById('profileEmailField').textContent = currentUser.email;
            
            // Handle avatar
            const avatarEl = document.getElementById('profileAvatar');
            if (userProfile.avatar_url) {
                avatarEl.innerHTML = `<img src="${userProfile.avatar_url}" alt="Avatar">`;
            } else {
                avatarEl.innerHTML = `<span id="profileInitials">${initials}</span>`;
            }
            
            // Show role badge and admin section if applicable
            const roleBadge = document.getElementById('profileRole');
            const adminSection = document.getElementById('profileAdminSection');
            
            if (userProfile.role === 'admin' || userProfile.role === 'super_admin') {
                roleBadge.textContent = userProfile.role === 'super_admin' ? 'Super Admin' : 'Admin';
                roleBadge.style.display = 'inline-block';
                adminSection.style.display = 'block';
                document.getElementById('profileRoleText').textContent = 
                    userProfile.role === 'super_admin' ? 'Super Admin' : 'Admin';
            } else {
                roleBadge.style.display = 'none';
                adminSection.style.display = 'none';
            }
            
            document.getElementById('profileModalOverlay').classList.add('open');
        }
        
        function closeProfileModal() {
            document.getElementById('profileModalOverlay').classList.remove('open');
        }
        
        async function editProfileField(field) {
            const newValue = prompt(`Enter new ${field === 'displayName' ? 'display name' : field}:`);
            
            if (!newValue || !newValue.trim()) return;
            
            const { supabase } = window.SocietyArts;
            
            if (field === 'displayName') {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ display_name: newValue.trim(), updated_at: new Date().toISOString() })
                    .eq('id', currentUser.id);
                
                if (error) {
                    showToast('Failed to update display name');
                    return;
                }
                
                userProfile.display_name = newValue.trim();
                updateAuthUI();
                openProfileModal(); // Refresh
                showToast('Display name updated!');
            } else if (field === 'password') {
                const { error } = await supabase.auth.updateUser({
                    password: newValue
                });
                
                if (error) {
                    showToast('Failed to update password: ' + error.message);
                    return;
                }
                
                showToast('Password updated!');
            }
        }
        
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file');
                return;
            }
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be less than 2MB');
                return;
            }
            
            const { supabase } = window.SocietyArts;
            
            // Upload to storage
            const fileExt = file.name.split('.').pop();
            const filePath = `${currentUser.id}/avatar.${fileExt}`;
            
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(filePath, file, { upsert: true });
            
            if (uploadError) {
                console.error('Upload error:', uploadError);
                showToast('Failed to upload avatar');
                return;
            }
            
            // Get public URL
            const { data: urlData } = supabase.storage
                .from('avatars')
                .getPublicUrl(filePath);
            
            // Update profile
            const { error: updateError } = await supabase
                .from('user_profiles')
                .update({ avatar_url: urlData.publicUrl, updated_at: new Date().toISOString() })
                .eq('id', currentUser.id);
            
            if (updateError) {
                console.error('Update error:', updateError);
                showToast('Failed to update profile');
                return;
            }
            
            userProfile.avatar_url = urlData.publicUrl;
            updateAuthUI();
            openProfileModal(); // Refresh
            showToast('Avatar updated!');
        }
        
        // ============================================
        // ADMIN USER MANAGEMENT
        // ============================================
        
        async function openAdminUsersModal() {
            closeUserMenu();
            
            if (!isSuperAdmin()) {
                showToast('Only super admins can manage users');
                return;
            }
            
            // TODO: Implement admin users modal
            showToast('User management coming soon!');
        }
        
        // ============================================
        // EDIT STYLE MODAL (Admin Only)
        // ============================================
        
        async function openEditStyleModal(styleId) {
            if (!isAdmin()) {
                showToast('Only admins can edit styles');
                return;
            }
            
            currentEditStyleId = styleId;
            
            // Get style data
            const style = SocietyArts.getStyleById(styleId);
            if (!style) {
                showToast('Style not found');
                return;
            }
            
            // Populate form
            document.getElementById('editStyleThumbnail').querySelector('img').src = style.thumbnail;
            document.getElementById('editStyleId').textContent = style.id;
            document.getElementById('editStyleName').value = style.name || '';
            document.getElementById('editStyleTagline').value = style.tagline || '';
            document.getElementById('editStyleDescription').value = style.description || '';
            
            // Populate dropdowns
            await populateEditStyleDropdowns();
            
            // Set current values (would need to load from junction tables)
            document.getElementById('editStyleComplexity').value = style.complexity || '';
            
            // Set checkboxes
            const featuredCheckbox = document.getElementById('editStyleFeaturedCheckbox');
            const newCheckbox = document.getElementById('editStyleNewCheckbox');
            
            featuredCheckbox.classList.toggle('checked', style.is_featured);
            newCheckbox.classList.toggle('checked', style.is_new);
            
            // Add click handlers for checkboxes
            featuredCheckbox.onclick = () => featuredCheckbox.classList.toggle('checked');
            newCheckbox.onclick = () => newCheckbox.classList.toggle('checked');
            
            document.getElementById('editStyleModalOverlay').classList.add('open');
        }
        
        function closeEditStyleModal() {
            document.getElementById('editStyleModalOverlay').classList.remove('open');
            currentEditStyleId = null;
        }
        
        async function populateEditStyleDropdowns() {
            const lookups = SocietyArts.getLookups();
            
            const dropdownMap = {
                'editStyleArtType': 'art_types',
                'editStyleMedium': 'mediums',
                'editStyleEra': 'eras',
                'editStyleCulture': 'cultures',
                'editStylePalette': 'palettes',
                'editStyleLighting': 'lighting',
                'editStyleComposition': 'compositions'
            };
            
            Object.entries(dropdownMap).forEach(([selectId, lookupTable]) => {
                const select = document.getElementById(selectId);
                const options = lookups[lookupTable] || [];
                
                // Keep first option
                select.innerHTML = select.options[0].outerHTML;
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = opt.name;
                    select.appendChild(option);
                });
            });
        }
        
        async function handleSaveStyle(event) {
            event.preventDefault();
            
            if (!currentEditStyleId || !isAdmin()) return;
            
            const { supabase } = window.SocietyArts;
            
            const updates = {
                name: document.getElementById('editStyleName').value.trim(),
                tagline: document.getElementById('editStyleTagline').value.trim(),
                description: document.getElementById('editStyleDescription').value.trim(),
                complexity: parseInt(document.getElementById('editStyleComplexity').value) || null,
                is_featured: document.getElementById('editStyleFeaturedCheckbox').classList.contains('checked'),
                is_new: document.getElementById('editStyleNewCheckbox').classList.contains('checked'),
                updated_at: new Date().toISOString()
            };
            
            const btn = document.getElementById('saveStyleBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const { error } = await supabase
                .from('styles')
                .update(updates)
                .eq('id', currentEditStyleId);
            
            btn.disabled = false;
            btn.textContent = 'Save Changes';
            
            if (error) {
                console.error('Save error:', error);
                showToast('Failed to save changes: ' + error.message);
                return;
            }
            
            // TODO: Update junction tables for categories
            
            showToast('Style updated successfully!');
            closeEditStyleModal();
            
            // Refresh the styles
            await SocietyArts.applyFilters({});
            renderStyles();
        }
        
        // Close modals when clicking overlay
        document.getElementById('authModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAuthModal();
        });
        
        document.getElementById('profileModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeProfileModal();
        });
        
        document.getElementById('editStyleModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeEditStyleModal();
        });
        
        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAuthModal();
                closeProfileModal();
                closeEditStyleModal();
            }
        });
        
        // ============================================
        // Start
        // ============================================
        // Initialize auth first to get user's favorites, then render styles
        initializeAuth().then(() => {
            initialize();
        });
    </script>
</body>
</html>
