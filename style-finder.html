<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Finder | Society Arts</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/modals.css">
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Style Finder Page Specific Styles */
        .style-finder-page {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        
        /* Sidebar */
        .filter-sidebar {
            width: 280px;
            background: var(--color-surface, #fff);
            border-right: 1px solid var(--color-border, #e5e5e5);
            overflow-y: auto;
            padding: 1rem;
            flex-shrink: 0;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-secondary, #666);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--color-border, #ddd);
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--color-accent, #C75B3F);
        }
        
        .clear-filters-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            background: var(--color-surface, #f5f5f5);
            border: 1px solid var(--color-border, #ddd);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--color-text-secondary, #666);
            transition: all 0.2s;
        }
        
        .clear-filters-btn:hover {
            background: var(--color-border, #e5e5e5);
        }
        
        /* Main Content */
        .styles-main {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--color-background, #F5F0EB);
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-border, #ddd);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-accent, #C75B3F);
            box-shadow: 0 0 0 3px rgba(199, 91, 63, 0.1);
        }
        
        .results-count {
            color: var(--color-text-secondary, #666);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Style Grid */
        .styles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
        }
        
        .style-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .style-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        .style-card-image {
            aspect-ratio: 1;
            background: var(--color-surface, #f5f5f5);
            position: relative;
            overflow: hidden;
        }
        
        .style-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .style-card-image .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary, #999);
            font-size: 0.75rem;
        }
        
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .favorite-btn:hover {
            transform: scale(1.1);
        }
        
        .favorite-btn.active svg {
            fill: #e74c3c;
        }
        
        .style-card-info {
            padding: 1rem;
        }
        
        .style-card-id {
            font-size: 0.75rem;
            color: var(--color-text-secondary, #999);
            margin-bottom: 0.25rem;
        }
        
        .style-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text, #333);
            margin: 0;
            line-height: 1.3;
        }
        
        .style-card-tagline {
            font-size: 0.8rem;
            color: var(--color-text-secondary, #666);
            margin-top: 0.25rem;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border, #ddd);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--color-accent, #C75B3F);
            color: white;
            border-color: var(--color-accent, #C75B3F);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: var(--color-text-secondary, #666);
            font-size: 0.875rem;
        }
        
        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border, #ddd);
            border-top-color: var(--color-accent, #C75B3F);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Style Detail Modal */
        .style-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .style-modal.active {
            display: flex;
        }
        
        .style-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .style-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--color-surface, #f5f5f5);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .style-modal-gallery {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            padding: 1.5rem;
            background: var(--color-surface, #f5f5f5);
        }
        
        .style-modal-gallery img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .style-modal-gallery img:hover {
            transform: scale(1.05);
        }
        
        .style-modal-info {
            padding: 1.5rem;
        }
        
        .style-modal-id {
            font-size: 0.875rem;
            color: var(--color-text-secondary, #999);
            margin-bottom: 0.25rem;
        }
        
        .style-modal-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
        }
        
        .style-modal-tagline {
            font-size: 1rem;
            color: var(--color-accent, #C75B3F);
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .style-modal-description {
            color: var(--color-text-secondary, #666);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .style-modal-attributes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .attribute-item {
            background: var(--color-surface, #f5f5f5);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        
        .attribute-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary, #999);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .attribute-value {
            font-weight: 500;
            color: var(--color-text, #333);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .filter-sidebar {
                display: none;
            }
            
            .styles-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .style-modal-gallery {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="index.html" class="logo">Society Arts</a>
            <nav class="header-nav">
                <a href="story-builder.html">Story Builder</a>
                <a href="style-finder.html" class="active">Style Finder</a>
            </nav>
        </div>
    </header>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Main Content -->
    <div class="style-finder-page">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar">
            <div class="filter-section">
                <h3>Search</h3>
                <input type="text" class="filter-select" id="sidebarSearch" placeholder="Search styles...">
            </div>
            
            <div class="filter-section">
                <h3>Art Type</h3>
                <select class="filter-select" id="filterArtType">
                    <option value="">All Art Types</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Medium</h3>
                <select class="filter-select" id="filterMedium">
                    <option value="">All Mediums</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Culture</h3>
                <select class="filter-select" id="filterCulture">
                    <option value="">All Cultures</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Era</h3>
                <select class="filter-select" id="filterEra">
                    <option value="">All Eras</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Palette</h3>
                <select class="filter-select" id="filterPalette">
                    <option value="">All Palettes</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Lighting</h3>
                <select class="filter-select" id="filterLighting">
                    <option value="">All Lighting</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Composition</h3>
                <select class="filter-select" id="filterComposition">
                    <option value="">All Compositions</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Complexity</h3>
                <select class="filter-select" id="filterComplexity">
                    <option value="">All Levels</option>
                    <option value="1">1 - Simple</option>
                    <option value="2">2 - Moderate</option>
                    <option value="3">3 - Complex</option>
                    <option value="4">4 - Very Complex</option>
                    <option value="5">5 - Highly Complex</option>
                </select>
            </div>
            
            <div class="filter-section">
                <button class="clear-filters-btn" id="clearFiltersBtn">Clear All Filters</button>
            </div>
        </aside>
        
        <!-- Styles Grid -->
        <main class="styles-main">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="Search styles...">
                <span class="results-count" id="resultsCount">Loading...</span>
            </div>
            
            <div class="styles-grid" id="stylesGrid">
                <!-- Styles will be inserted here -->
            </div>
            
            <div class="pagination" id="pagination">
                <button class="pagination-btn" id="prevPageBtn" disabled>← Previous</button>
                <span class="pagination-info" id="paginationInfo">Page 1 of 1</span>
                <button class="pagination-btn" id="nextPageBtn">Next →</button>
            </div>
        </main>
    </div>
    
    <!-- Style Detail Modal -->
    <div class="style-modal" id="styleModal">
        <div class="style-modal-content">
            <button class="style-modal-close" id="styleModalClose">×</button>
            <div class="style-modal-gallery" id="styleModalGallery">
                <!-- Images inserted here -->
            </div>
            <div class="style-modal-info">
                <div class="style-modal-id" id="styleModalId"></div>
                <h2 class="style-modal-name" id="styleModalName"></h2>
                <div class="style-modal-tagline" id="styleModalTagline"></div>
                <p class="style-modal-description" id="styleModalDescription"></p>
                <div class="style-modal-attributes" id="styleModalAttributes">
                    <!-- Attributes inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/shared/supabase-client.js"></script>
    <script src="js/style-finder/style-data.js"></script>
    <script>
        // ============================================
        // DOM Elements
        // ============================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stylesGrid = document.getElementById('stylesGrid');
        const searchInput = document.getElementById('searchInput');
        const sidebarSearch = document.getElementById('sidebarSearch');
        const resultsCount = document.getElementById('resultsCount');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const styleModal = document.getElementById('styleModal');
        const styleModalClose = document.getElementById('styleModalClose');
        
        // Filter elements mapped to database columns
        const filterSelects = {
            art_type_id: document.getElementById('filterArtType'),
            primary_medium_id: document.getElementById('filterMedium'),
            culture_id: document.getElementById('filterCulture'),
            era_id: document.getElementById('filterEra'),
            primary_palette_id: document.getElementById('filterPalette'),
            primary_lighting_id: document.getElementById('filterLighting'),
            primary_composition_id: document.getElementById('filterComposition'),
            complexity: document.getElementById('filterComplexity')
        };
        
        // Lookup table mapping (column -> lookup table)
        const filterToLookup = {
            art_type_id: 'art_types',
            primary_medium_id: 'mediums',
            culture_id: 'cultures',
            era_id: 'eras',
            primary_palette_id: 'palettes',
            primary_lighting_id: 'lighting',
            primary_composition_id: 'compositions'
            // complexity is not a lookup - it's direct values
        };
        
        // ============================================
        // Initialize
        // ============================================
        async function initialize() {
            showLoading(true);
            
            try {
                await SocietyArts.initializeStyleData();
                populateFilterDropdowns();
                renderStyles();
                updateResultsCount();
                updatePagination();
            } catch (error) {
                console.error('Initialization failed:', error);
                stylesGrid.innerHTML = '<p style="text-align:center;color:#999;padding:2rem;">Failed to load styles. Please refresh the page.</p>';
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // UI Functions
        // ============================================
        function showLoading(show) {
            loadingOverlay.classList.toggle('active', show);
        }
        
        function populateFilterDropdowns() {
            Object.entries(filterSelects).forEach(([filterKey, selectEl]) => {
                // Skip complexity - it has hardcoded options
                if (filterKey === 'complexity') return;
                
                const lookupTable = filterToLookup[filterKey];
                const options = SocietyArts.getLookupOptions(lookupTable);
                
                // Clear existing options except first
                selectEl.innerHTML = selectEl.options[0].outerHTML;
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = opt.name;
                    selectEl.appendChild(option);
                });
            });
        }
        
        function renderStyles() {
            const styles = SocietyArts.getCurrentPageStyles();
            
            if (styles.length === 0) {
                stylesGrid.innerHTML = '<p style="text-align:center;color:#999;padding:2rem;grid-column:1/-1;">No styles found matching your criteria.</p>';
                return;
            }
            
            stylesGrid.innerHTML = styles.map(style => `
                <div class="style-card" data-style-id="${style.id}">
                    <div class="style-card-image">
                        <img src="${style.thumbnail}" alt="${style.name}" 
                             onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>Image not available</div>'">
                        <button class="favorite-btn ${SocietyArts.isFavorite(style.id) ? 'active' : ''}" 
                                onclick="event.stopPropagation(); toggleFavorite('${style.id}', this)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="style-card-info">
                        <div class="style-card-id">${style.id}</div>
                        <h3 class="style-card-name">${style.name || 'Untitled Style'}</h3>
                        ${style.tagline ? `<div class="style-card-tagline">${style.tagline}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.style-card').forEach(card => {
                card.addEventListener('click', () => openStyleModal(card.dataset.styleId));
            });
        }
        
        function updateResultsCount() {
            const total = SocietyArts.filteredStyles().length;
            resultsCount.textContent = `${total.toLocaleString()} style${total !== 1 ? 's' : ''}`;
        }
        
        function updatePagination() {
            const currentPage = SocietyArts.currentPage();
            const totalPages = SocietyArts.getTotalPages();
            
            prevPageBtn.disabled = currentPage === 0;
            nextPageBtn.disabled = currentPage >= totalPages - 1;
            paginationInfo.textContent = `Page ${currentPage + 1} of ${Math.max(1, totalPages)}`;
        }
        
        // ============================================
        // Event Handlers
        // ============================================
        
        // Search
        let searchTimeout;
        function handleSearch(value) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                SocietyArts.searchStyles(value);
                renderStyles();
                updateResultsCount();
                updatePagination();
            }, 300);
        }
        
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        sidebarSearch.addEventListener('input', (e) => {
            searchInput.value = e.target.value;
            handleSearch(e.target.value);
        });
        
        // Filters
        Object.entries(filterSelects).forEach(([filterKey, selectEl]) => {
            selectEl.addEventListener('change', async () => {
                showLoading(true);
                const filters = {};
                Object.entries(filterSelects).forEach(([key, el]) => {
                    if (el.value) {
                        // Complexity is stored as integer, others as IDs
                        filters[key] = key === 'complexity' ? parseInt(el.value) : parseInt(el.value);
                    }
                });
                await SocietyArts.applyFilters(filters);
                renderStyles();
                updateResultsCount();
                updatePagination();
                showLoading(false);
            });
        });
        
        clearFiltersBtn.addEventListener('click', async () => {
            showLoading(true);
            Object.values(filterSelects).forEach(el => el.value = '');
            searchInput.value = '';
            sidebarSearch.value = '';
            await SocietyArts.clearFilters();
            renderStyles();
            updateResultsCount();
            updatePagination();
            showLoading(false);
        });
        
        // Pagination
        prevPageBtn.addEventListener('click', () => {
            SocietyArts.prevPage();
            renderStyles();
            updatePagination();
            window.scrollTo(0, 0);
        });
        
        nextPageBtn.addEventListener('click', () => {
            SocietyArts.nextPage();
            renderStyles();
            updatePagination();
            window.scrollTo(0, 0);
        });
        
        // Favorites
        function toggleFavorite(styleId, btn) {
            const result = SocietyArts.toggleFavorite(styleId);
            btn.classList.toggle('active', result.added);
        }
        
        // Modal
        async function openStyleModal(styleId) {
            showLoading(true);
            const style = await SocietyArts.getStyleById(styleId);
            showLoading(false);
            
            if (!style) return;
            
            // Populate gallery
            const galleryHtml = style.images.map((url, i) => 
                `<img src="${url}" alt="${style.name} - Image ${i + 1}" 
                      onerror="this.style.display='none'">`
            ).join('');
            document.getElementById('styleModalGallery').innerHTML = galleryHtml;
            
            // Populate info
            document.getElementById('styleModalId').textContent = style.id;
            document.getElementById('styleModalName').textContent = style.name || 'Untitled Style';
            document.getElementById('styleModalTagline').textContent = style.tagline || '';
            document.getElementById('styleModalDescription').textContent = style.description || 'No description available.';
            
            // Populate attributes
            const attributes = [
                ['Art Type', SocietyArts.getLookupName('art_types', style.art_type_id)],
                ['Medium', SocietyArts.getLookupName('mediums', style.primary_medium_id)],
                ['Culture', SocietyArts.getLookupName('cultures', style.culture_id)],
                ['Era', SocietyArts.getLookupName('eras', style.era_id)],
                ['Palette', SocietyArts.getLookupName('palettes', style.primary_palette_id)],
                ['Lighting', SocietyArts.getLookupName('lighting', style.primary_lighting_id)],
                ['Composition', SocietyArts.getLookupName('compositions', style.primary_composition_id)],
                ['Complexity', style.complexity ? `Level ${style.complexity}` : null],
                ['Best Format', style.best_format],
                ['Best Size', style.best_size],
                ['SREF Code', style.sref_code]
            ].filter(([_, value]) => value);
            
            document.getElementById('styleModalAttributes').innerHTML = attributes.map(([label, value]) => `
                <div class="attribute-item">
                    <div class="attribute-label">${label}</div>
                    <div class="attribute-value">${value}</div>
                </div>
            `).join('');
            
            styleModal.classList.add('active');
        }
        
        styleModalClose.addEventListener('click', () => {
            styleModal.classList.remove('active');
        });
        
        styleModal.addEventListener('click', (e) => {
            if (e.target === styleModal) {
                styleModal.classList.remove('active');
            }
        });
        
        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && styleModal.classList.contains('active')) {
                styleModal.classList.remove('active');
            }
        });
        
        // ============================================
        // Start
        // ============================================
        initialize();
    </script>
</body>
</html>
