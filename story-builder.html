<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Builder - Society Arts</title>
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/modals.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  
  <style>
    /* Story Builder Layout */
    .story-builder-layout {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr var(--sidebar-width);
      gap: var(--space-xl);
      padding: var(--space-xl) var(--space-2xl);
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    .story-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      overflow-y: auto;
      min-width: 0;
      padding-right: var(--space-xs);
    }
    
    /* Chat Container */
    .chat-container {
      background-color: var(--color-surface-alt);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .chat-title-bar {
      padding: 14px var(--space-xl);
      border-bottom: 1px solid var(--color-border-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-family: var(--font-serif);
      font-size: var(--text-lg);
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
      flex-shrink: 0;
    }
    
    .voice-mode-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-xl);
      background-color: var(--color-surface-hover);
      border-bottom: 1px solid var(--color-border-dark);
    }
    
    .voice-mode-text {
      font-size: 14px;
      color: var(--color-text-secondary);
      font-weight: var(--weight-medium);
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    /* Welcome State */
    .welcome-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-4xl) 30px;
    }
    
    .welcome-title {
      font-family: var(--font-serif);
      font-size: var(--text-2xl);
      font-weight: var(--weight-normal);
      color: var(--color-text-primary);
      margin-bottom: var(--space-lg);
      letter-spacing: var(--tracking-wider);
    }
    
    .welcome-text {
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      color: var(--color-text-muted);
      max-width: 380px;
      margin: 0 0 var(--space-3xl) 0;
    }
    
    .welcome-input-wrapper {
      display: flex;
      align-items: center;
      background-color: white;
      border-radius: 28px;
      padding: 10px 10px 10px 18px;
      gap: var(--space-md);
      border: 1px solid var(--color-border-light);
      width: 100%;
      max-width: 420px;
    }
    
    .voice-hint {
      font-size: 12px;
      color: var(--color-text-light);
      margin-top: var(--space-md);
    }
    
    .chat-input-area {
      padding: var(--space-lg) var(--space-xl);
      border-top: 1px solid var(--color-border-dark);
      flex-shrink: 0;
    }
    
    /* Styles Column */
    .styles-column {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      overflow-y: auto;
      min-width: 0;
      padding-left: var(--space-xs);
    }
    
    .styles-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }
    
    .add-style-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-lg);
      background: var(--color-surface);
      border: 2px dashed var(--color-border-medium);
      border-radius: var(--radius-md);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      aspect-ratio: 1;
    }
    
    .add-style-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-light);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Shared Components -->
  <script type="text/babel" src="/js/shared/api.js"></script>
  <script type="text/babel" src="/js/shared/header.js"></script>
  <script type="text/babel" src="/js/variations/variations.js"></script>
  <script type="text/babel" src="/js/story-builder/voice.js"></script>
  <script type="text/babel" src="/js/story-builder/story-panel.js"></script>
  <script type="text/babel" src="/js/style-finder/style-data.js"></script>
  
  <!-- Story Builder App -->
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;
    
    // Get shared components
    const { Header, Subheader, Footer, FormatSelector, Icons } = window.SocietyArts;
    const { API } = window.SocietyArts;
    const { Voice } = window.SocietyArts;
    const { StoryPanel } = window.SocietyArts;
    const { Variations } = window.SocietyArts;
    const { StyleData } = window.SocietyArts;

    function StoryBuilderApp() {
      // State
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [story, setStory] = useState('');
      const [title, setTitle] = useState(null);
      const [transformedStory, setTransformedStory] = useState(null);
      const [transformLabel, setTransformLabel] = useState(null);
      const [selectedStyles, setSelectedStyles] = useState([]);
      const [aspectRatio, setAspectRatio] = useState('1:1');
      const [hasStarted, setHasStarted] = useState(false);
      const [voiceMode, setVoiceMode] = useState(false);
      const [styleFinderOpen, setStyleFinderOpen] = useState(false);
      
      const messagesEndRef = useRef(null);
      const extractionTimeoutRef = useRef(null);

      // Voice callbacks
      const handleVoiceUserMessage = useCallback((content) => {
        if (!hasStarted) setHasStarted(true);
        setMessages(prev => [...prev, { role: 'user', content }]);
      }, [hasStarted]);

      const handleVoiceAssistantMessage = useCallback((content) => {
        setMessages(prev => [...prev, { role: 'assistant', content }]);
        
        if (extractionTimeoutRef.current) {
          clearTimeout(extractionTimeoutRef.current);
        }
        extractionTimeoutRef.current = setTimeout(() => {
          extractStoryFromConversation();
        }, 1000);
      }, []);

      // Voice Interface
      const voice = Voice.useVoiceInterface({
        onUserMessage: handleVoiceUserMessage,
        onAssistantMessage: handleVoiceAssistantMessage,
      });

      // Extract story from voice conversation
      const extractStoryFromConversation = async () => {
        const conversationText = messages.map(m => `${m.role}: ${m.content}`).join('\n');
        if (conversationText.length < 50) return;

        try {
          const data = await API.callClaude([{
            role: 'user',
            content: `${API.prompts.storyExtraction}\n\nConversation:\n${conversationText}`
          }], 500);

          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            if (parsed) {
              if (parsed.title && !title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
            }
          }
        } catch (err) {
          console.error('Story extraction error:', err);
        }
      };

      // Scroll to bottom
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Re-extract when messages change
      useEffect(() => {
        if (voiceMode && messages.length >= 4 && messages.length % 2 === 0) {
          extractStoryFromConversation();
        }
      }, [messages, voiceMode]);

      // Handlers
      const handleNewProject = () => {
        setMessages([]);
        setInputValue('');
        setIsLoading(false);
        setStory('');
        setTitle(null);
        setTransformedStory(null);
        setTransformLabel(null);
        setSelectedStyles([]);
        setAspectRatio('1:1');
        setHasStarted(false);
        setVoiceMode(false);
        voice.disconnect();
      };

      const toggleVoiceMode = async (enable) => {
        if (!enable && voiceMode) {
          voice.disconnect();
          setVoiceMode(false);
        } else if (enable && !voiceMode) {
          try {
            setVoiceMode(true); // Show voice UI immediately
            setHasStarted(true);
            await voice.connect();
          } catch (err) {
            console.error('Failed to enable voice mode:', err);
            setVoiceMode(false);
            alert('Failed to connect to voice service. Please try again.');
          }
        }
      };

      // Auto-start listening when voice connects
      useEffect(() => {
        if (voiceMode && voice.isConnected && !voice.isListening && !voice.isSpeaking) {
          const timer = setTimeout(() => {
            voice.startListening();
          }, 300);
          return () => clearTimeout(timer);
        }
      }, [voiceMode, voice.isConnected]);

      const sendMessage = async () => {
        if (!inputValue.trim() || isLoading) return;

        if (!hasStarted) setHasStarted(true);

        const userMessage = { role: 'user', content: inputValue };
        const updatedMessages = [...messages, userMessage];
        setMessages(updatedMessages);
        setInputValue('');
        setIsLoading(true);

        try {
          let contextMessage = '';
          if (story) {
            contextMessage = `\n\n[CURRENT STORY STATE: "${story}"]\n[CURRENT TITLE: "${title || 'None yet'}"]\n\nIf the user is requesting a modification, update the story accordingly.`;
          }

          const userPrompt = updatedMessages.map(m => `${m.role}: ${m.content}`).join('\n');

          const data = await API.callClaude([{ 
            role: 'user', 
            content: `${API.prompts.storyBuilder}${contextMessage}\n\n---\nConversation so far:\n${userPrompt}\n\nRespond as the assistant with valid JSON only.`
          }]);
          
          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            
            if (parsed) {
              if (parsed.title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: parsed.message || "I'd love to hear more about your vision!"
              }]);
            } else {
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: data.content[0].text
              }]);
            }
          }
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I apologize, but I'm having trouble connecting right now. Please try again in a moment."
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      // Handle variation applied - updates the transformed story
      const handleVariationApplied = (newStory, label) => {
        setTransformedStory(newStory);
        setTransformLabel(label);
      };

      // Clear transformation and go back to original
      const handleClearTransform = () => {
        setTransformedStory(null);
        setTransformLabel(null);
      };

      const toggleStyle = (styleId) => {
        setSelectedStyles(prev => {
          if (prev.includes(styleId)) {
            return prev.filter(id => id !== styleId);
          }
          if (prev.length >= 4) {
            return prev; // Max 4 styles
          }
          return [...prev, styleId];
        });
      };

      // Get sample styles for display
      const displayStyles = StyleData.SAMPLE_STYLES.slice(0, 4);

      // Calculate progress
      const hasStory = story && story.trim().length > 0;
      const progress = hasStory 
        ? (selectedStyles.length > 0 ? 100 : 50) 
        : (hasStarted ? 15 : 5);

      return (
        <div className="page-container">
          <Header 
            currentPage="story-builder" 
            onNewProject={handleNewProject}
            onOpenStyleFinder={() => setStyleFinderOpen(true)}
          />
          
          <Subheader 
            title="Your Story, Your Style"
            description="First add your story, then select your styles. When both are done, hit Create and watch your idea come alive."
            progress={progress}
          />
          
          <main className="main-content story-builder-layout">
            {/* Left Column - Story Panel */}
            <StoryPanel.StoryPanel
              story={story}
              title={title}
              isVoiceMode={voiceMode}
              isLoading={isLoading}
              transformedStory={transformedStory}
              transformLabel={transformLabel}
              onVariationApplied={handleVariationApplied}
              onClearTransform={handleClearTransform}
              onStoryChange={(newStory) => {
                // If editing transformed story, clear transform first
                if (transformedStory) {
                  setTransformedStory(newStory);
                } else {
                  setStory(newStory);
                }
              }}
            />
            
            {/* Center Column - Chat */}
            <div className="chat-container">
              {title && (
                <div className="chat-title-bar">
                  <span>{title}</span>
                  <Icons.chevronDown />
                </div>
              )}
              
              <div className="messages-container">
                {!hasStarted ? (
                  <div className="welcome-container">
                    <h2 className="welcome-title">Welcome to Society Arts.</h2>
                    <p className="welcome-text">
                      I'm here to help create your beautiful work of art from your own idea or personal story. Let me know when you're ready to begin.
                    </p>
                    <Voice.UnifiedInput
                      voiceMode={voiceMode}
                      onToggleMode={toggleVoiceMode}
                      inputValue={inputValue}
                      onInputChange={setInputValue}
                      onSendMessage={sendMessage}
                      isLoading={isLoading}
                      voice={voice}
                      placeholder="Start your story..."
                    />
                  </div>
                ) : (
                  <>
                    {messages.map((msg, index) => (
                      <div key={index} className={`message message-${msg.role}`}>
                        <div className={`message-bubble message-bubble-${msg.role}`}>
                          {msg.content}
                        </div>
                      </div>
                    ))}
                    {(isLoading || (voiceMode && voice.isListening)) && (
                      <div className="message message-assistant">
                        <div className="typing-indicator">
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </>
                )}
              </div>
              
              {hasStarted && (
                <div className="chat-input-area">
                  <Voice.UnifiedInput
                    voiceMode={voiceMode}
                    onToggleMode={toggleVoiceMode}
                    inputValue={inputValue}
                    onInputChange={setInputValue}
                    onSendMessage={sendMessage}
                    isLoading={isLoading}
                    voice={voice}
                    placeholder="Continue your story..."
                  />
                </div>
              )}
            </div>
            
            {/* Right Column - Styles */}
            <div className="styles-column">
              <FormatSelector 
                value={aspectRatio}
                onChange={setAspectRatio}
              />
              
              <div className="styles-grid">
                {displayStyles.map((style) => (
                  <div 
                    key={style.id}
                    className={`style-card ${selectedStyles.includes(style.id) ? 'style-card-selected' : ''}`}
                    onClick={() => toggleStyle(style.id)}
                  >
                    <div className="style-card-image">
                      <img src={style.thumbnail} alt={style.name} />
                      <button className="style-card-menu" onClick={(e) => e.stopPropagation()}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <circle cx="12" cy="5" r="2"></circle>
                          <circle cx="12" cy="12" r="2"></circle>
                          <circle cx="12" cy="19" r="2"></circle>
                        </svg>
                      </button>
                    </div>
                    <p className="style-card-name">{style.name}</p>
                  </div>
                ))}
                
                <button 
                  className="add-style-btn"
                  onClick={() => setStyleFinderOpen(true)}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Add Style
                </button>
              </div>
            </div>
          </main>
          
          <Footer onNewChat={handleNewProject}>
            <button className="btn btn-secondary">Save Project</button>
            <button 
              className="btn btn-primary"
              style={{ opacity: story && selectedStyles.length > 0 ? 1 : 0.6 }}
              disabled={!story || selectedStyles.length === 0}
            >
              Create
              <Icons.arrowRight />
            </button>
          </Footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StoryBuilderApp />);
  </script>
</body>
</html>
