<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Builder - Society Arts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts - Familjen Grotesk + Domine -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/modals.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  <link rel="stylesheet" href="/css/auth.css">
  
  <style>
    /* Story Builder - Fixed Layout with only chat scrolling */
    .page-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding-left: var(--sidebar-width-collapsed, 50px);
      padding-top: var(--logo-bar-height, 48px);
    }
    
    /* Story Builder Layout - 3 columns with proportional sizing */
    .story-builder-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(400px, 2fr) minmax(280px, 1fr);
      gap: var(--space-xl);
      padding: var(--space-xl) var(--space-2xl);
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    /* Panel Headers - Unified style for all 3 columns */
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px var(--space-xl);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border-light);
      position: relative;
      margin: 0;
    }
    
    .panel-header-active {
      background: #3E2318;
      color: #FAF8F5;
      border-bottom: none;
    }
    
    .panel-header-active .panel-header-title {
      color: #FAF8F5;
    }
    
    .panel-header-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
      text-align: center;
    }
    
    .panel-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0.7;
    }
    
    .panel-info-btn:hover,
    .panel-info-btn.active {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }
    
    .panel-header-active .panel-info-btn {
      opacity: 0.8;
    }
    
    .panel-header-active .panel-info-btn:hover,
    .panel-header-active .panel-info-btn.active {
      opacity: 1;
      background: rgba(255,255,255,0.15);
    }
    
    /* Info icon - uses fill for better visibility */
    .panel-info-btn svg,
    .chat-info-btn svg,
    .styles-info-btn svg {
      width: 20px;
      height: 20px;
    }
    
    /* Dark header - white icon */
    .panel-header-active .panel-info-btn svg {
      fill: #FAF8F5;
    }
    
    /* Light header - dark icon */
    .panel-info-btn svg {
      fill: var(--color-text-secondary);
    }
    
    /* Panel Info Tooltip - positioned below icon */
    .panel-info-tooltip {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      z-index: 9999;
      width: 300px;
    }
    
    .panel-info-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.2);
      border: 1px solid var(--color-border-light);
    }
    
    .panel-info-content h4 {
      font-family: 'Domine', var(--font-serif);
      font-size: 16px;
      font-weight: 600;
      color: #3E2318;
      margin: 0 0 var(--space-sm) 0;
    }
    
    .panel-info-content p {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin: 0 0 var(--space-md) 0;
      line-height: 1.6;
    }
    
    .panel-info-content p:last-of-type {
      margin-bottom: var(--space-md);
    }
    
    .panel-info-content ul {
      margin: 0 0 var(--space-md) 0;
      padding-left: var(--space-lg);
      font-size: 14px;
      color: var(--color-text-secondary);
      line-height: 1.6;
    }
    
    .panel-info-content li {
      margin-bottom: var(--space-xs);
    }
    
    .panel-info-close {
      background: var(--color-tan-10);
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: background 0.15s;
      color: var(--color-text-primary);
    }
    
    .panel-info-close:hover {
      background: var(--color-tan-20);
    }

    /* Chat panel info button */
    .chat-info-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0.7;
    }
    
    .chat-info-btn:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }
    
    .chat-title-bar .chat-info-btn {
      opacity: 0.8;
    }
    
    .chat-title-bar .chat-info-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.15);
    }
    
    .chat-title-bar .chat-info-btn svg {
      fill: #FAF8F5;
    }
    
    .chat-title-bar-empty .chat-info-btn svg {
      fill: var(--color-text-secondary);
    }
    
    /* Styles panel info button */
    .styles-info-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0.8;
    }
    
    .styles-info-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.15);
    }
    
    .styles-info-btn svg {
      fill: #FAF8F5;
    }
    
    /* Styles info tooltip */
    .styles-info-tooltip {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      z-index: 9999;
      width: 300px;
    }
    
    .styles-info-tooltip .panel-info-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.2);
      border: 1px solid var(--color-border-light);
    }
    
    /* Story badges moved inside card content */
    .story-badges {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
      min-height: 24px;
    }
    
    /* Variation Tooltips */
    .variation-btn-wrapper {
      position: relative;
    }
    
    .variation-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: 240px;
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.2);
      border: 1px solid var(--color-border-light);
      z-index: 100;
      pointer-events: none;
    }
    
    .variation-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: white;
    }
    
    .variation-tooltip-title {
      font-weight: var(--weight-semibold);
      font-size: var(--text-sm);
      margin-bottom: var(--space-xs);
      color: var(--color-text-primary);
    }
    
    .variation-tooltip-desc {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }
    
    /* Left and Right panels - no scroll, fixed content */
    .story-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      overflow-y: auto;
      min-width: 0;
      padding: 0;
      max-height: 100%;
    }
    
    /* Story Card adjustments - MUST override .card padding */
    .card.story-card {
      border-radius: var(--radius-lg);
      overflow: visible;
      background: var(--color-tan-10);
      padding: 0 !important; /* Override .card padding so header fills full width */
      border: none;
    }
    
    .story-card .card-content {
      padding: var(--space-md) var(--space-lg) var(--space-lg);
      background: var(--color-tan-10);
    }
    
    /* Variation selector adjustments - MUST override any inherited padding */
    .variation-selector {
      background: var(--color-tan-10);
      border-radius: var(--radius-lg);
      overflow: visible;
      padding: 0 !important;
    }
    
    .variation-selector .panel-header {
      margin-bottom: 0;
    }
    
    .variation-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-sm);
      padding: var(--space-md);
    }
    
    /* Chat Container - this is what scrolls */
    .chat-container {
      background-color: var(--color-tan-10);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 100%;
      overflow: hidden;
    }
    
    .chat-title-bar {
      padding: 14px var(--space-xl);
      border-bottom: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
      flex-shrink: 0;
      position: relative;
      background: #3E2318;
      color: #FAF8F5;
      margin: 0;
    }
    
    .chat-title-bar .chat-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #FAF8F5;
      opacity: 0.8;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .chat-title-bar .chat-info-btn:hover {
      opacity: 1;
    }
    
    /* Empty chat title bar (no title yet) */
    .chat-title-bar-empty {
      padding: 14px var(--space-xl);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text-muted);
      flex-shrink: 0;
      position: relative;
      background: var(--color-surface-alt);
      margin: 0;
    }
    
    .chat-title-bar-empty .chat-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .chat-title-bar-empty .chat-info-btn:hover {
      color: var(--color-text-primary);
      background: var(--color-surface-hover);
    }
    
    .voice-mode-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-xl);
      background-color: var(--color-surface-hover);
      border-bottom: 1px solid var(--color-border-dark);
      flex-shrink: 0;
    }
    
    .voice-mode-text {
      font-size: 14px;
      color: var(--color-text-secondary);
      font-weight: var(--weight-medium);
    }
    
    /* Messages - THIS is the scrollable area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    /* Styles Column - with panel header */
    .styles-column {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-width: 0;
      padding: 0; /* No padding so header fills edge-to-edge */
      background: var(--color-tan-10);
      border-radius: var(--radius-lg);
    }
    
    .styles-panel-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px var(--space-xl);
      position: relative;
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border-light);
      margin: 0;
    }
    
    .styles-panel-header.has-styles {
      background: #3E2318;
      color: #FAF8F5;
      border-bottom: none;
    }
    
    .styles-panel-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: 500;
    }
    
    .styles-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0.7;
    }
    
    .styles-info-btn:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }
    
    .styles-info-btn svg {
      fill: var(--color-text-secondary);
    }
    
    .styles-panel-header.has-styles .styles-info-btn {
      opacity: 0.8;
    }
    
    .styles-panel-header.has-styles .styles-info-btn:hover {
      background: rgba(255,255,255,0.15);
    }
    
    .styles-panel-header.has-styles .styles-info-btn svg {
      fill: #FAF8F5;
    }
    
    .styles-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      padding: var(--space-md);
    }
    
    .style-list-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid transparent;
    }
    
    .style-list-item:hover {
      transform: scale(1.02);
    }
    
    .style-list-item.selected {
      border-color: var(--color-accent);
    }
    
    .style-list-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .style-list-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-sm) var(--space-md);
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
    }
    
    .style-list-name {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .style-remove-btn {
      position: absolute;
      top: var(--space-xs);
      right: var(--space-xs);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      opacity: 0;
      transition: all 0.2s;
    }
    
    .style-list-item:hover .style-remove-btn {
      opacity: 1;
    }
    
    .style-remove-btn:hover {
      background: white;
      color: #dc2626;
    }
    
    .add-style-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-xl);
      background: var(--color-surface);
      border: 2px dashed var(--color-border-medium);
      border-radius: var(--radius-lg);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      aspect-ratio: 1;
    }
    
    .add-style-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-light);
    }
    
    .styles-count {
      text-align: center;
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      padding: var(--space-sm) 0 var(--space-md);
    }
    
    /* Footer - fixed at bottom */
    .app-footer {
      flex-shrink: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .story-builder-layout {
        grid-template-columns: minmax(240px, 1fr) minmax(350px, 2fr) minmax(240px, 1fr);
        gap: var(--space-lg);
        padding: var(--space-lg);
      }
    }
    
    @media (max-width: 900px) {
      .story-builder-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
    }
    
    /* ========================================
       STYLE PICKER MODAL
       ======================================== */
    
    .style-picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(62, 35, 24, 0.6);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .style-picker-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 64px rgba(62, 35, 24, 0.3);
    }
    
    /* Modal Header */
    .style-picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border-light);
      background: #3E2318;
      color: #FAF8F5;
    }
    
    .style-picker-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: 500;
    }
    
    .style-picker-close {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #FAF8F5;
      transition: background 0.15s;
    }
    
    .style-picker-close:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* Style Finder Type Tabs */
    .style-picker-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-border-light);
      background: var(--color-tan-10);
    }
    
    .style-picker-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-muted);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
    }
    
    .style-picker-tab:hover {
      background: var(--color-tan-20);
      color: var(--color-text-primary);
    }
    
    .style-picker-tab.active {
      background: #3E2318;
      color: #FAF8F5;
    }
    
    .style-picker-tab.coming-soon {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .style-picker-tab.coming-soon::after {
      content: 'Soon';
      font-size: 10px;
      background: var(--color-tan-40);
      color: var(--color-text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    /* Modal Body */
    .style-picker-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Sidebar Facets */
    .style-picker-sidebar {
      width: 260px;
      border-right: 1px solid var(--color-border-light);
      overflow-y: auto;
      flex-shrink: 0;
      background: white;
    }
    
    .sp-search {
      padding: 16px;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .sp-search-input {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--color-tan-10);
      border-radius: 24px;
      padding: 10px 14px;
      width: 100%;
    }
    
    .sp-search-input svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    
    .sp-search-input input {
      border: none;
      background: transparent;
      font-size: 14px;
      outline: none;
      width: 100%;
      color: var(--color-text-primary);
    }
    
    .sp-search-input input::placeholder {
      color: var(--color-text-muted);
    }
    
    /* Facet Categories */
    .sp-facets {
      padding: 8px 0;
    }
    
    .sp-category {
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .sp-category:last-child {
      border-bottom: none;
    }
    
    .sp-category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    
    .sp-category-header:hover {
      background: var(--color-tan-10);
    }
    
    .sp-category-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sp-category-header svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      transition: transform 0.2s;
    }
    
    .sp-category.open .sp-category-header svg {
      transform: rotate(90deg);
    }
    
    .sp-category-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-primary);
    }
    
    .sp-category-count {
      font-size: 12px;
      color: var(--color-text-muted);
      background: var(--color-tan-10);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .sp-category-items {
      display: none;
      padding: 0 16px 12px 16px;
    }
    
    .sp-category.open .sp-category-items {
      display: block;
    }
    
    .sp-facet-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0 8px 24px;
      cursor: pointer;
      font-size: 13px;
      color: var(--color-text-secondary);
      transition: color 0.15s;
    }
    
    .sp-facet-item:hover {
      color: var(--color-accent);
    }
    
    .sp-facet-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-tan-40);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    
    .sp-facet-item.selected .sp-facet-checkbox {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }
    
    .sp-facet-item.selected .sp-facet-checkbox svg {
      display: block;
    }
    
    .sp-facet-checkbox svg {
      width: 10px;
      height: 10px;
      color: white;
      display: none;
    }
    
    /* Grid Area */
    .style-picker-grid-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--color-surface);
    }
    
    .sp-grid-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .sp-results-count {
      font-size: 14px;
      color: var(--color-text-muted);
    }
    
    .sp-reset-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: color 0.15s;
    }
    
    .sp-reset-btn:hover {
      color: var(--color-text-primary);
    }
    
    .sp-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    
    @media (max-width: 1100px) {
      .sp-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .sp-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .style-picker-sidebar {
        display: none;
      }
    }
    
    /* Style Card in Modal */
    .sp-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .sp-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(62, 35, 24, 0.15);
    }
    
    .sp-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .sp-card-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(transparent 50%, rgba(0,0,0,0.5));
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .sp-card:hover .sp-card-overlay {
      opacity: 1;
    }
    
    .sp-card-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .sp-card:hover .sp-card-name {
      opacity: 1;
    }
    
    /* Selected State */
    .sp-card.selected {
      box-shadow: 0 0 0 3px var(--color-accent);
    }
    
    .sp-card-selected-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: var(--color-accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s;
    }
    
    .sp-card.selected .sp-card-selected-badge {
      opacity: 1;
      transform: scale(1);
    }
    
    .sp-card-selected-badge svg {
      width: 16px;
      height: 16px;
      color: white;
    }

    /* ========================================
       ENHANCED STYLE PICKER - MAXIMIZE MODE
       ======================================== */
    
    .style-picker-modal.maximized {
      max-width: calc(100vw - 32px);
      max-height: calc(100vh - 32px);
      width: calc(100vw - 32px);
      height: calc(100vh - 32px);
      border-radius: 8px;
    }
    
    .style-picker-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sp-maximize-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #FAF8F5;
      transition: background 0.15s;
    }
    
    .sp-maximize-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ========================================
       GRID DENSITY SELECTOR
       ======================================== */
    
    .sp-grid-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .sp-density-selector {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--color-tan-10);
      padding: 4px;
      border-radius: 8px;
    }
    
    .sp-density-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 6px 10px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sp-density-btn:hover {
      background: var(--color-tan-20);
    }
    
    .sp-density-btn.active {
      background: #3E2318;
    }
    
    .sp-density-btn .density-dot {
      width: 6px;
      height: 6px;
      background: var(--color-text-muted);
      border-radius: 2px;
    }
    
    .sp-density-btn.active .density-dot {
      background: #FAF8F5;
    }

    /* Grid density variations */
    .sp-grid.density-2 {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .sp-grid.density-3 {
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .sp-grid.density-4 {
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    /* ========================================
       ENHANCED CARD UI - INTERACTION ZONES
       ======================================== */
    
    .sp-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .sp-card-checkbox {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.9);
      border: 2px solid var(--color-tan-40);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.15s;
      opacity: 0;
    }
    
    .sp-card:hover .sp-card-checkbox,
    .sp-card.selected .sp-card-checkbox {
      opacity: 1;
    }
    
    .sp-card-checkbox:hover {
      background: white;
      border-color: var(--color-accent);
    }
    
    .sp-card-checkbox.checked {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }
    
    .sp-card-checkbox svg {
      width: 14px;
      height: 14px;
      color: white;
      opacity: 0;
    }
    
    .sp-card-checkbox.checked svg {
      opacity: 1;
    }
    
    .sp-card-heart {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.15s;
      opacity: 0;
    }
    
    .sp-card:hover .sp-card-heart,
    .sp-card-heart.favorited {
      opacity: 1;
    }
    
    .sp-card-heart:hover {
      background: white;
      transform: scale(1.1);
    }
    
    .sp-card-heart svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      transition: all 0.15s;
    }
    
    .sp-card-heart:hover svg {
      color: #E53E3E;
    }
    
    .sp-card-heart.favorited svg {
      color: #E53E3E;
      fill: #E53E3E;
    }
    
    .sp-card-kebab {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.15s;
      opacity: 0;
    }
    
    .sp-card:hover .sp-card-kebab {
      opacity: 1;
    }
    
    .sp-card-kebab:hover {
      background: white;
    }
    
    .sp-card-kebab svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-secondary);
    }
    
    .sp-card-image-zone {
      position: absolute;
      inset: 0;
      z-index: 5;
    }

    /* ========================================
       KEBAB DROPDOWN MENU
       ======================================== */
    
    .sp-kebab-menu {
      position: absolute;
      bottom: 40px;
      right: 0;
      min-width: 200px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(62, 35, 24, 0.2);
      z-index: 1050;
      overflow: hidden;
      animation: menuFadeIn 0.15s ease-out;
    }
    
    @keyframes menuFadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .sp-kebab-menu-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--color-border-light);
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .sp-kebab-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .sp-kebab-menu-item:hover {
      background: var(--color-tan-10);
      color: var(--color-text-primary);
    }
    
    .sp-kebab-menu-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    
    .sp-kebab-menu-item.danger {
      color: #C53030;
    }
    
    .sp-kebab-menu-item.danger:hover {
      background: #FFF5F5;
    }
    
    .sp-kebab-menu-divider {
      height: 1px;
      background: var(--color-border-light);
      margin: 4px 0;
    }

    /* ========================================
       STYLE DETAIL OVERLAY
       ======================================== */
    
    .style-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(62, 35, 24, 0.7);
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      animation: overlayFadeIn 0.2s ease-out;
    }
    
    @keyframes overlayFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .style-detail-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1000px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 24px 64px rgba(62, 35, 24, 0.3);
      animation: modalSlideIn 0.25s ease-out;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .style-detail-floating-btns {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    
    .style-detail-floating-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 2px 8px rgba(62, 35, 24, 0.15);
    }
    
    .style-detail-floating-btn:hover {
      background: var(--color-tan-10);
      transform: scale(1.05);
    }
    
    .style-detail-floating-btn svg {
      width: 18px;
      height: 18px;
      color: var(--color-text-secondary);
    }
    
    .style-detail-floating-btn.heart svg {
      color: var(--color-text-muted);
    }
    
    .style-detail-floating-btn.heart:hover svg {
      color: #E53E3E;
    }
    
    .style-detail-floating-btn.heart.favorited svg {
      color: #E53E3E;
      fill: #E53E3E;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .style-detail-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .style-detail-info {
      width: 280px;
      min-width: 280px;
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--color-border-light);
      overflow-y: auto;
    }
    
    .style-detail-images {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: var(--color-tan-10);
      display: flex;
      flex-direction: column;
    }
    
    .style-detail-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      flex: 1;
    }
    
    .style-detail-grid-id {
      text-align: center;
      font-size: 13px;
      color: var(--color-text-muted);
      margin-top: 16px;
      letter-spacing: 0.5px;
    }
    
    .style-detail-grid-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.15s;
    }
    
    .style-detail-grid-item:hover {
      transform: scale(1.03);
    }
    
    .style-detail-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .style-detail-name {
      font-family: 'Domine', var(--font-serif);
      font-size: 26px;
      font-weight: 700;
      color: #C53D2E;
      margin-bottom: 20px;
      line-height: 1.25;
    }
    
    .style-detail-description {
      font-size: 14px;
      line-height: 1.7;
      color: var(--color-text-secondary);
      flex: 1;
    }
    
    .style-detail-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: auto;
      padding-top: 24px;
    }
    
    .style-detail-btn-primary {
      width: 100%;
      padding: 14px 20px;
      border: none;
      background: #C53D2E;
      color: white;
      font-size: 14px;
      font-weight: 600;
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .style-detail-btn-primary:hover {
      background: #A82A10;
    }
    
    .style-detail-btn-primary.remove {
      background: #C53030;
    }
    
    .style-detail-btn-primary.remove:hover {
      background: #9B2C2C;
    }
    
    .style-detail-btn-secondary {
      width: 100%;
      padding: 14px 20px;
      border: 1px solid var(--color-border-medium);
      background: white;
      color: var(--color-text-primary);
      font-size: 14px;
      font-weight: 500;
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .style-detail-btn-secondary:hover {
      background: var(--color-tan-10);
      border-color: var(--color-text-muted);
    }
    
    .style-detail-admin {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--color-border-light);
    }
    
    .style-detail-admin-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .style-detail-admin-btn {
      padding: 10px 16px;
      border: 1px solid var(--color-border-medium);
      background: white;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .style-detail-admin-btn:hover {
      background: var(--color-tan-10);
      color: var(--color-text-primary);
    }
    
    .style-detail-admin-btn.danger {
      border-color: #FEB2B2;
      color: #C53030;
    }
    
    .style-detail-admin-btn.danger:hover {
      background: #FFF5F5;
    }

    /* ========================================
       IMAGE VIEWER LIGHTBOX
       ======================================== */
    
    .image-viewer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      z-index: 1200;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: overlayFadeIn 0.2s ease-out;
    }
    
    .image-viewer-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border: none;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      z-index: 10;
    }
    
    .image-viewer-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .image-viewer-close svg {
      width: 24px;
      height: 24px;
      color: white;
    }
    
    .image-viewer-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 60px 80px;
      position: relative;
    }
    
    .image-viewer-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      z-index: 10;
    }
    
    .image-viewer-nav:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .image-viewer-nav svg {
      width: 24px;
      height: 24px;
      color: white;
    }
    
    .image-viewer-nav.prev {
      left: 20px;
    }
    
    .image-viewer-nav.next {
      right: 20px;
    }
    
    .image-viewer-container {
      max-width: 90vw;
      max-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: grab;
    }
    
    .image-viewer-container:active {
      cursor: grabbing;
    }
    
    .image-viewer-container img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      transition: transform 0.1s ease-out;
      user-select: none;
      -webkit-user-drag: none;
    }
    
    .image-viewer-footer {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .image-viewer-dots {
      display: flex;
      gap: 8px;
    }
    
    .image-viewer-dot {
      width: 10px;
      height: 10px;
      border: none;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .image-viewer-dot:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .image-viewer-dot.active {
      background: white;
    }
    
    .image-viewer-counter {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    /* ========================================
       RESPONSIVE ADJUSTMENTS
       ======================================== */
    
    @media (max-width: 900px) {
      .sp-density-selector {
        display: none;
      }
      
      .sp-grid.density-2,
      .sp-grid.density-3,
      .sp-grid.density-4 {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .sp-maximize-btn {
        display: none;
      }
      
      .style-detail-grid {
        gap: 6px;
      }
      
      .style-detail-actions {
        flex-direction: column;
      }
      
      .style-detail-btn-primary,
      .style-detail-btn-secondary {
        min-width: auto;
      }
      
      .image-viewer-nav {
        width: 40px;
        height: 40px;
      }
      
      .image-viewer-nav.prev {
        left: 10px;
      }
      
      .image-viewer-nav.next {
        right: 10px;
      }
    }
    
    /* Loading */
    .sp-loading {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }
    
    .sp-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-tan-20);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    /* Modal Footer */
    .style-picker-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-top: 1px solid var(--color-border-light);
      background: white;
    }
    
    .sp-selection-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .sp-selection-count {
      font-size: 14px;
      color: var(--color-text-secondary);
    }
    
    .sp-selection-count strong {
      color: var(--color-accent);
    }
    
    .sp-selected-previews {
      display: flex;
      gap: 4px;
    }
    
    .sp-selected-preview {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid var(--color-accent);
    }
    
    .sp-selected-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .sp-footer-actions {
      display: flex;
      gap: 12px;
    }
    
    .sp-cancel-btn {
      padding: 10px 24px;
      border: 1px solid var(--color-border-medium);
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sp-cancel-btn:hover {
      background: var(--color-tan-10);
    }
    
    .sp-done-btn {
      padding: 10px 24px;
      border: none;
      background: var(--color-accent);
      font-size: 14px;
      font-weight: 500;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sp-done-btn:hover {
      background: var(--color-accent-hover, #A82A10);
    }
    
    .sp-done-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Welcome State */
    .welcome-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-4xl) 30px;
    }
    
    .welcome-title {
      font-family: var(--font-serif);
      font-size: var(--text-2xl);
      font-weight: var(--weight-normal);
      color: var(--color-text-primary);
      margin-bottom: var(--space-lg);
      letter-spacing: var(--tracking-wider);
    }
    
    .welcome-text {
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      color: var(--color-text-muted);
      max-width: 380px;
      margin: 0;
    }
    
    .chat-input-area {
      padding: var(--space-lg) var(--space-xl);
      border-top: 1px solid var(--color-border-dark);
      flex-shrink: 0;
      display: flex;
      justify-content: center;
    }
    
    /* ========================================
       ChatGPT-STYLE INPUT SYSTEM
       ======================================== */
    
    .chat-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      background: var(--color-surface);
      border: 1px solid var(--color-border-medium);
      border-radius: 24px;
      padding: 8px 12px;
      transition: all 0.2s;
    }
    
    .chat-input-wrapper:focus-within {
      border-color: var(--color-border-dark);
      box-shadow: 0 0 0 2px rgba(62, 35, 24, 0.08);
    }
    
    /* Text Input Field */
    .chat-text-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: var(--text-base);
      padding: 8px 4px;
      background: transparent;
      min-width: 0;
    }
    
    .chat-text-input::placeholder {
      color: var(--color-text-muted);
    }
    
    /* Icon Buttons (Plus, Dictate, Speaker, Mic) */
    .input-icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      transition: all 0.15s;
      flex-shrink: 0;
      position: relative;
    }
    
    .input-icon-btn:hover {
      background: var(--color-tan-10);
      color: var(--color-text-primary);
    }
    
    .input-icon-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    /* Plus Button */
    .input-icon-btn.plus-btn {
      color: var(--color-text-secondary);
    }
    
    /* Dictate Button */
    .input-icon-btn.dictate-btn.active {
      color: var(--color-accent);
      background: var(--color-accent-light);
    }
    
    .dictate-pulse {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid var(--color-accent);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.4); opacity: 0; }
    }
    
    /* Speaker/Mic Muted State */
    .input-icon-btn.muted {
      color: #dc2626;
    }
    
    /* Voice Mode Button (Waveform) */
    .voice-mode-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--color-text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .voice-mode-btn:hover {
      background: var(--color-brown);
      transform: scale(1.05);
    }
    
    /* Voice End Button (Red with dots) */
    .voice-end-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      background: #dc2626;
      color: white;
      font-size: 14px;
      font-weight: var(--weight-medium);
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .voice-end-btn:hover {
      background: #b91c1c;
    }
    
    .voice-end-dots {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .voice-end-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: white;
      animation: dot-pulse 1s ease-in-out infinite;
    }
    
    .voice-end-dots span:nth-child(1) { animation-delay: 0s; }
    .voice-end-dots span:nth-child(2) { animation-delay: 0.15s; }
    .voice-end-dots span:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes dot-pulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    .voice-end-text {
      font-weight: var(--weight-semibold);
    }
    
    /* Future Feature Modal */
    .future-modal {
      max-width: 360px;
      text-align: center;
    }
    
    .future-modal h3 {
      font-family: var(--font-serif);
      font-size: var(--text-xl);
      margin-bottom: var(--space-md);
    }
    
    .future-modal p {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-lg);
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared/supabase-client.js"></script>
  
  <!-- Shared Components -->
  <script src="/js/shared/api.js"></script>
  <script src="/js/shared/auth.js"></script>
  <script src="/js/shared/projects.js"></script>
  <script src="/js/shared/header.js"></script>
  <script type="text/babel" src="/js/variations/variations.js"></script>
  <script type="text/babel" src="/js/story-builder/voice.js"></script>
  <script type="text/babel" src="/js/story-builder/story-panel.js"></script>
  <script src="/js/style-finder/style-data.js"></script>
  
  <!-- Story Builder App -->
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // ============================================
    // STYLE PICKER MODAL COMPONENT
    // ============================================
    
    // Medium categories for faceted navigation - uses AMD codes from art_mediums table
    const MEDIUM_CATEGORIES = {
      painting: {
        name: 'Painting',
        mediums: [
          { id: 'AMD001', name: 'Bold Paint (Oil/Acrylic)' },
          { id: 'AMD002', name: 'Fluid Paint (Watercolor)' },
          { id: 'AMD003', name: 'Flat Paint (Poster/Gouache)' }
        ]
      },
      drawing: {
        name: 'Drawing',
        mediums: [
          { id: 'AMD004', name: 'Sketch (Pencil/Graphite)' },
          { id: 'AMD005', name: 'Bold Line (Ink/Charcoal)' },
          { id: 'AMD006', name: 'Color Drawing (Pastel/Colored Pencil)' }
        ]
      },
      photography: {
        name: 'Photography',
        mediums: [
          { id: 'AMD007', name: 'Color Photography' },
          { id: 'AMD008', name: 'Black & White Photography' }
        ]
      },
      printmaking: {
        name: 'Printmaking',
        mediums: [
          { id: 'AMD009', name: 'Bold Carved Print (Woodcut/Linocut)' },
          { id: 'AMD010', name: 'Fine Line Print (Etching/Engraving)' },
          { id: 'AMD011', name: 'Poster Print (Screenprint)' }
        ]
      },
      collage: {
        name: 'Collage / Mixed Media',
        mediums: [
          { id: 'AMD012', name: 'Paper Collage' },
          { id: 'AMD013', name: 'Photo Collage' },
          { id: 'AMD014', name: 'Mixed Layers' }
        ]
      }
    };

    // Overlay styles
    const OVERLAYS = [
      { id: 'abstract', name: 'Abstract' },
      { id: 'realistic', name: 'Realistic' },
      { id: 'cinematic', name: 'Cinematic' },
      { id: 'experimental', name: 'Experimental' },
      { id: 'minimalist', name: 'Minimalist' },
      { id: 'whimsical', name: 'Whimsical' },
      { id: 'illustration', name: 'Illustration' },
      { id: 'historic', name: 'Historic' }
    ];

    function StylePickerModal({ isOpen, onClose, selectedStyles, onStylesChange, maxStyles = 4 }) {
      const [allStyles, setAllStyles] = useState([]);
      const [filteredStyles, setFilteredStyles] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedMediums, setSelectedMediums] = useState(new Set());
      const [selectedOverlays, setSelectedOverlays] = useState(new Set());
      const [expandedCategories, setExpandedCategories] = useState(new Set(['painting', 'drawing']));
      const [activeTab, setActiveTab] = useState('browse'); // browse, ai-match, mood, color
      const [tempSelected, setTempSelected] = useState(new Set(selectedStyles));
      
      // New enhanced states
      const [isMaximized, setIsMaximized] = useState(() => {
        return localStorage.getItem('stylePickerMaximized') === 'true';
      });
      const [gridDensity, setGridDensity] = useState(() => {
        return parseInt(localStorage.getItem('stylePickerDensity')) || 3;
      });
      const [favorites, setFavorites] = useState(new Set());
      const [detailStyle, setDetailStyle] = useState(null); // Style object for detail overlay
      const [viewerImage, setViewerImage] = useState(null); // { styleId, imageIndex } for lightbox
      const [openKebab, setOpenKebab] = useState(null); // Style ID with open kebab menu
      const [isSuperAdmin, setIsSuperAdmin] = useState(false);

      // Load styles on mount
      useEffect(() => {
        if (isOpen) {
          loadStyles();
          loadFavorites();
          checkSuperAdmin();
          setTempSelected(new Set(selectedStyles));
        }
      }, [isOpen, selectedStyles]);

      // Filter styles when search/filters change
      useEffect(() => {
        filterStyles();
      }, [searchTerm, selectedMediums, selectedOverlays, allStyles]);

      // Save preferences to localStorage
      useEffect(() => {
        localStorage.setItem('stylePickerMaximized', isMaximized);
      }, [isMaximized]);

      useEffect(() => {
        localStorage.setItem('stylePickerDensity', gridDensity);
      }, [gridDensity]);

      // Close kebab menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (openKebab && !e.target.closest('.sp-kebab-menu') && !e.target.closest('.sp-card-kebab')) {
            setOpenKebab(null);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [openKebab]);

      // Keyboard handlers
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'Escape') {
            if (viewerImage) {
              setViewerImage(null);
            } else if (detailStyle) {
              setDetailStyle(null);
            } else if (isMaximized) {
              setIsMaximized(false);
            } else if (isOpen) {
              onClose();
            }
          }
          // Image viewer navigation
          if (viewerImage) {
            if (e.key === 'ArrowLeft') {
              navigateImage(-1);
            } else if (e.key === 'ArrowRight') {
              navigateImage(1);
            }
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [viewerImage, detailStyle, isMaximized, isOpen]);

      const checkSuperAdmin = async () => {
        try {
          const { supabase } = window.SocietyArts;
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            const { data: profile } = await supabase
              .from('user_profiles')
              .select('role')
              .eq('id', user.id)
              .single();
            setIsSuperAdmin(profile?.role === 'superadmin');
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
        }
      };

      const loadFavorites = async () => {
        try {
          const { supabase } = window.SocietyArts;
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            const { data } = await supabase
              .from('user_favorites')
              .select('style_id')
              .eq('user_id', user.id);
            if (data) {
              setFavorites(new Set(data.map(f => f.style_id)));
            }
          }
        } catch (error) {
          console.error('Error loading favorites:', error);
        }
      };

      const toggleFavorite = async (styleId, e) => {
        if (e) e.stopPropagation();
        try {
          const { supabase } = window.SocietyArts;
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;

          const newFavorites = new Set(favorites);
          if (favorites.has(styleId)) {
            await supabase
              .from('user_favorites')
              .delete()
              .eq('user_id', user.id)
              .eq('style_id', styleId);
            newFavorites.delete(styleId);
          } else {
            await supabase
              .from('user_favorites')
              .insert({ user_id: user.id, style_id: styleId });
            newFavorites.add(styleId);
          }
          setFavorites(newFavorites);
        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      };

      const toggleMaximize = () => {
        setIsMaximized(!isMaximized);
      };

      const handleHeaderDoubleClick = (e) => {
        if (e.target.closest('.style-picker-close') || e.target.closest('.sp-maximize-btn')) return;
        toggleMaximize();
      };

      const openStyleDetail = async (style, e) => {
        if (e) e.stopPropagation();
        // Load full style data including description
        try {
          const { supabase } = window.SocietyArts;
          const { data } = await supabase
            .from('styles')
            .select('*')
            .eq('id', style.id)
            .single();
          setDetailStyle(data || style);
        } catch (error) {
          setDetailStyle(style);
        }
        setOpenKebab(null);
      };

      const navigateImage = (direction) => {
        if (!viewerImage) return;
        let newIndex = viewerImage.imageIndex + direction;
        if (newIndex < 1) newIndex = 9;
        if (newIndex > 9) newIndex = 1;
        setViewerImage({ ...viewerImage, imageIndex: newIndex });
      };

      const handleKebabClick = (styleId, e) => {
        e.stopPropagation();
        setOpenKebab(openKebab === styleId ? null : styleId);
      };

      const handleAddToProject = (styleId, e) => {
        if (e) e.stopPropagation();
        toggleStyleSelection(styleId);
        setOpenKebab(null);
        if (detailStyle) setDetailStyle(null);
      };

      const handleFlagForReview = async (styleId) => {
        // TODO: Implement flag for review
        console.log('Flag for review:', styleId);
        setOpenKebab(null);
      };

      const handleUnlist = async (styleId) => {
        try {
          const { supabase } = window.SocietyArts;
          await supabase
            .from('styles')
            .update({ is_active: false })
            .eq('id', styleId);
          setAllStyles(allStyles.filter(s => s.id !== styleId));
          setFilteredStyles(filteredStyles.filter(s => s.id !== styleId));
          setDetailStyle(null);
          setOpenKebab(null);
        } catch (error) {
          console.error('Error unlisting style:', error);
        }
      };

      const handleEdit = (styleId) => {
        // TODO: Implement edit functionality
        console.log('Edit style:', styleId);
        setOpenKebab(null);
      };

      const loadStyles = async () => {
        setLoading(true);
        try {
          const { supabase } = window.SocietyArts;
          
          // Load styles - sorted by market viability (highest first), then alphabetically
          const { data: stylesData, error } = await supabase
            .from('styles')
            .select('id, name, thumbnail_url, market_viability_score')
            .eq('is_active', true)
            .order('market_viability_score', { ascending: false, nullsFirst: false })
            .order('name', { ascending: true })
            .limit(5000);
          
          if (error) throw error;

          // Load art medium assignments from junction table
          const { data: artMediumLinks, error: amError } = await supabase
            .from('style_art_mediums')
            .select('style_id, art_medium_id');


          // Build a map of style_id -> array of art_medium_ids
          const artMediumMap = {};
          if (artMediumLinks && artMediumLinks.length > 0) {
            artMediumLinks.forEach(link => {
              if (!artMediumMap[link.style_id]) {
                artMediumMap[link.style_id] = [];
              }
              artMediumMap[link.style_id].push(link.art_medium_id);
            });
          } else {
          }

          // Merge art mediums with styles
          const stylesWithAttrs = stylesData.map(s => ({
            ...s,
            art_medium_ids: artMediumMap[s.id] || []
          }));

          // Debug: Check a few styles
          const stylesWithMediums = stylesWithAttrs.filter(s => s.art_medium_ids.length > 0);

          setAllStyles(stylesWithAttrs);
          setFilteredStyles(stylesWithAttrs);
        } catch (error) {
          console.error('Error loading styles:', error);
        }
        setLoading(false);
      };

      const filterStyles = () => {
        let results = [...allStyles];

        // Search filter
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          results = results.filter(s => 
            s.name?.toLowerCase().includes(term) ||
            s.id?.toLowerCase().includes(term)
          );
        }

        // Medium filter - check if style has any of the selected art_medium_ids
        if (selectedMediums.size > 0) {
          results = results.filter(s => {
            // Check if any of the style's art_medium_ids match any selected medium
            return s.art_medium_ids?.some(amId => selectedMediums.has(amId));
          });
        }

        // Overlay filter (keeping for future use)
        if (selectedOverlays.size > 0) {
          results = results.filter(s => selectedOverlays.has(s.overlay));
        }

        setFilteredStyles(results);
      };

      const toggleMedium = (mediumId) => {
        const newSet = new Set(selectedMediums);
        if (newSet.has(mediumId)) {
          newSet.delete(mediumId);
        } else {
          newSet.add(mediumId);
        }
        setSelectedMediums(newSet);
      };

      const toggleOverlay = (overlayId) => {
        const newSet = new Set(selectedOverlays);
        if (newSet.has(overlayId)) {
          newSet.delete(overlayId);
        } else {
          newSet.add(overlayId);
        }
        setSelectedOverlays(newSet);
      };

      const toggleCategory = (catId) => {
        const newSet = new Set(expandedCategories);
        if (newSet.has(catId)) {
          newSet.delete(catId);
        } else {
          newSet.add(catId);
        }
        setExpandedCategories(newSet);
      };

      const toggleStyleSelection = (styleId) => {
        const newSet = new Set(tempSelected);
        if (newSet.has(styleId)) {
          newSet.delete(styleId);
        } else if (newSet.size < maxStyles) {
          newSet.add(styleId);
        }
        setTempSelected(newSet);
      };

      const resetFilters = () => {
        setSearchTerm('');
        setSelectedMediums(new Set());
        setSelectedOverlays(new Set());
      };

      const handleDone = () => {
        onStylesChange(Array.from(tempSelected));
        onClose();
      };

      const getStyleImage = (style) => {
        if (style.thumbnail_url) {
          return style.thumbnail_url;
        }
        return window.SocietyArts.getStyleThumbnailUrl(style.id, 0);
      };

      if (!isOpen) return null;

      return (
        <div className="style-picker-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
          <div className={`style-picker-modal ${isMaximized ? 'maximized' : ''}`}>
            {/* Header */}
            <div className="style-picker-header" onDoubleClick={handleHeaderDoubleClick}>
              <span className="style-picker-title">Choose Your Styles</span>
              <div className="style-picker-header-actions">
                <button className="sp-maximize-btn" onClick={toggleMaximize} title={isMaximized ? 'Restore' : 'Maximize'}>
                  {isMaximized ? (
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="4 14 10 14 10 20"></polyline>
                      <polyline points="20 10 14 10 14 4"></polyline>
                      <line x1="14" y1="10" x2="21" y2="3"></line>
                      <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                  ) : (
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <polyline points="9 21 3 21 3 15"></polyline>
                      <line x1="21" y1="3" x2="14" y2="10"></line>
                      <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                  )}
                </button>
                <button className="style-picker-close" onClick={onClose}>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
            </div>

            {/* Style Finder Type Tabs */}
            <div className="style-picker-tabs">
              <button 
                className={`style-picker-tab ${activeTab === 'browse' ? 'active' : ''}`}
                onClick={() => setActiveTab('browse')}
              >
                Browse All
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                AI Match
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                By Mood
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                By Color
              </button>
            </div>

            {/* Body */}
            <div className="style-picker-body">
              {/* Sidebar with Facets */}
              <div className="style-picker-sidebar">
                {/* Search */}
                <div className="sp-search">
                  <div className="sp-search-input">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input 
                      type="text" 
                      placeholder="Search styles..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                  </div>
                </div>

                {/* Facets */}
                <div className="sp-facets">
                  {/* Medium Categories */}
                  {Object.entries(MEDIUM_CATEGORIES).map(([catId, category]) => (
                    <div key={catId} className={`sp-category ${expandedCategories.has(catId) ? 'open' : ''}`}>
                      <div className="sp-category-header" onClick={() => toggleCategory(catId)}>
                        <div className="sp-category-header-left">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                          </svg>
                          <h4>{category.name}</h4>
                        </div>
                        <span className="sp-category-count">
                          {category.mediums.reduce((sum, m) => {
                            const count = allStyles.filter(s => s.art_medium_ids?.includes(m.id)).length;
                            return sum + count;
                          }, 0)}
                        </span>
                      </div>
                      <div className="sp-category-items">
                        {category.mediums.map(medium => (
                          <div 
                            key={medium.id}
                            className={`sp-facet-item ${selectedMediums.has(medium.id) ? 'selected' : ''}`}
                            onClick={() => toggleMedium(medium.id)}
                          >
                            <div className="sp-facet-checkbox">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            </div>
                            <span>{medium.name}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}

                  {/* Overlays */}
                  <div className={`sp-category ${expandedCategories.has('overlays') ? 'open' : ''}`}>
                    <div className="sp-category-header" onClick={() => toggleCategory('overlays')}>
                      <div className="sp-category-header-left">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <h4>Style</h4>
                      </div>
                      <span className="sp-category-count">{OVERLAYS.length}</span>
                    </div>
                    <div className="sp-category-items">
                      {OVERLAYS.map(overlay => (
                        <div 
                          key={overlay.id}
                          className={`sp-facet-item ${selectedOverlays.has(overlay.id) ? 'selected' : ''}`}
                          onClick={() => toggleOverlay(overlay.id)}
                        >
                          <div className="sp-facet-checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                              <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                          </div>
                          <span>{overlay.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* Grid Area */}
              <div className="style-picker-grid-area">
                <div className="sp-grid-header">
                  <span className="sp-results-count">
                    {filteredStyles.length} styles {(selectedMediums.size > 0 || selectedOverlays.size > 0 || searchTerm) && '(filtered)'}
                  </span>
                  <div className="sp-grid-controls">
                    {(selectedMediums.size > 0 || selectedOverlays.size > 0 || searchTerm) && (
                      <button className="sp-reset-btn" onClick={resetFilters}>Reset filters</button>
                    )}
                    {/* Density Selector */}
                    <div className="sp-density-selector">
                      <button 
                        className={`sp-density-btn ${gridDensity === 2 ? 'active' : ''}`}
                        onClick={() => setGridDensity(2)}
                        title="2 columns"
                      >
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                      </button>
                      <button 
                        className={`sp-density-btn ${gridDensity === 3 ? 'active' : ''}`}
                        onClick={() => setGridDensity(3)}
                        title="3 columns"
                      >
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                      </button>
                      <button 
                        className={`sp-density-btn ${gridDensity === 4 ? 'active' : ''}`}
                        onClick={() => setGridDensity(4)}
                        title="4 columns"
                      >
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                        <span className="density-dot"></span>
                      </button>
                    </div>
                  </div>
                </div>

                <div className={`sp-grid density-${gridDensity}`}>
                  {loading ? (
                    <div className="sp-loading">
                      <div className="sp-spinner"></div>
                    </div>
                  ) : (
                    filteredStyles.map(style => (
                      <div 
                        key={style.id}
                        className={`sp-card ${tempSelected.has(style.id) ? 'selected' : ''}`}
                      >
                        {/* Checkbox - Top Left */}
                        <div 
                          className={`sp-card-checkbox ${tempSelected.has(style.id) ? 'checked' : ''}`}
                          onClick={(e) => { e.stopPropagation(); toggleStyleSelection(style.id); }}
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        </div>

                        {/* Heart - Top Right */}
                        <button 
                          className={`sp-card-heart ${favorites.has(style.id) ? 'favorited' : ''}`}
                          onClick={(e) => toggleFavorite(style.id, e)}
                        >
                          <svg viewBox="0 0 24 24" fill={favorites.has(style.id) ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                          </svg>
                        </button>

                        {/* Image - Click Zone */}
                        <div className="sp-card-image-zone" onClick={() => openStyleDetail(style)}>
                          <img 
                            src={getStyleImage(style)} 
                            alt={style.name}
                            loading="lazy"
                            onError={(e) => {
                              e.target.src = window.SocietyArts.getStyleThumbnailUrl(style.id, 0);
                            }}
                          />
                        </div>
                        <img 
                          src={getStyleImage(style)} 
                          alt={style.name}
                          loading="lazy"
                          onError={(e) => {
                            e.target.src = window.SocietyArts.getStyleThumbnailUrl(style.id, 0);
                          }}
                        />

                        {/* Kebab Menu - Bottom Right */}
                        <button 
                          className="sp-card-kebab"
                          onClick={(e) => handleKebabClick(style.id, e)}
                        >
                          <svg viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="5" r="1.5"></circle>
                            <circle cx="12" cy="12" r="1.5"></circle>
                            <circle cx="12" cy="19" r="1.5"></circle>
                          </svg>
                        </button>

                        {/* Kebab Dropdown Menu */}
                        {openKebab === style.id && (
                          <div className="sp-kebab-menu" onClick={(e) => e.stopPropagation()}>
                            <div className="sp-kebab-menu-header">{style.name}</div>
                            <button className="sp-kebab-menu-item" onClick={(e) => handleAddToProject(style.id, e)}>
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                {tempSelected.has(style.id) ? (
                                  <><line x1="5" y1="12" x2="19" y2="12"></line></>
                                ) : (
                                  <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>
                                )}
                              </svg>
                              {tempSelected.has(style.id) ? 'Remove from Project' : 'Add to Project'}
                            </button>
                            <button className="sp-kebab-menu-item" onClick={() => setOpenKebab(null)}>
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                              </svg>
                              Add to Collection
                            </button>
                            {isSuperAdmin && (
                              <>
                                <div className="sp-kebab-menu-divider"></div>
                                <button className="sp-kebab-menu-item" onClick={() => handleFlagForReview(style.id)}>
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                    <line x1="4" y1="22" x2="4" y2="15"></line>
                                  </svg>
                                  Flag for Review
                                </button>
                                <button className="sp-kebab-menu-item danger" onClick={() => handleUnlist(style.id)}>
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                  </svg>
                                  Unlist
                                </button>
                                <button className="sp-kebab-menu-item" onClick={() => handleEdit(style.id)}>
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                  </svg>
                                  Edit
                                </button>
                              </>
                            )}
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            {/* Footer */}
            <div className="style-picker-footer">
              <div className="sp-selection-info">
                <span className="sp-selection-count">
                  <strong>{tempSelected.size}</strong> of {maxStyles} styles selected
                </span>
                {tempSelected.size > 0 && (
                  <div className="sp-selected-previews">
                    {Array.from(tempSelected).slice(0, 4).map(styleId => {
                      const style = allStyles.find(s => s.id === styleId);
                      return style ? (
                        <div key={styleId} className="sp-selected-preview">
                          <img src={getStyleImage(style)} alt={style.name} />
                        </div>
                      ) : null;
                    })}
                  </div>
                )}
              </div>
              <div className="sp-footer-actions">
                <button className="sp-cancel-btn" onClick={onClose}>Cancel</button>
                <button 
                  className="sp-done-btn" 
                  onClick={handleDone}
                >
                  Done
                </button>
              </div>
            </div>
          </div>

          {/* Style Detail Overlay */}
          {detailStyle && (
            <div className="style-detail-overlay" onClick={(e) => e.target === e.currentTarget && setDetailStyle(null)}>
              <div className="style-detail-modal">
                {/* Floating buttons - heart and close */}
                <div className="style-detail-floating-btns">
                  <button 
                    className={`style-detail-floating-btn heart ${favorites.has(detailStyle.id) ? 'favorited' : ''}`}
                    onClick={(e) => toggleFavorite(detailStyle.id, e)}
                    title="Add to favorites"
                  >
                    <svg viewBox="0 0 24 24" fill={favorites.has(detailStyle.id) ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                  </button>
                  <button 
                    className="style-detail-floating-btn"
                    onClick={() => setDetailStyle(null)}
                    title="Close"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                
                <div className="style-detail-content">
                  {/* Left Panel - Info */}
                  <div className="style-detail-info">
                    <h2 className="style-detail-name">{detailStyle.name}</h2>
                    
                    <p className="style-detail-description">
                      {detailStyle.description || 'No description available for this style.'}
                    </p>

                    <div className="style-detail-actions">
                      <button 
                        className={`style-detail-btn-primary ${tempSelected.has(detailStyle.id) ? 'remove' : ''}`}
                        onClick={() => handleAddToProject(detailStyle.id)}
                      >
                        {tempSelected.has(detailStyle.id) ? ' Remove from Project' : '+ Add to Project'}
                      </button>
                      <button className="style-detail-btn-secondary">
                        Add to Collection
                      </button>
                      
                      {isSuperAdmin && (
                        <div className="style-detail-admin">
                          <div className="style-detail-admin-buttons">
                            <button className="style-detail-admin-btn" onClick={() => handleFlagForReview(detailStyle.id)}>
                              Flag for Review
                            </button>
                            <button className="style-detail-admin-btn danger" onClick={() => handleUnlist(detailStyle.id)}>
                              Unlist
                            </button>
                            <button className="style-detail-admin-btn" onClick={() => handleEdit(detailStyle.id)}>
                              Edit
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Right Panel - Image Grid */}
                  <div className="style-detail-images">
                    <div className="style-detail-grid">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                        <div 
                          key={num}
                          className="style-detail-grid-item"
                          onClick={() => setViewerImage({ styleId: detailStyle.id, imageIndex: num })}
                        >
                          <img 
                            src={window.SocietyArts.getStylePreviewUrl(detailStyle.id, num)}
                            alt={`${detailStyle.name} - Image ${num}`}
                            onError={(e) => { e.target.style.opacity = '0.3'; }}
                          />
                        </div>
                      ))}
                    </div>
                    <div className="style-detail-grid-id">{detailStyle.id}</div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Image Viewer Lightbox */}
          {viewerImage && (
            <div className="image-viewer-overlay" onClick={(e) => e.target === e.currentTarget && setViewerImage(null)}>
              <button className="image-viewer-close" onClick={() => setViewerImage(null)}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
              
              <div className="image-viewer-main">
                <button className="image-viewer-nav prev" onClick={() => navigateImage(-1)}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                
                <div className="image-viewer-container">
                  <img 
                    src={window.SocietyArts.getStyleFullUrl(viewerImage.styleId, viewerImage.imageIndex)}
                    alt={`Image ${viewerImage.imageIndex}`}
                    draggable={false}
                  />
                </div>
                
                <button className="image-viewer-nav next" onClick={() => navigateImage(1)}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>
              
              <div className="image-viewer-footer">
                <div className="image-viewer-dots">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                    <button 
                      key={num}
                      className={`image-viewer-dot ${viewerImage.imageIndex === num ? 'active' : ''}`}
                      onClick={() => setViewerImage({ ...viewerImage, imageIndex: num })}
                    />
                  ))}
                </div>
                <span className="image-viewer-counter">{viewerImage.imageIndex} of 9</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // STORY BUILDER APP
    // ============================================

    function StoryBuilderApp() {
      // Get shared components inside the function to ensure they're loaded
      const { Header, Sidebar, Footer, FormatSelector, Icons } = window.SocietyArts || {};
      const { API, Voice, StoryPanel, Variations, StyleData, SaveProjectModal } = window.SocietyArts || {};
      
      // Auth state
      const { user, profile } = window.SocietyArts?.useAuth ? 
        window.SocietyArts.useAuth() : { user: null, profile: null };
      
      // Loading check
      if (!Sidebar || !Header) {
        return React.createElement('div', { className: 'loading-state' }, 'Loading...');
      }
      
      // Project state
      const [projectId, setProjectId] = useState(null);
      const [isDirty, setIsDirty] = useState(false);
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [pendingAction, setPendingAction] = useState(null);
      const [styleDetails, setStyleDetails] = useState({}); // Cache for loaded style data
      
      // Core state
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [story, setStory] = useState('');
      const [title, setTitle] = useState(null);
      const [transformedStory, setTransformedStory] = useState(null);
      const [transformLabel, setTransformLabel] = useState(null);
      const [selectedStyles, setSelectedStyles] = useState([]);
      const [aspectRatio, setAspectRatio] = useState('1:1');
      const [hasStarted, setHasStarted] = useState(false);
      const [voiceMode, setVoiceMode] = useState(false);
      const [styleFinderOpen, setStyleFinderOpen] = useState(false);
      const [showChatInfo, setShowChatInfo] = useState(false);
      const [showStylesInfo, setShowStylesInfo] = useState(false);
      
      const messagesEndRef = useRef(null);
      const extractionTimeoutRef = useRef(null);
      const chatInfoRef = useRef(null);
      const stylesInfoRef = useRef(null);

      // Click outside to close tooltips
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showChatInfo && chatInfoRef.current && !chatInfoRef.current.contains(e.target)) {
            setShowChatInfo(false);
          }
          if (showStylesInfo && stylesInfoRef.current && !stylesInfoRef.current.contains(e.target)) {
            setShowStylesInfo(false);
          }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [showChatInfo, showStylesInfo]);

      // Load project from URL on mount
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const projectIdParam = params.get('project');
        if (projectIdParam && user) {
          loadProjectById(projectIdParam);
        }
      }, [user]);

      // Load a project by ID
      const loadProjectById = async (id) => {
        try {
          const project = await window.SocietyArts.loadProject(id);
          if (project) {
            setProjectId(project.id);
            setTitle(project.title);
            setStory(project.story || '');
            setTransformedStory(project.transformed_story);
            setTransformLabel(project.transform_label);
            setSelectedStyles(project.selected_styles || []);
            setAspectRatio(project.aspect_ratio || '1:1');
            setMessages(project.chat_history || []);
            setHasStarted(project.chat_history?.length > 0 || !!project.story);
            setIsDirty(false);
            
            // Load style details for selected styles
            if (project.selected_styles?.length > 0) {
              loadStyleDetails(project.selected_styles);
            }
          }
        } catch (error) {
          console.error('Failed to load project:', error);
        }
      };

      // Load style details from database
      const loadStyleDetails = async (styleIds) => {
        if (!window.SocietyArts.supabase) return;
        
        const { data } = await window.SocietyArts.supabase
          .from('styles')
          .select('id, name, thumbnail_url')
          .in('id', styleIds);
        
        if (data) {
          const details = {};
          data.forEach(style => {
            details[style.id] = style;
          });
          setStyleDetails(prev => ({ ...prev, ...details }));
        }
      };

      // Mark as dirty when state changes
      useEffect(() => {
        if (hasStarted) {
          setIsDirty(true);
        }
      }, [story, title, selectedStyles, messages, aspectRatio, transformedStory]);

      // Save project
      const saveCurrentProject = async () => {
        if (!user) {
          alert('Please sign in to save your project');
          return false;
        }

        try {
          const projectData = {
            id: projectId,
            title: title || 'Untitled Project',
            story,
            transformedStory,
            transformLabel,
            aspectRatio,
            selectedStyles,
            chatHistory: messages,
            status: story ? 'in_progress' : 'draft'
          };

          const saved = await window.SocietyArts.saveProject(projectData);
          setProjectId(saved.id);
          setIsDirty(false);
          
          // Update URL without reload
          const newUrl = `/story-builder.html?project=${saved.id}`;
          window.history.replaceState({}, '', newUrl);
          
          return true;
        } catch (error) {
          console.error('Failed to save project:', error);
          alert('Failed to save project. Please try again.');
          return false;
        }
      };

      // Voice callbacks
      const handleVoiceUserMessage = useCallback((content) => {
        if (!hasStarted) setHasStarted(true);
        setMessages(prev => [...prev, { role: 'user', content }]);
      }, [hasStarted]);

      const handleVoiceAssistantMessage = useCallback((content) => {
        setMessages(prev => [...prev, { role: 'assistant', content }]);
        
        if (extractionTimeoutRef.current) {
          clearTimeout(extractionTimeoutRef.current);
        }
        extractionTimeoutRef.current = setTimeout(() => {
          extractStoryFromConversation();
        }, 1000);
      }, []);

      // Voice Interface
      const voice = Voice.useVoiceInterface({
        onUserMessage: handleVoiceUserMessage,
        onAssistantMessage: handleVoiceAssistantMessage,
      });

      // Extract story from voice conversation
      const extractStoryFromConversation = async () => {
        const conversationText = messages.map(m => `${m.role}: ${m.content}`).join('\n');
        if (conversationText.length < 50) return;

        try {
          const data = await API.callClaude([{
            role: 'user',
            content: `${API.prompts.storyExtraction}\n\nConversation:\n${conversationText}`
          }], 500);

          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            if (parsed) {
              if (parsed.title && !title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
            }
          }
        } catch (err) {
          console.error('Story extraction error:', err);
        }
      };

      // Scroll to bottom
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Re-extract when messages change
      useEffect(() => {
        if (voiceMode && messages.length >= 4 && messages.length % 2 === 0) {
          extractStoryFromConversation();
        }
      }, [messages, voiceMode]);

      // Handlers
      const handleNewProject = () => {
        // If there's unsaved work, ask to save first
        if (isDirty && (title || story || messages.length > 0)) {
          setPendingAction('new');
          setShowSaveModal(true);
          return;
        }
        
        resetProject();
      };

      const resetProject = () => {
        setProjectId(null);
        setMessages([]);
        setInputValue('');
        setIsLoading(false);
        setStory('');
        setTitle(null);
        setTransformedStory(null);
        setTransformLabel(null);
        setSelectedStyles([]);
        setAspectRatio('1:1');
        setHasStarted(false);
        setVoiceMode(false);
        setIsDirty(false);
        voice.disconnect();
        
        // Clear URL parameter
        window.history.replaceState({}, '', '/story-builder.html');
      };

      const handleSaveAndContinue = async () => {
        const saved = await saveCurrentProject();
        setShowSaveModal(false);
        
        if (pendingAction === 'new') {
          resetProject();
        }
        setPendingAction(null);
      };

      const handleDiscardAndContinue = () => {
        setShowSaveModal(false);
        
        if (pendingAction === 'new') {
          resetProject();
        }
        setPendingAction(null);
      };

      const toggleVoiceMode = async (enable) => {
        if (!enable && voiceMode) {
          voice.disconnect();
          setVoiceMode(false);
        } else if (enable && !voiceMode) {
          try {
            setVoiceMode(true); // Show voice UI immediately
            setHasStarted(true);
            await voice.connect();
          } catch (err) {
            console.error('Failed to enable voice mode:', err);
            setVoiceMode(false);
            alert('Failed to connect to voice service. Please try again.');
          }
        }
      };

      // Auto-start listening when voice connects
      useEffect(() => {
        if (voiceMode && voice.isConnected && !voice.isListening && !voice.isSpeaking) {
          const timer = setTimeout(() => {
            voice.startListening();
          }, 300);
          return () => clearTimeout(timer);
        }
      }, [voiceMode, voice.isConnected]);

      const sendMessage = async () => {
        if (!inputValue.trim() || isLoading) return;
        
        // Require login to start a story
        if (!user) {
          window.SocietyArts?.openAuthModal?.();
          return;
        }

        if (!hasStarted) setHasStarted(true);

        const userMessage = { role: 'user', content: inputValue };
        const updatedMessages = [...messages, userMessage];
        setMessages(updatedMessages);
        setInputValue('');
        setIsLoading(true);

        try {
          let contextMessage = '';
          if (story) {
            contextMessage = `\n\n[CURRENT STORY STATE: "${story}"]\n[CURRENT TITLE: "${title || 'None yet'}"]\n\nIf the user is requesting a modification, update the story accordingly.`;
          }

          const userPrompt = updatedMessages.map(m => `${m.role}: ${m.content}`).join('\n');

          const data = await API.callClaude([{ 
            role: 'user', 
            content: `${API.prompts.storyBuilder}${contextMessage}\n\n---\nConversation so far:\n${userPrompt}\n\nRespond as the assistant with valid JSON only.`
          }]);
          
          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            
            if (parsed) {
              if (parsed.title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: parsed.message || "I'd love to hear more about your vision!"
              }]);
            } else {
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: data.content[0].text
              }]);
            }
          }
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I apologize, but I'm having trouble connecting right now. Please try again in a moment."
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      // Handle variation applied - updates the transformed story
      const handleVariationApplied = (newStory, label) => {
        setTransformedStory(newStory);
        setTransformLabel(label);
      };

      // Clear transformation and go back to original
      const handleClearTransform = () => {
        setTransformedStory(null);
        setTransformLabel(null);
      };

      const toggleStyle = (styleId) => {
        setSelectedStyles(prev => {
          if (prev.includes(styleId)) {
            return prev.filter(id => id !== styleId);
          }
          if (prev.length >= 4) {
            return prev; // Max 4 styles
          }
          return [...prev, styleId];
        });
      };

      const removeStyle = (styleId) => {
        setSelectedStyles(prev => prev.filter(id => id !== styleId));
      };

      // Get style image URL
      const getStyleImage = (styleId) => {
        const cached = styleDetails[styleId];
        if (cached?.thumbnail_url) {
          return cached.thumbnail_url;
        }
        return window.SocietyArts.getStyleThumbnailUrl(styleId, 0);
      };

      // Get style name
      const getStyleName = (styleId) => {
        const cached = styleDetails[styleId];
        if (cached?.name) {
          return cached.name;
        }
        // Convert ID to readable name
        return styleId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      };

      // Calculate progress
      const hasStory = story && story.trim().length > 0;
      const progress = hasStory 
        ? (selectedStyles.length > 0 ? 100 : 50) 
        : (hasStarted ? 15 : 5);

      return (
        <div className="page-container">
          <Sidebar />
          <Header />
          
          <main className="main-content story-builder-layout">
            {/* Left Column - Story Panel */}
            <StoryPanel.StoryPanel
              story={story}
              title={title}
              isVoiceMode={voiceMode}
              isLoading={isLoading}
              transformedStory={transformedStory}
              transformLabel={transformLabel}
              onVariationApplied={handleVariationApplied}
              onClearTransform={handleClearTransform}
              onStoryChange={(newStory) => {
                // If editing transformed story, clear transform first
                if (transformedStory) {
                  setTransformedStory(newStory);
                } else {
                  setStory(newStory);
                }
              }}
            />
            
            {/* Center Column - Chat */}
            <div className="chat-container">
              {title ? (
                <div className="chat-title-bar" ref={chatInfoRef}>
                  <span>{title}</span>
                  <button 
                    className="chat-info-btn"
                    onClick={() => setShowChatInfo(!showChatInfo)}
                    title="About this panel"
                  >
                    <svg viewBox="0 0 128 128" width="20" height="20">
                      <path d="M 64 6 C 32 6 6 32 6 64 C 6 96 32 122 64 122 C 96 122 122 96 122 64 C 122 32 96 6 64 6 z M 64 12 C 92.7 12 116 35.3 116 64 C 116 92.7 92.7 116 64 116 C 35.3 116 12 92.7 12 64 C 12 35.3 35.3 12 64 12 z M 64 30 A 9 9 0 0 0 64 48 A 9 9 0 0 0 64 30 z M 64 59 C 59 59 55 63 55 68 L 55 92 C 55 97 59 101 64 101 C 69 101 73 97 73 92 L 73 68 C 73 63 69 59 64 59 z"/>
                    </svg>
                  </button>
                  {showChatInfo && (
                    <div className="panel-info-tooltip">
                      <div className="panel-info-content">
                        <h4 style={{ color: '#3E2318' }}>Build Your Story</h4>
                        <p>
                          This is where your story comes to life. Share your memory or idea by typing in the chat below, or click the voice icon to speak naturally  I'll listen and capture your words.
                        </p>
                        <p>
                          As your story develops, a title will automatically appear above. The title bar turns dark when your narrative is complete enough to name.
                        </p>
                        <button className="panel-info-close" onClick={() => setShowChatInfo(false)}>
                          Got it
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div className="chat-title-bar-empty" ref={chatInfoRef}>
                  <span>Your Story Title</span>
                  <button 
                    className="chat-info-btn"
                    onClick={() => setShowChatInfo(!showChatInfo)}
                    title="About this panel"
                  >
                    <svg viewBox="0 0 128 128" width="20" height="20">
                      <path d="M 64 6 C 32 6 6 32 6 64 C 6 96 32 122 64 122 C 96 122 122 96 122 64 C 122 32 96 6 64 6 z M 64 12 C 92.7 12 116 35.3 116 64 C 116 92.7 92.7 116 64 116 C 35.3 116 12 92.7 12 64 C 12 35.3 35.3 12 64 12 z M 64 30 A 9 9 0 0 0 64 48 A 9 9 0 0 0 64 30 z M 64 59 C 59 59 55 63 55 68 L 55 92 C 55 97 59 101 64 101 C 69 101 73 97 73 92 L 73 68 C 73 63 69 59 64 59 z"/>
                    </svg>
                  </button>
                  {showChatInfo && (
                    <div className="panel-info-tooltip">
                      <div className="panel-info-content">
                        <h4 style={{ color: '#3E2318' }}>Build Your Story</h4>
                        <p>
                          This is where your story comes to life. Share your memory or idea by typing in the chat below, or click the voice icon to speak naturally  I'll listen and capture your words.
                        </p>
                        <p>
                          As your story develops, a title will automatically appear above. The title bar turns dark when your narrative is complete enough to name.
                        </p>
                        <button className="panel-info-close" onClick={() => setShowChatInfo(false)}>
                          Got it
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              <div className="messages-container">
                {!hasStarted ? (
                  <div className="welcome-container">
                    <h2 className="welcome-title">Welcome to Society Arts.</h2>
                    <p className="welcome-text">
                      I'm here to help create your beautiful work of art from your own idea or personal story. Let me know when you're ready to begin.
                    </p>
                  </div>
                ) : (
                  <>
                    {messages.map((msg, index) => (
                      <div key={index} className={`message message-${msg.role}`}>
                        <div className={`message-bubble message-bubble-${msg.role}`}>
                          {msg.content}
                        </div>
                      </div>
                    ))}
                    {(isLoading || (voiceMode && voice.isListening)) && (
                      <div className="message message-assistant">
                        <div className="typing-indicator">
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </>
                )}
              </div>
              
              {/* Input always at bottom */}
              <div className="chat-input-area">
                <Voice.UnifiedInput
                  voiceMode={voiceMode}
                  onToggleMode={toggleVoiceMode}
                  inputValue={inputValue}
                  onInputChange={setInputValue}
                  onSendMessage={sendMessage}
                  isLoading={isLoading}
                  voice={voice}
                  placeholder={hasStarted ? "Continue your story..." : "Start your story..."}
                  onRequireAuth={() => {
                    if (!user) {
                      window.SocietyArts?.openAuthModal?.();
                    }
                  }}
                />
              </div>
            </div>
            
            {/* Right Column - Styles */}
            <div className="styles-column">
              <div className={`styles-panel-header ${selectedStyles.length > 0 ? 'has-styles' : ''}`} ref={stylesInfoRef}>
                <span className="styles-panel-title">Your Styles</span>
                <button 
                  className="styles-info-btn"
                  onClick={() => setShowStylesInfo(!showStylesInfo)}
                  title="About this panel"
                >
                  <svg viewBox="0 0 128 128" width="20" height="20">
                    <path d="M 64 6 C 32 6 6 32 6 64 C 6 96 32 122 64 122 C 96 122 122 96 122 64 C 122 32 96 6 64 6 z M 64 12 C 92.7 12 116 35.3 116 64 C 116 92.7 92.7 116 64 116 C 35.3 116 12 92.7 12 64 C 12 35.3 35.3 12 64 12 z M 64 30 A 9 9 0 0 0 64 48 A 9 9 0 0 0 64 30 z M 64 59 C 59 59 55 63 55 68 L 55 92 C 55 97 59 101 64 101 C 69 101 73 97 73 92 L 73 68 C 73 63 69 59 64 59 z"/>
                  </svg>
                </button>
                
                {showStylesInfo && (
                  <div className="styles-info-tooltip">
                    <div className="panel-info-content">
                      <h4 style={{ color: '#3E2318' }}>Choose Your Art Styles</h4>
                      <p>
                        Select up to 4 artistic styles that will shape how your story becomes visual art. Each style brings a unique aesthetic  from watercolors to bold oils, photography to illustration.
                      </p>
                      <p>
                        Click "Add Style" to open the Style Finder, where you can browse by medium, mood, or search for exactly what you envision.
                      </p>
                      <button className="panel-info-close" onClick={() => setShowStylesInfo(false)}>
                        Got it
                      </button>
                    </div>
                  </div>
                )}
              </div>
              
              <div className="styles-list">
                {selectedStyles.map((styleId) => (
                  <div 
                    key={styleId}
                    className="style-list-item selected"
                    onClick={() => {
                      // TODO: Open style detail modal
                    }}
                  >
                    <img 
                      src={getStyleImage(styleId)} 
                      alt={getStyleName(styleId)}
                      onError={(e) => {
                        e.target.src = window.SocietyArts.getStyleThumbnailUrl(styleId, 0);
                      }}
                    />
                    <button 
                      className="style-remove-btn" 
                      onClick={(e) => {
                        e.stopPropagation();
                        removeStyle(styleId);
                      }}
                      title="Remove style"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                    <div className="style-list-overlay">
                      <div className="style-list-name">{getStyleName(styleId)}</div>
                    </div>
                  </div>
                ))}
                
                {selectedStyles.length < 4 && (
                  <button 
                    className="add-style-btn"
                    onClick={() => setStyleFinderOpen(true)}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Style
                  </button>
                )}
              </div>
              
              {selectedStyles.length > 0 && (
                <div className="styles-count">
                  {selectedStyles.length} of 4 styles selected
                </div>
              )}
            </div>
          </main>
          
          <Footer onNewChat={title ? handleNewProject : undefined}>
            {user && (title || story) && (
              <button 
                className="btn btn-secondary"
                onClick={saveCurrentProject}
              >
                {isDirty ? 'Save Project' : 'Saved '}
              </button>
            )}
            <button 
              className="btn btn-primary"
              style={{ opacity: story && selectedStyles.length > 0 ? 1 : 0.6 }}
              disabled={!story || selectedStyles.length === 0}
            >
              Create
              <Icons.arrowRight />
            </button>
          </Footer>
          
          {/* Save Confirmation Modal */}
          {SaveProjectModal && (
            <SaveProjectModal
              isOpen={showSaveModal}
              onClose={() => setShowSaveModal(false)}
              onSave={handleSaveAndContinue}
              onDiscard={handleDiscardAndContinue}
              projectTitle={title}
            />
          )}
          
          {/* Style Picker Modal */}
          <StylePickerModal
            isOpen={styleFinderOpen}
            onClose={() => setStyleFinderOpen(false)}
            selectedStyles={selectedStyles}
            onStylesChange={(styles) => {
              setSelectedStyles(styles);
              setIsDirty(true);
              // Load style details for new selections
              if (styles.length > 0) {
                loadStyleDetails(styles);
              }
            }}
            maxStyles={4}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    
    // Wait for all components to be loaded and auth initialized
    function waitForComponents(callback, maxAttempts = 50) {
      let attempts = 0;
      const check = () => {
        attempts++;
        if (window.SocietyArts?.Sidebar && window.SocietyArts?.Header && window.SocietyArts?.Voice) {
          // Initialize auth before rendering
          if (window.initializeAuth && !window.AuthState?.initialized) {
            window.initializeAuth().then(callback);
          } else {
            callback();
          }
        } else if (attempts < maxAttempts) {
          setTimeout(check, 100);
        } else {
          console.error('Components failed to load');
          callback(); // Try anyway
        }
      };
      check();
    }
    
    waitForComponents(() => {
      root.render(<StoryBuilderApp />);
    });
  </script>
</body>
</html>
