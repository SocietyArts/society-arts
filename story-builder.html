<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Builder - Society Arts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts - Familjen Grotesk + Domine -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/modals.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  <link rel="stylesheet" href="/css/auth.css">
  
  <style>
    /* Story Builder - Fixed Layout with only chat scrolling */
    .page-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding-left: var(--sidebar-width-collapsed, 50px);
      padding-top: var(--logo-bar-height, 48px);
    }
    
    /* Story Builder Layout - 3 columns with proportional sizing */
    .story-builder-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(400px, 2fr) minmax(280px, 1fr);
      gap: var(--space-xl);
      padding: var(--space-xl) var(--space-2xl);
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    /* Panel Headers - Unified style for all 3 columns */
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px var(--space-xl);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border-light);
      position: relative;
      margin: 0;
    }
    
    .panel-header-active {
      background: #3E2318;
      color: #FAF8F5;
      border-bottom: none;
    }
    
    .panel-header-active .panel-header-title {
      color: #FAF8F5;
    }
    
    .panel-header-active .panel-info-btn {
      color: #FAF8F5;
      opacity: 0.8;
    }
    
    .panel-header-active .panel-info-btn:hover {
      opacity: 1;
    }
    
    .panel-header-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
      text-align: center;
    }
    
    .panel-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .panel-info-btn:hover,
    .panel-info-btn.active {
      color: var(--color-text-primary);
      background: var(--color-surface-hover);
    }
    
    /* Panel Info Tooltip */
    .panel-info-tooltip {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      z-index: 100;
      width: 280px;
    }
    
    .panel-info-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.15);
      border: 1px solid var(--color-border-light);
    }
    
    .panel-info-content h4 {
      font-family: var(--font-serif);
      font-size: var(--text-base);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .panel-info-content p {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin: 0 0 var(--space-md) 0;
      line-height: 1.5;
    }
    
    .panel-info-content ul {
      margin: 0 0 var(--space-md) 0;
      padding-left: var(--space-lg);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    
    .panel-info-content li {
      margin-bottom: var(--space-xs);
    }
    
    .panel-info-close {
      background: var(--color-tan-10);
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      width: 100%;
      transition: background 0.15s;
    }
    
    .panel-info-close:hover {
      background: var(--color-tan-20);
    }
    
    /* Story badges moved inside card content */
    .story-badges {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
      min-height: 24px;
    }
    
    /* Variation Tooltips */
    .variation-btn-wrapper {
      position: relative;
    }
    
    .variation-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: 240px;
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.2);
      border: 1px solid var(--color-border-light);
      z-index: 100;
      pointer-events: none;
    }
    
    .variation-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: white;
    }
    
    .variation-tooltip-title {
      font-weight: var(--weight-semibold);
      font-size: var(--text-sm);
      margin-bottom: var(--space-xs);
      color: var(--color-text-primary);
    }
    
    .variation-tooltip-desc {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }
    
    /* Left and Right panels - no scroll, fixed content */
    .story-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      overflow-y: auto;
      min-width: 0;
      padding: 0;
      max-height: 100%;
    }
    
    /* Story Card adjustments - MUST override .card padding */
    .card.story-card {
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--color-tan-10);
      padding: 0 !important; /* Override .card padding so header fills full width */
      border: none;
    }
    
    .story-card .card-content {
      padding: var(--space-md) var(--space-lg) var(--space-lg);
      background: var(--color-tan-10);
    }
    
    /* Variation selector adjustments - MUST override any inherited padding */
    .variation-selector {
      background: var(--color-tan-10);
      border-radius: var(--radius-lg);
      overflow: hidden;
      padding: 0 !important;
    }
    
    .variation-selector .panel-header {
      margin-bottom: 0;
    }
    
    .variation-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-sm);
      padding: var(--space-md);
    }
    
    /* Chat Container - this is what scrolls */
    .chat-container {
      background-color: var(--color-tan-10);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 100%;
      overflow: hidden;
    }
    
    .chat-title-bar {
      padding: 14px var(--space-xl);
      border-bottom: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
      flex-shrink: 0;
      position: relative;
      background: #3E2318;
      color: #FAF8F5;
      margin: 0;
    }
    
    .chat-title-bar .chat-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #FAF8F5;
      opacity: 0.8;
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .chat-title-bar .chat-info-btn:hover {
      opacity: 1;
    }
    
    /* Empty chat title bar (no title yet) */
    .chat-title-bar-empty {
      padding: 14px var(--space-xl);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
      color: var(--color-text-muted);
      flex-shrink: 0;
      position: relative;
      background: var(--color-surface-alt);
      margin: 0;
    }
    
    .chat-title-bar-empty .chat-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .chat-title-bar-empty .chat-info-btn:hover {
      color: var(--color-text-primary);
      background: var(--color-surface-hover);
    }
    
    .voice-mode-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-xl);
      background-color: var(--color-surface-hover);
      border-bottom: 1px solid var(--color-border-dark);
      flex-shrink: 0;
    }
    
    .voice-mode-text {
      font-size: 14px;
      color: var(--color-text-secondary);
      font-weight: var(--weight-medium);
    }
    
    /* Messages - THIS is the scrollable area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    /* Styles Column - with panel header */
    .styles-column {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-width: 0;
      padding: 0; /* No padding so header fills edge-to-edge */
      background: var(--color-tan-10);
      border-radius: var(--radius-lg);
    }
    
    .styles-panel-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px var(--space-xl);
      border-bottom: 1px solid var(--color-border-light);
      position: relative;
      background: var(--color-surface-alt);
      margin: 0;
    }
    
    .styles-panel-header.has-styles {
      background: #3E2318;
      color: #FAF8F5;
      border-bottom: none;
    }
    
    .styles-panel-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: var(--weight-medium);
    }
    
    .styles-info-btn {
      position: absolute;
      right: var(--space-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .styles-panel-header.has-styles .styles-info-btn {
      color: #FAF8F5;
      opacity: 0.8;
    }
    
    .styles-info-btn:hover {
      opacity: 1;
    }
    
    .styles-info-tooltip {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      z-index: 100;
      width: 260px;
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: 0 8px 32px rgba(62, 35, 24, 0.15);
      border: 1px solid var(--color-border-light);
    }
    
    .styles-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      padding: var(--space-md);
    }
    
    .style-list-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid transparent;
    }
    
    .style-list-item:hover {
      transform: scale(1.02);
    }
    
    .style-list-item.selected {
      border-color: var(--color-accent);
    }
    
    .style-list-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .style-list-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-sm) var(--space-md);
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
    }
    
    .style-list-name {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .style-remove-btn {
      position: absolute;
      top: var(--space-xs);
      right: var(--space-xs);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      opacity: 0;
      transition: all 0.2s;
    }
    
    .style-list-item:hover .style-remove-btn {
      opacity: 1;
    }
    
    .style-remove-btn:hover {
      background: white;
      color: #dc2626;
    }
    
    .add-style-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-xl);
      background: var(--color-surface);
      border: 2px dashed var(--color-border-medium);
      border-radius: var(--radius-lg);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      aspect-ratio: 1;
    }
    
    .add-style-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-light);
    }
    
    .styles-count {
      text-align: center;
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      padding: var(--space-sm) 0 var(--space-md);
    }
    
    /* Footer - fixed at bottom */
    .app-footer {
      flex-shrink: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .story-builder-layout {
        grid-template-columns: minmax(240px, 1fr) minmax(350px, 2fr) minmax(240px, 1fr);
        gap: var(--space-lg);
        padding: var(--space-lg);
      }
    }
    
    @media (max-width: 900px) {
      .story-builder-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
    }
    
    /* ========================================
       STYLE PICKER MODAL
       ======================================== */
    
    .style-picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(62, 35, 24, 0.6);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .style-picker-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 64px rgba(62, 35, 24, 0.3);
    }
    
    /* Modal Header */
    .style-picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border-light);
      background: #3E2318;
      color: #FAF8F5;
    }
    
    .style-picker-title {
      font-family: 'Domine', var(--font-serif);
      font-size: 20px;
      font-weight: 500;
    }
    
    .style-picker-close {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #FAF8F5;
      transition: background 0.15s;
    }
    
    .style-picker-close:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* Style Finder Type Tabs */
    .style-picker-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-border-light);
      background: var(--color-tan-10);
    }
    
    .style-picker-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-muted);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
    }
    
    .style-picker-tab:hover {
      background: var(--color-tan-20);
      color: var(--color-text-primary);
    }
    
    .style-picker-tab.active {
      background: #3E2318;
      color: #FAF8F5;
    }
    
    .style-picker-tab.coming-soon {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .style-picker-tab.coming-soon::after {
      content: 'Soon';
      font-size: 10px;
      background: var(--color-tan-40);
      color: var(--color-text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    /* Modal Body */
    .style-picker-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Sidebar Facets */
    .style-picker-sidebar {
      width: 260px;
      border-right: 1px solid var(--color-border-light);
      overflow-y: auto;
      flex-shrink: 0;
      background: white;
    }
    
    .sp-search {
      padding: 16px;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .sp-search-input {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--color-tan-10);
      border-radius: 24px;
      padding: 10px 14px;
      width: 100%;
    }
    
    .sp-search-input svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    
    .sp-search-input input {
      border: none;
      background: transparent;
      font-size: 14px;
      outline: none;
      width: 100%;
      color: var(--color-text-primary);
    }
    
    .sp-search-input input::placeholder {
      color: var(--color-text-muted);
    }
    
    /* Facet Categories */
    .sp-facets {
      padding: 8px 0;
    }
    
    .sp-category {
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .sp-category:last-child {
      border-bottom: none;
    }
    
    .sp-category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    
    .sp-category-header:hover {
      background: var(--color-tan-10);
    }
    
    .sp-category-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sp-category-header svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      transition: transform 0.2s;
    }
    
    .sp-category.open .sp-category-header svg {
      transform: rotate(90deg);
    }
    
    .sp-category-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-primary);
    }
    
    .sp-category-count {
      font-size: 12px;
      color: var(--color-text-muted);
      background: var(--color-tan-10);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .sp-category-items {
      display: none;
      padding: 0 16px 12px 16px;
    }
    
    .sp-category.open .sp-category-items {
      display: block;
    }
    
    .sp-facet-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0 8px 24px;
      cursor: pointer;
      font-size: 13px;
      color: var(--color-text-secondary);
      transition: color 0.15s;
    }
    
    .sp-facet-item:hover {
      color: var(--color-accent);
    }
    
    .sp-facet-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-tan-40);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    
    .sp-facet-item.selected .sp-facet-checkbox {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }
    
    .sp-facet-item.selected .sp-facet-checkbox svg {
      display: block;
    }
    
    .sp-facet-checkbox svg {
      width: 10px;
      height: 10px;
      color: white;
      display: none;
    }
    
    /* Grid Area */
    .style-picker-grid-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--color-surface);
    }
    
    .sp-grid-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .sp-results-count {
      font-size: 14px;
      color: var(--color-text-muted);
    }
    
    .sp-reset-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: color 0.15s;
    }
    
    .sp-reset-btn:hover {
      color: var(--color-text-primary);
    }
    
    .sp-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    
    @media (max-width: 1100px) {
      .sp-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .sp-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .style-picker-sidebar {
        display: none;
      }
    }
    
    /* Style Card in Modal */
    .sp-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .sp-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(62, 35, 24, 0.15);
    }
    
    .sp-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .sp-card-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(transparent 50%, rgba(0,0,0,0.5));
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .sp-card:hover .sp-card-overlay {
      opacity: 1;
    }
    
    .sp-card-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .sp-card:hover .sp-card-name {
      opacity: 1;
    }
    
    /* Selected State */
    .sp-card.selected {
      box-shadow: 0 0 0 3px var(--color-accent);
    }
    
    .sp-card-selected-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: var(--color-accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s;
    }
    
    .sp-card.selected .sp-card-selected-badge {
      opacity: 1;
      transform: scale(1);
    }
    
    .sp-card-selected-badge svg {
      width: 16px;
      height: 16px;
      color: white;
    }
    
    /* Loading */
    .sp-loading {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }
    
    .sp-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-tan-20);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    /* Modal Footer */
    .style-picker-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-top: 1px solid var(--color-border-light);
      background: white;
    }
    
    .sp-selection-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .sp-selection-count {
      font-size: 14px;
      color: var(--color-text-secondary);
    }
    
    .sp-selection-count strong {
      color: var(--color-accent);
    }
    
    .sp-selected-previews {
      display: flex;
      gap: 4px;
    }
    
    .sp-selected-preview {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid var(--color-accent);
    }
    
    .sp-selected-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .sp-footer-actions {
      display: flex;
      gap: 12px;
    }
    
    .sp-cancel-btn {
      padding: 10px 24px;
      border: 1px solid var(--color-border-medium);
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sp-cancel-btn:hover {
      background: var(--color-tan-10);
    }
    
    .sp-done-btn {
      padding: 10px 24px;
      border: none;
      background: var(--color-accent);
      font-size: 14px;
      font-weight: 500;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sp-done-btn:hover {
      background: var(--color-accent-hover, #A82A10);
    }
    
    .sp-done-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Welcome State */
    .welcome-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-4xl) 30px;
    }
    
    .welcome-title {
      font-family: var(--font-serif);
      font-size: var(--text-2xl);
      font-weight: var(--weight-normal);
      color: var(--color-text-primary);
      margin-bottom: var(--space-lg);
      letter-spacing: var(--tracking-wider);
    }
    
    .welcome-text {
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      color: var(--color-text-muted);
      max-width: 380px;
      margin: 0;
    }
    
    .chat-input-area {
      padding: var(--space-lg) var(--space-xl);
      border-top: 1px solid var(--color-border-dark);
      flex-shrink: 0;
      display: flex;
      justify-content: center;
    }
    
    /* ========================================
       ChatGPT-STYLE INPUT SYSTEM
       ======================================== */
    
    .chat-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      background: var(--color-surface);
      border: 1px solid var(--color-border-medium);
      border-radius: 24px;
      padding: 8px 12px;
      transition: all 0.2s;
    }
    
    .chat-input-wrapper:focus-within {
      border-color: var(--color-border-dark);
      box-shadow: 0 0 0 2px rgba(62, 35, 24, 0.08);
    }
    
    /* Text Input Field */
    .chat-text-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: var(--text-base);
      padding: 8px 4px;
      background: transparent;
      min-width: 0;
    }
    
    .chat-text-input::placeholder {
      color: var(--color-text-muted);
    }
    
    /* Icon Buttons (Plus, Dictate, Speaker, Mic) */
    .input-icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      transition: all 0.15s;
      flex-shrink: 0;
      position: relative;
    }
    
    .input-icon-btn:hover {
      background: var(--color-tan-10);
      color: var(--color-text-primary);
    }
    
    .input-icon-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    /* Plus Button */
    .input-icon-btn.plus-btn {
      color: var(--color-text-secondary);
    }
    
    /* Dictate Button */
    .input-icon-btn.dictate-btn.active {
      color: var(--color-accent);
      background: var(--color-accent-light);
    }
    
    .dictate-pulse {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid var(--color-accent);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.4); opacity: 0; }
    }
    
    /* Speaker/Mic Muted State */
    .input-icon-btn.muted {
      color: #dc2626;
    }
    
    /* Voice Mode Button (Waveform) */
    .voice-mode-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--color-text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .voice-mode-btn:hover {
      background: var(--color-brown);
      transform: scale(1.05);
    }
    
    /* Voice End Button (Red with dots) */
    .voice-end-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      background: #dc2626;
      color: white;
      font-size: 14px;
      font-weight: var(--weight-medium);
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .voice-end-btn:hover {
      background: #b91c1c;
    }
    
    .voice-end-dots {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .voice-end-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: white;
      animation: dot-pulse 1s ease-in-out infinite;
    }
    
    .voice-end-dots span:nth-child(1) { animation-delay: 0s; }
    .voice-end-dots span:nth-child(2) { animation-delay: 0.15s; }
    .voice-end-dots span:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes dot-pulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    .voice-end-text {
      font-weight: var(--weight-semibold);
    }
    
    /* Future Feature Modal */
    .future-modal {
      max-width: 360px;
      text-align: center;
    }
    
    .future-modal h3 {
      font-family: var(--font-serif);
      font-size: var(--text-xl);
      margin-bottom: var(--space-md);
    }
    
    .future-modal p {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-lg);
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared/supabase-client.js"></script>
  
  <!-- Shared Components -->
  <script src="/js/shared/api.js"></script>
  <script src="/js/shared/auth.js"></script>
  <script src="/js/shared/projects.js"></script>
  <script src="/js/shared/header.js"></script>
  <script type="text/babel" src="/js/variations/variations.js"></script>
  <script type="text/babel" src="/js/story-builder/voice.js"></script>
  <script type="text/babel" src="/js/story-builder/story-panel.js"></script>
  <script src="/js/style-finder/style-data.js"></script>
  
  <!-- Story Builder App -->
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // ============================================
    // STYLE PICKER MODAL COMPONENT
    // ============================================
    
    // Medium categories for faceted navigation - uses AMD codes from art_mediums table
    const MEDIUM_CATEGORIES = {
      painting: {
        name: 'Painting',
        mediums: [
          { id: 'AMD001', name: 'Bold Paint (Oil/Acrylic)' },
          { id: 'AMD002', name: 'Fluid Paint (Watercolor)' },
          { id: 'AMD003', name: 'Flat Paint (Poster/Gouache)' }
        ]
      },
      drawing: {
        name: 'Drawing',
        mediums: [
          { id: 'AMD004', name: 'Sketch (Pencil/Graphite)' },
          { id: 'AMD005', name: 'Bold Line (Ink/Charcoal)' },
          { id: 'AMD006', name: 'Color Drawing (Pastel/Colored Pencil)' }
        ]
      },
      photography: {
        name: 'Photography',
        mediums: [
          { id: 'AMD007', name: 'Color Photography' },
          { id: 'AMD008', name: 'Black & White Photography' }
        ]
      },
      printmaking: {
        name: 'Printmaking',
        mediums: [
          { id: 'AMD009', name: 'Bold Carved Print (Woodcut/Linocut)' },
          { id: 'AMD010', name: 'Fine Line Print (Etching/Engraving)' },
          { id: 'AMD011', name: 'Poster Print (Screenprint)' }
        ]
      },
      collage: {
        name: 'Collage / Mixed Media',
        mediums: [
          { id: 'AMD012', name: 'Paper Collage' },
          { id: 'AMD013', name: 'Photo Collage' },
          { id: 'AMD014', name: 'Mixed Layers' }
        ]
      }
    };

    // Overlay styles
    const OVERLAYS = [
      { id: 'abstract', name: 'Abstract' },
      { id: 'realistic', name: 'Realistic' },
      { id: 'cinematic', name: 'Cinematic' },
      { id: 'experimental', name: 'Experimental' },
      { id: 'minimalist', name: 'Minimalist' },
      { id: 'whimsical', name: 'Whimsical' },
      { id: 'illustration', name: 'Illustration' },
      { id: 'historic', name: 'Historic' }
    ];

    function StylePickerModal({ isOpen, onClose, selectedStyles, onStylesChange, maxStyles = 4 }) {
      const [allStyles, setAllStyles] = useState([]);
      const [filteredStyles, setFilteredStyles] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedMediums, setSelectedMediums] = useState(new Set());
      const [selectedOverlays, setSelectedOverlays] = useState(new Set());
      const [expandedCategories, setExpandedCategories] = useState(new Set(['painting', 'drawing']));
      const [activeTab, setActiveTab] = useState('browse'); // browse, ai-match, mood, color
      const [tempSelected, setTempSelected] = useState(new Set(selectedStyles));

      // Load styles on mount
      useEffect(() => {
        if (isOpen) {
          loadStyles();
          setTempSelected(new Set(selectedStyles));
        }
      }, [isOpen, selectedStyles]);

      // Filter styles when search/filters change
      useEffect(() => {
        filterStyles();
      }, [searchTerm, selectedMediums, selectedOverlays, allStyles]);

      const loadStyles = async () => {
        setLoading(true);
        try {
          const { supabase } = window.SocietyArts;
          
          // Load styles
          const { data: stylesData, error } = await supabase
            .from('styles')
            .select('id, name, image_urls, status')
            .eq('is_active', true)
            .order('name')
            .limit(500);
          
          if (error) throw error;

          // Load art medium assignments from junction table
          const { data: artMediumLinks } = await supabase
            .from('style_art_mediums')
            .select('style_id, art_medium_id');

          // Build a map of style_id -> array of art_medium_ids
          const artMediumMap = {};
          if (artMediumLinks) {
            artMediumLinks.forEach(link => {
              if (!artMediumMap[link.style_id]) {
                artMediumMap[link.style_id] = [];
              }
              artMediumMap[link.style_id].push(link.art_medium_id);
            });
          }

          // Merge art mediums with styles
          const stylesWithAttrs = stylesData.map(s => ({
            ...s,
            art_medium_ids: artMediumMap[s.id] || []
          }));

          setAllStyles(stylesWithAttrs);
          setFilteredStyles(stylesWithAttrs);
        } catch (error) {
          console.error('Error loading styles:', error);
        }
        setLoading(false);
      };

      const filterStyles = () => {
        let results = [...allStyles];

        // Search filter
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          results = results.filter(s => 
            s.name?.toLowerCase().includes(term) ||
            s.id?.toLowerCase().includes(term)
          );
        }

        // Medium filter - check if style has any of the selected art_medium_ids
        if (selectedMediums.size > 0) {
          results = results.filter(s => {
            // Check if any of the style's art_medium_ids match any selected medium
            return s.art_medium_ids?.some(amId => selectedMediums.has(amId));
          });
        }

        // Overlay filter (keeping for future use)
        if (selectedOverlays.size > 0) {
          results = results.filter(s => selectedOverlays.has(s.overlay));
        }

        setFilteredStyles(results);
      };

      const toggleMedium = (mediumId) => {
        const newSet = new Set(selectedMediums);
        if (newSet.has(mediumId)) {
          newSet.delete(mediumId);
        } else {
          newSet.add(mediumId);
        }
        setSelectedMediums(newSet);
      };

      const toggleOverlay = (overlayId) => {
        const newSet = new Set(selectedOverlays);
        if (newSet.has(overlayId)) {
          newSet.delete(overlayId);
        } else {
          newSet.add(overlayId);
        }
        setSelectedOverlays(newSet);
      };

      const toggleCategory = (catId) => {
        const newSet = new Set(expandedCategories);
        if (newSet.has(catId)) {
          newSet.delete(catId);
        } else {
          newSet.add(catId);
        }
        setExpandedCategories(newSet);
      };

      const toggleStyleSelection = (styleId) => {
        const newSet = new Set(tempSelected);
        if (newSet.has(styleId)) {
          newSet.delete(styleId);
        } else if (newSet.size < maxStyles) {
          newSet.add(styleId);
        }
        setTempSelected(newSet);
      };

      const resetFilters = () => {
        setSearchTerm('');
        setSelectedMediums(new Set());
        setSelectedOverlays(new Set());
      };

      const handleDone = () => {
        onStylesChange(Array.from(tempSelected));
        onClose();
      };

      const getStyleImage = (style) => {
        if (style.image_urls?.length > 0) {
          return style.image_urls[0];
        }
        return `https://pub-d4d49982f29749dea52e2eb37c29ad51.r2.dev/${style.id}/${style.id}_1.webp`;
      };

      if (!isOpen) return null;

      return (
        <div className="style-picker-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
          <div className="style-picker-modal">
            {/* Header */}
            <div className="style-picker-header">
              <span className="style-picker-title">Choose Your Styles</span>
              <button className="style-picker-close" onClick={onClose}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>

            {/* Style Finder Type Tabs */}
            <div className="style-picker-tabs">
              <button 
                className={`style-picker-tab ${activeTab === 'browse' ? 'active' : ''}`}
                onClick={() => setActiveTab('browse')}
              >
                Browse All
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                AI Match
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                By Mood
              </button>
              <button 
                className="style-picker-tab coming-soon"
                disabled
              >
                By Color
              </button>
            </div>

            {/* Body */}
            <div className="style-picker-body">
              {/* Sidebar with Facets */}
              <div className="style-picker-sidebar">
                {/* Search */}
                <div className="sp-search">
                  <div className="sp-search-input">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input 
                      type="text" 
                      placeholder="Search styles..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                  </div>
                </div>

                {/* Facets */}
                <div className="sp-facets">
                  {/* Medium Categories */}
                  {Object.entries(MEDIUM_CATEGORIES).map(([catId, category]) => (
                    <div key={catId} className={`sp-category ${expandedCategories.has(catId) ? 'open' : ''}`}>
                      <div className="sp-category-header" onClick={() => toggleCategory(catId)}>
                        <div className="sp-category-header-left">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                          </svg>
                          <h4>{category.name}</h4>
                        </div>
                        <span className="sp-category-count">
                          {category.mediums.reduce((sum, m) => {
                            const count = allStyles.filter(s => s.art_medium_ids?.includes(m.id)).length;
                            return sum + count;
                          }, 0)}
                        </span>
                      </div>
                      <div className="sp-category-items">
                        {category.mediums.map(medium => (
                          <div 
                            key={medium.id}
                            className={`sp-facet-item ${selectedMediums.has(medium.id) ? 'selected' : ''}`}
                            onClick={() => toggleMedium(medium.id)}
                          >
                            <div className="sp-facet-checkbox">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            </div>
                            <span>{medium.name}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}

                  {/* Overlays */}
                  <div className={`sp-category ${expandedCategories.has('overlays') ? 'open' : ''}`}>
                    <div className="sp-category-header" onClick={() => toggleCategory('overlays')}>
                      <div className="sp-category-header-left">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <h4>Style</h4>
                      </div>
                      <span className="sp-category-count">{OVERLAYS.length}</span>
                    </div>
                    <div className="sp-category-items">
                      {OVERLAYS.map(overlay => (
                        <div 
                          key={overlay.id}
                          className={`sp-facet-item ${selectedOverlays.has(overlay.id) ? 'selected' : ''}`}
                          onClick={() => toggleOverlay(overlay.id)}
                        >
                          <div className="sp-facet-checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                              <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                          </div>
                          <span>{overlay.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* Grid Area */}
              <div className="style-picker-grid-area">
                <div className="sp-grid-header">
                  <span className="sp-results-count">
                    {filteredStyles.length} styles {(selectedMediums.size > 0 || selectedOverlays.size > 0 || searchTerm) && '(filtered)'}
                  </span>
                  {(selectedMediums.size > 0 || selectedOverlays.size > 0 || searchTerm) && (
                    <button className="sp-reset-btn" onClick={resetFilters}>Reset filters</button>
                  )}
                </div>

                <div className="sp-grid">
                  {loading ? (
                    <div className="sp-loading">
                      <div className="sp-spinner"></div>
                    </div>
                  ) : (
                    filteredStyles.map(style => (
                      <div 
                        key={style.id}
                        className={`sp-card ${tempSelected.has(style.id) ? 'selected' : ''}`}
                        onClick={() => toggleStyleSelection(style.id)}
                      >
                        <img 
                          src={getStyleImage(style)} 
                          alt={style.name}
                          loading="lazy"
                          onError={(e) => {
                            e.target.src = `https://pub-d4d49982f29749dea52e2eb37c29ad51.r2.dev/${style.id}/${style.id}_1.webp`;
                          }}
                        />
                        <div className="sp-card-overlay"></div>
                        <div className="sp-card-name">{style.name}</div>
                        <div className="sp-card-selected-badge">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            {/* Footer */}
            <div className="style-picker-footer">
              <div className="sp-selection-info">
                <span className="sp-selection-count">
                  <strong>{tempSelected.size}</strong> of {maxStyles} styles selected
                </span>
                {tempSelected.size > 0 && (
                  <div className="sp-selected-previews">
                    {Array.from(tempSelected).slice(0, 4).map(styleId => {
                      const style = allStyles.find(s => s.id === styleId);
                      return style ? (
                        <div key={styleId} className="sp-selected-preview">
                          <img src={getStyleImage(style)} alt={style.name} />
                        </div>
                      ) : null;
                    })}
                  </div>
                )}
              </div>
              <div className="sp-footer-actions">
                <button className="sp-cancel-btn" onClick={onClose}>Cancel</button>
                <button 
                  className="sp-done-btn" 
                  onClick={handleDone}
                >
                  Done
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // STORY BUILDER APP
    // ============================================

    function StoryBuilderApp() {
      // Get shared components inside the function to ensure they're loaded
      const { Header, Sidebar, Footer, FormatSelector, Icons } = window.SocietyArts || {};
      const { API, Voice, StoryPanel, Variations, StyleData, SaveProjectModal } = window.SocietyArts || {};
      
      // Auth state
      const { user, profile } = window.SocietyArts?.useAuth ? 
        window.SocietyArts.useAuth() : { user: null, profile: null };
      
      // Loading check
      if (!Sidebar || !Header) {
        return React.createElement('div', { className: 'loading-state' }, 'Loading...');
      }
      
      // Project state
      const [projectId, setProjectId] = useState(null);
      const [isDirty, setIsDirty] = useState(false);
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [pendingAction, setPendingAction] = useState(null);
      const [styleDetails, setStyleDetails] = useState({}); // Cache for loaded style data
      
      // Core state
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [story, setStory] = useState('');
      const [title, setTitle] = useState(null);
      const [transformedStory, setTransformedStory] = useState(null);
      const [transformLabel, setTransformLabel] = useState(null);
      const [selectedStyles, setSelectedStyles] = useState([]);
      const [aspectRatio, setAspectRatio] = useState('1:1');
      const [hasStarted, setHasStarted] = useState(false);
      const [voiceMode, setVoiceMode] = useState(false);
      const [styleFinderOpen, setStyleFinderOpen] = useState(false);
      const [showChatInfo, setShowChatInfo] = useState(false);
      const [showStylesInfo, setShowStylesInfo] = useState(false);
      
      const messagesEndRef = useRef(null);
      const extractionTimeoutRef = useRef(null);

      // Load project from URL on mount
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const projectIdParam = params.get('project');
        if (projectIdParam && user) {
          loadProjectById(projectIdParam);
        }
      }, [user]);

      // Load a project by ID
      const loadProjectById = async (id) => {
        try {
          const project = await window.SocietyArts.loadProject(id);
          if (project) {
            setProjectId(project.id);
            setTitle(project.title);
            setStory(project.story || '');
            setTransformedStory(project.transformed_story);
            setTransformLabel(project.transform_label);
            setSelectedStyles(project.selected_styles || []);
            setAspectRatio(project.aspect_ratio || '1:1');
            setMessages(project.chat_history || []);
            setHasStarted(project.chat_history?.length > 0 || !!project.story);
            setIsDirty(false);
            
            // Load style details for selected styles
            if (project.selected_styles?.length > 0) {
              loadStyleDetails(project.selected_styles);
            }
          }
        } catch (error) {
          console.error('Failed to load project:', error);
        }
      };

      // Load style details from database
      const loadStyleDetails = async (styleIds) => {
        if (!window.SocietyArts.supabase) return;
        
        const { data } = await window.SocietyArts.supabase
          .from('styles')
          .select('id, name, image_urls')
          .in('id', styleIds);
        
        if (data) {
          const details = {};
          data.forEach(style => {
            details[style.id] = style;
          });
          setStyleDetails(prev => ({ ...prev, ...details }));
        }
      };

      // Mark as dirty when state changes
      useEffect(() => {
        if (hasStarted) {
          setIsDirty(true);
        }
      }, [story, title, selectedStyles, messages, aspectRatio, transformedStory]);

      // Save project
      const saveCurrentProject = async () => {
        if (!user) {
          alert('Please sign in to save your project');
          return false;
        }

        try {
          const projectData = {
            id: projectId,
            title: title || 'Untitled Project',
            story,
            transformedStory,
            transformLabel,
            aspectRatio,
            selectedStyles,
            chatHistory: messages,
            status: story ? 'in_progress' : 'draft'
          };

          const saved = await window.SocietyArts.saveProject(projectData);
          setProjectId(saved.id);
          setIsDirty(false);
          
          // Update URL without reload
          const newUrl = `/story-builder.html?project=${saved.id}`;
          window.history.replaceState({}, '', newUrl);
          
          return true;
        } catch (error) {
          console.error('Failed to save project:', error);
          alert('Failed to save project. Please try again.');
          return false;
        }
      };

      // Voice callbacks
      const handleVoiceUserMessage = useCallback((content) => {
        if (!hasStarted) setHasStarted(true);
        setMessages(prev => [...prev, { role: 'user', content }]);
      }, [hasStarted]);

      const handleVoiceAssistantMessage = useCallback((content) => {
        setMessages(prev => [...prev, { role: 'assistant', content }]);
        
        if (extractionTimeoutRef.current) {
          clearTimeout(extractionTimeoutRef.current);
        }
        extractionTimeoutRef.current = setTimeout(() => {
          extractStoryFromConversation();
        }, 1000);
      }, []);

      // Voice Interface
      const voice = Voice.useVoiceInterface({
        onUserMessage: handleVoiceUserMessage,
        onAssistantMessage: handleVoiceAssistantMessage,
      });

      // Extract story from voice conversation
      const extractStoryFromConversation = async () => {
        const conversationText = messages.map(m => `${m.role}: ${m.content}`).join('\n');
        if (conversationText.length < 50) return;

        try {
          const data = await API.callClaude([{
            role: 'user',
            content: `${API.prompts.storyExtraction}\n\nConversation:\n${conversationText}`
          }], 500);

          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            if (parsed) {
              if (parsed.title && !title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
            }
          }
        } catch (err) {
          console.error('Story extraction error:', err);
        }
      };

      // Scroll to bottom
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Re-extract when messages change
      useEffect(() => {
        if (voiceMode && messages.length >= 4 && messages.length % 2 === 0) {
          extractStoryFromConversation();
        }
      }, [messages, voiceMode]);

      // Handlers
      const handleNewProject = () => {
        // If there's unsaved work, ask to save first
        if (isDirty && (title || story || messages.length > 0)) {
          setPendingAction('new');
          setShowSaveModal(true);
          return;
        }
        
        resetProject();
      };

      const resetProject = () => {
        setProjectId(null);
        setMessages([]);
        setInputValue('');
        setIsLoading(false);
        setStory('');
        setTitle(null);
        setTransformedStory(null);
        setTransformLabel(null);
        setSelectedStyles([]);
        setAspectRatio('1:1');
        setHasStarted(false);
        setVoiceMode(false);
        setIsDirty(false);
        voice.disconnect();
        
        // Clear URL parameter
        window.history.replaceState({}, '', '/story-builder.html');
      };

      const handleSaveAndContinue = async () => {
        const saved = await saveCurrentProject();
        setShowSaveModal(false);
        
        if (pendingAction === 'new') {
          resetProject();
        }
        setPendingAction(null);
      };

      const handleDiscardAndContinue = () => {
        setShowSaveModal(false);
        
        if (pendingAction === 'new') {
          resetProject();
        }
        setPendingAction(null);
      };

      const toggleVoiceMode = async (enable) => {
        if (!enable && voiceMode) {
          voice.disconnect();
          setVoiceMode(false);
        } else if (enable && !voiceMode) {
          try {
            setVoiceMode(true); // Show voice UI immediately
            setHasStarted(true);
            await voice.connect();
          } catch (err) {
            console.error('Failed to enable voice mode:', err);
            setVoiceMode(false);
            alert('Failed to connect to voice service. Please try again.');
          }
        }
      };

      // Auto-start listening when voice connects
      useEffect(() => {
        if (voiceMode && voice.isConnected && !voice.isListening && !voice.isSpeaking) {
          const timer = setTimeout(() => {
            voice.startListening();
          }, 300);
          return () => clearTimeout(timer);
        }
      }, [voiceMode, voice.isConnected]);

      const sendMessage = async () => {
        if (!inputValue.trim() || isLoading) return;
        
        // Require login to start a story
        if (!user) {
          window.SocietyArts?.openAuthModal?.();
          return;
        }

        if (!hasStarted) setHasStarted(true);

        const userMessage = { role: 'user', content: inputValue };
        const updatedMessages = [...messages, userMessage];
        setMessages(updatedMessages);
        setInputValue('');
        setIsLoading(true);

        try {
          let contextMessage = '';
          if (story) {
            contextMessage = `\n\n[CURRENT STORY STATE: "${story}"]\n[CURRENT TITLE: "${title || 'None yet'}"]\n\nIf the user is requesting a modification, update the story accordingly.`;
          }

          const userPrompt = updatedMessages.map(m => `${m.role}: ${m.content}`).join('\n');

          const data = await API.callClaude([{ 
            role: 'user', 
            content: `${API.prompts.storyBuilder}${contextMessage}\n\n---\nConversation so far:\n${userPrompt}\n\nRespond as the assistant with valid JSON only.`
          }]);
          
          if (data.content && data.content[0]) {
            const parsed = API.parseJSON(data.content[0].text);
            
            if (parsed) {
              if (parsed.title) setTitle(parsed.title);
              if (parsed.story) setStory(parsed.story);
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: parsed.message || "I'd love to hear more about your vision!"
              }]);
            } else {
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: data.content[0].text
              }]);
            }
          }
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I apologize, but I'm having trouble connecting right now. Please try again in a moment."
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      // Handle variation applied - updates the transformed story
      const handleVariationApplied = (newStory, label) => {
        setTransformedStory(newStory);
        setTransformLabel(label);
      };

      // Clear transformation and go back to original
      const handleClearTransform = () => {
        setTransformedStory(null);
        setTransformLabel(null);
      };

      const toggleStyle = (styleId) => {
        setSelectedStyles(prev => {
          if (prev.includes(styleId)) {
            return prev.filter(id => id !== styleId);
          }
          if (prev.length >= 4) {
            return prev; // Max 4 styles
          }
          return [...prev, styleId];
        });
      };

      const removeStyle = (styleId) => {
        setSelectedStyles(prev => prev.filter(id => id !== styleId));
      };

      // Get style image URL
      const getStyleImage = (styleId) => {
        const cached = styleDetails[styleId];
        if (cached?.image_urls?.length > 0) {
          return cached.image_urls[0];
        }
        return `https://pub-d4d49982f29749dea52e2eb37c29ad51.r2.dev/${styleId}/${styleId}_1.webp`;
      };

      // Get style name
      const getStyleName = (styleId) => {
        const cached = styleDetails[styleId];
        if (cached?.name) {
          return cached.name;
        }
        // Convert ID to readable name
        return styleId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      };

      // Calculate progress
      const hasStory = story && story.trim().length > 0;
      const progress = hasStory 
        ? (selectedStyles.length > 0 ? 100 : 50) 
        : (hasStarted ? 15 : 5);

      return (
        <div className="page-container">
          <Sidebar />
          <Header />
          
          <main className="main-content story-builder-layout">
            {/* Left Column - Story Panel */}
            <StoryPanel.StoryPanel
              story={story}
              title={title}
              isVoiceMode={voiceMode}
              isLoading={isLoading}
              transformedStory={transformedStory}
              transformLabel={transformLabel}
              onVariationApplied={handleVariationApplied}
              onClearTransform={handleClearTransform}
              onStoryChange={(newStory) => {
                // If editing transformed story, clear transform first
                if (transformedStory) {
                  setTransformedStory(newStory);
                } else {
                  setStory(newStory);
                }
              }}
            />
            
            {/* Center Column - Chat */}
            <div className="chat-container">
              {title ? (
                <div className="chat-title-bar">
                  <span>{title}</span>
                  <button 
                    className="chat-info-btn"
                    onClick={() => setShowChatInfo(!showChatInfo)}
                    title="About this panel"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="16" x2="12" y2="12"></line>
                      <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                  </button>
                </div>
              ) : (
                <div className="chat-title-bar-empty">
                  <span>Your Story Title</span>
                  <button 
                    className="chat-info-btn"
                    onClick={() => setShowChatInfo(!showChatInfo)}
                    title="About this panel"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="16" x2="12" y2="12"></line>
                      <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                  </button>
                </div>
              )}
              
              {showChatInfo && (
                <div style={{
                  position: 'absolute',
                  top: '56px',
                  right: 'var(--space-md)',
                  zIndex: 100,
                  width: '280px',
                  background: 'white',
                  borderRadius: 'var(--radius-lg)',
                  padding: 'var(--space-lg)',
                  boxShadow: '0 8px 32px rgba(62, 35, 24, 0.15)',
                  border: '1px solid var(--color-border-light)'
                }}>
                  <h4 style={{ fontFamily: 'var(--font-serif)', fontSize: 'var(--text-base)', margin: '0 0 var(--space-sm) 0' }}>Your Story Title</h4>
                  <p style={{ fontSize: 'var(--text-sm)', color: 'var(--color-text-secondary)', margin: '0 0 var(--space-md) 0', lineHeight: 1.5 }}>
                    As you share your story through conversation, I'll automatically generate a title that captures the essence of your narrative.
                  </p>
                  <p style={{ fontSize: 'var(--text-sm)', color: 'var(--color-text-secondary)', margin: '0 0 var(--space-md) 0', lineHeight: 1.5 }}>
                    The title bar will turn dark when your story has developed enough for me to name it.
                  </p>
                  <button 
                    onClick={() => setShowChatInfo(false)}
                    style={{
                      background: 'var(--color-tan-10)',
                      border: 'none',
                      padding: '8px 16px',
                      borderRadius: 'var(--radius-md)',
                      fontSize: 'var(--text-sm)',
                      cursor: 'pointer',
                      width: '100%'
                    }}
                  >
                    Got it
                  </button>
                </div>
              )}
              
              <div className="messages-container">
                {!hasStarted ? (
                  <div className="welcome-container">
                    <h2 className="welcome-title">Welcome to Society Arts.</h2>
                    <p className="welcome-text">
                      I'm here to help create your beautiful work of art from your own idea or personal story. Let me know when you're ready to begin.
                    </p>
                  </div>
                ) : (
                  <>
                    {messages.map((msg, index) => (
                      <div key={index} className={`message message-${msg.role}`}>
                        <div className={`message-bubble message-bubble-${msg.role}`}>
                          {msg.content}
                        </div>
                      </div>
                    ))}
                    {(isLoading || (voiceMode && voice.isListening)) && (
                      <div className="message message-assistant">
                        <div className="typing-indicator">
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                          <div className="typing-dot"></div>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </>
                )}
              </div>
              
              {/* Input always at bottom */}
              <div className="chat-input-area">
                <Voice.UnifiedInput
                  voiceMode={voiceMode}
                  onToggleMode={toggleVoiceMode}
                  inputValue={inputValue}
                  onInputChange={setInputValue}
                  onSendMessage={sendMessage}
                  isLoading={isLoading}
                  voice={voice}
                  placeholder={hasStarted ? "Continue your story..." : "Start your story..."}
                  onRequireAuth={() => {
                    if (!user) {
                      window.SocietyArts?.openAuthModal?.();
                    }
                  }}
                />
              </div>
            </div>
            
            {/* Right Column - Styles */}
            <div className="styles-column">
              <div className={`styles-panel-header ${selectedStyles.length > 0 ? 'has-styles' : ''}`}>
                <span className="styles-panel-title">Your Styles</span>
                <button 
                  className="styles-info-btn"
                  onClick={() => setShowStylesInfo(!showStylesInfo)}
                  title="About this panel"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                </button>
                
                {showStylesInfo && (
                  <div className="styles-info-tooltip">
                    <h4 style={{ fontFamily: 'var(--font-serif)', fontSize: 'var(--text-base)', margin: '0 0 var(--space-sm) 0' }}>Your Styles</h4>
                    <p style={{ fontSize: 'var(--text-sm)', color: 'var(--color-text-secondary)', margin: '0 0 var(--space-md) 0', lineHeight: 1.5 }}>
                      Select up to 4 artistic styles that will influence how your story becomes a visual artwork.
                    </p>
                    <p style={{ fontSize: 'var(--text-sm)', color: 'var(--color-text-secondary)', margin: '0 0 var(--space-md) 0', lineHeight: 1.5 }}>
                      Click "Add Style" to browse our collection and find the perfect aesthetic for your vision.
                    </p>
                    <button 
                      onClick={() => setShowStylesInfo(false)}
                      style={{
                        background: 'var(--color-tan-10)',
                        border: 'none',
                        padding: '8px 16px',
                        borderRadius: 'var(--radius-md)',
                        fontSize: 'var(--text-sm)',
                        cursor: 'pointer',
                        width: '100%'
                      }}
                    >
                      Got it
                    </button>
                  </div>
                )}
              </div>
              
              <div className="styles-list">
                {selectedStyles.map((styleId) => (
                  <div 
                    key={styleId}
                    className="style-list-item selected"
                    onClick={() => {
                      // TODO: Open style detail modal
                    }}
                  >
                    <img 
                      src={getStyleImage(styleId)} 
                      alt={getStyleName(styleId)}
                      onError={(e) => {
                        e.target.src = `https://pub-d4d49982f29749dea52e2eb37c29ad51.r2.dev/${styleId}/${styleId}_1.webp`;
                      }}
                    />
                    <button 
                      className="style-remove-btn" 
                      onClick={(e) => {
                        e.stopPropagation();
                        removeStyle(styleId);
                      }}
                      title="Remove style"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                    <div className="style-list-overlay">
                      <div className="style-list-name">{getStyleName(styleId)}</div>
                    </div>
                  </div>
                ))}
                
                {selectedStyles.length < 4 && (
                  <button 
                    className="add-style-btn"
                    onClick={() => setStyleFinderOpen(true)}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Style
                  </button>
                )}
              </div>
              
              {selectedStyles.length > 0 && (
                <div className="styles-count">
                  {selectedStyles.length} of 4 styles selected
                </div>
              )}
            </div>
          </main>
          
          <Footer onNewChat={title ? handleNewProject : undefined}>
            {user && (title || story) && (
              <button 
                className="btn btn-secondary"
                onClick={saveCurrentProject}
              >
                {isDirty ? 'Save Project' : 'Saved '}
              </button>
            )}
            <button 
              className="btn btn-primary"
              style={{ opacity: story && selectedStyles.length > 0 ? 1 : 0.6 }}
              disabled={!story || selectedStyles.length === 0}
            >
              Create
              <Icons.arrowRight />
            </button>
          </Footer>
          
          {/* Save Confirmation Modal */}
          {SaveProjectModal && (
            <SaveProjectModal
              isOpen={showSaveModal}
              onClose={() => setShowSaveModal(false)}
              onSave={handleSaveAndContinue}
              onDiscard={handleDiscardAndContinue}
              projectTitle={title}
            />
          )}
          
          {/* Style Picker Modal */}
          <StylePickerModal
            isOpen={styleFinderOpen}
            onClose={() => setStyleFinderOpen(false)}
            selectedStyles={selectedStyles}
            onStylesChange={(styles) => {
              setSelectedStyles(styles);
              setIsDirty(true);
              // Load style details for new selections
              if (styles.length > 0) {
                loadStyleDetails(styles);
              }
            }}
            maxStyles={4}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    
    // Wait for all components to be loaded and auth initialized
    function waitForComponents(callback, maxAttempts = 50) {
      let attempts = 0;
      const check = () => {
        attempts++;
        if (window.SocietyArts?.Sidebar && window.SocietyArts?.Header && window.SocietyArts?.Voice) {
          // Initialize auth before rendering
          if (window.initializeAuth && !window.AuthState?.initialized) {
            window.initializeAuth().then(callback);
          } else {
            callback();
          }
        } else if (attempts < maxAttempts) {
          setTimeout(check, 100);
        } else {
          console.error('Components failed to load');
          callback(); // Try anyway
        }
      };
      check();
    }
    
    waitForComponents(() => {
      root.render(<StoryBuilderApp />);
    });
  </script>
</body>
</html>
