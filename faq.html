<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAQ - Society Arts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  
  <style>
    .faq-content {
      flex: 1;
      padding: var(--space-2xl);
      max-width: 900px;
      overflow-y: auto;
    }
    
    .faq-header {
      margin-bottom: var(--space-2xl);
    }
    
    .faq-breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      margin-bottom: var(--space-md);
    }
    
    .faq-breadcrumb a {
      color: var(--color-text-muted);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .faq-breadcrumb a:hover {
      color: var(--color-accent);
    }
    
    .faq-title {
      font-family: var(--font-serif);
      font-size: var(--text-3xl);
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .faq-subtitle {
      font-size: var(--text-base);
      color: var(--color-text-muted);
      margin: 0;
    }
    
    /* Search */
    .faq-search {
      margin-bottom: var(--space-2xl);
    }
    
    .faq-search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .faq-search-icon {
      position: absolute;
      left: 16px;
      width: 20px;
      height: 20px;
      color: var(--color-text-light);
      pointer-events: none;
    }
    
    .faq-search-input {
      width: 100%;
      padding: 14px 48px 14px 48px;
      font-family: var(--font-primary);
      font-size: var(--text-base);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      background: white;
      color: var(--color-text-primary);
      transition: all 0.2s ease;
    }
    
    .faq-search-input:focus {
      outline: none;
      border-color: var(--color-tan-40);
      box-shadow: 0 0 0 3px rgba(196, 181, 165, 0.2);
    }
    
    .faq-search-input::placeholder {
      color: var(--color-text-light);
    }
    
    .faq-search-clear {
      position: absolute;
      right: 12px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-surface-alt);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      color: var(--color-text-secondary);
      transition: all 0.15s ease;
      opacity: 0;
      pointer-events: none;
    }
    
    .faq-search-clear.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    .faq-search-clear:hover {
      background: var(--color-tan-20);
      color: var(--color-text-primary);
    }
    
    .faq-search-info {
      margin-top: var(--space-sm);
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    
    .faq-search-info strong {
      color: var(--color-text-primary);
    }
    
    /* FAQ Sections */
    .faq-sections {
      display: flex;
      flex-direction: column;
      gap: var(--space-2xl);
    }
    
    .faq-section {
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--color-border-light);
      overflow: hidden;
    }
    
    .faq-section-header {
      padding: var(--space-lg) var(--space-xl);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .faq-section-title {
      font-family: var(--font-serif);
      font-size: var(--text-lg);
      font-weight: var(--weight-semibold);
      color: var(--color-text-primary);
      margin: 0;
    }
    
    .faq-section-desc {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      margin: var(--space-xs) 0 0 0;
    }
    
    /* FAQ Items */
    .faq-list {
      display: flex;
      flex-direction: column;
    }
    
    .faq-item {
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .faq-item:last-child {
      border-bottom: none;
    }
    
    .faq-question {
      width: 100%;
      padding: var(--space-lg) var(--space-xl);
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-md);
      font-family: var(--font-primary);
      font-size: var(--text-base);
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
      line-height: 1.5;
      transition: background 0.15s ease;
    }
    
    .faq-question:hover {
      background: var(--color-surface-alt);
    }
    
    .faq-question-text {
      flex: 1;
    }
    
    .faq-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-light);
      transition: transform 0.25s ease, color 0.15s ease;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .faq-item.open .faq-icon {
      transform: rotate(180deg);
      color: var(--color-accent);
    }
    
    .faq-answer {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.3s ease;
    }
    
    .faq-item.open .faq-answer {
      grid-template-rows: 1fr;
    }
    
    .faq-answer-inner {
      overflow: hidden;
    }
    
    .faq-answer-content {
      padding: 0 var(--space-xl) var(--space-lg) var(--space-xl);
      color: var(--color-text-muted);
      line-height: 1.7;
    }
    
    .faq-answer-content strong {
      color: var(--color-text-primary);
      font-weight: var(--weight-semibold);
    }
    
    /* Highlight */
    .faq-highlight {
      background: rgba(199, 51, 20, 0.15);
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    /* No Results */
    .faq-no-results {
      text-align: center;
      padding: var(--space-3xl);
      background: var(--color-surface-alt);
      border-radius: var(--radius-xl);
    }
    
    .faq-no-results-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-lg);
      color: var(--color-text-light);
    }
    
    .faq-no-results-title {
      font-family: var(--font-serif);
      font-size: var(--text-xl);
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .faq-no-results-text {
      color: var(--color-text-muted);
      margin: 0;
    }
    
    /* CTA */
    .faq-cta {
      text-align: center;
      padding: var(--space-3xl);
      background: var(--color-tan-10);
      border-radius: var(--radius-xl);
      margin-top: var(--space-3xl);
    }
    
    .faq-cta-title {
      font-family: var(--font-serif);
      font-size: var(--text-xl);
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .faq-cta-text {
      color: var(--color-text-muted);
      margin: 0 0 var(--space-lg) 0;
    }
    
    .faq-cta-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      color: var(--color-accent);
      font-weight: var(--weight-semibold);
      text-decoration: none;
      transition: gap 0.2s ease;
    }
    
    .faq-cta-link:hover {
      gap: var(--space-md);
    }
    
    /* Loading */
    .faq-loading {
      text-align: center;
      padding: var(--space-3xl);
    }
    
    .faq-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border-light);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      margin: 0 auto var(--space-lg);
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .faq-loading-text {
      color: var(--color-text-muted);
    }
    
    /* Error */
    .faq-error {
      text-align: center;
      padding: var(--space-2xl);
      background: #FEF2F2;
      border: 1px solid #FECACA;
      border-radius: var(--radius-xl);
    }
    
    .faq-error-title {
      font-weight: var(--weight-semibold);
      color: #991B1B;
      margin: 0 0 var(--space-sm) 0;
    }
    
    .faq-error-text {
      color: #B91C1C;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .faq-content {
        padding: var(--space-lg);
      }
      
      .faq-title {
        font-size: var(--text-2xl);
      }
      
      .faq-question {
        padding: var(--space-md);
      }
      
      .faq-answer-content {
        padding: 0 var(--space-md) var(--space-md);
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared/supabase-client.js"></script>
  <script src="/js/shared/api.js"></script>
  <script src="/js/shared/auth.js"></script>
  <script src="/js/shared/header.js"></script>
  
  <!-- FAQ Page -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;
    
    // Icons
    const SearchIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    );
    
    const XIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    
    const ChevronDownIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );
    
    const ChevronIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );
    
    const SearchOffIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        <line x1="8" y1="8" x2="14" y2="14"></line>
        <line x1="14" y1="8" x2="8" y2="14"></line>
      </svg>
    );
    
    const ArrowRightIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    );
    
    // Highlight helper
    function highlightText(text, query) {
      if (!query || query.length < 2) return text;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const parts = text.split(regex);
      return parts.map((part, i) => 
        regex.test(part) ? <span key={i} className="faq-highlight">{part}</span> : part
      );
    }
    
    // FAQ Item Component
    function FAQItem({ faq, searchQuery, isOpen, onToggle }) {
      return (
        <div className={`faq-item ${isOpen ? 'open' : ''}`}>
          <button className="faq-question" onClick={onToggle}>
            <span className="faq-question-text">
              {highlightText(faq.question, searchQuery)}
            </span>
            <span className="faq-icon"><ChevronDownIcon /></span>
          </button>
          <div className="faq-answer">
            <div className="faq-answer-inner">
              <div 
                className="faq-answer-content"
                dangerouslySetInnerHTML={{ 
                  __html: searchQuery && searchQuery.length >= 2
                    ? faq.answer.replace(
                        new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
                        '<span class="faq-highlight">$1</span>'
                      )
                    : faq.answer 
                }}
              />
            </div>
          </div>
        </div>
      );
    }
    
    // Main FAQ Page
    function FAQPage() {
      const { Header, Sidebar } = window.SocietyArts || {};
      const supabase = window.SocietyArts?.supabase;
      
      if (!Sidebar || !Header) {
        return React.createElement('div', { className: 'loading-state' }, 'Loading...');
      }
      
      const { user, profile, isLoading: authLoading } = window.SocietyArts.useAuth();
      
      const [categories, setCategories] = useState([]);
      const [faqs, setFaqs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [openItems, setOpenItems] = useState(new Set());
      
      // Fetch FAQ data
      useEffect(() => {
        async function fetchFAQs() {
          if (!supabase) {
            setError('Database connection not available');
            setLoading(false);
            return;
          }
          
          try {
            const { data: categoriesData, error: categoriesError } = await supabase
              .from('faq_categories')
              .select('*')
              .eq('is_active', true)
              .order('sort_order');
            
            if (categoriesError) throw categoriesError;
            
            const { data: faqsData, error: faqsError } = await supabase
              .from('faq')
              .select('*')
              .eq('is_published', true)
              .order('priority');
            
            if (faqsError) throw faqsError;
            
            setCategories(categoriesData || []);
            setFaqs(faqsData || []);
          } catch (err) {
            console.error('Error fetching FAQs:', err);
            setError(err.message);
          } finally {
            setLoading(false);
          }
        }
        
        fetchFAQs();
      }, [supabase]);
      
      // Filter FAQs
      const filteredData = useMemo(() => {
        const query = searchQuery.toLowerCase().trim();
        
        if (!query || query.length < 2) {
          return categories.map(category => ({
            category,
            faqs: faqs.filter(faq => faq.category_id === category.id)
          })).filter(group => group.faqs.length > 0);
        }
        
// Search across question, answer, AND keywords
const matchingFaqs = faqs.filter(faq => {
  const questionMatch = faq.question.toLowerCase().includes(query);
  const answerMatch = faq.answer.toLowerCase().includes(query);
  const keywordMatch = faq.keywords && faq.keywords.toLowerCase().includes(query);
  return questionMatch || answerMatch || keywordMatch;
});

// Sort by relevance: keyword matches first, then question, then answer
matchingFaqs.sort((a, b) => {
  const aKeyword = a.keywords && a.keywords.toLowerCase().includes(query) ? 0 : 1;
  const bKeyword = b.keywords && b.keywords.toLowerCase().includes(query) ? 0 : 1;
  if (aKeyword !== bKeyword) return aKeyword - bKeyword;
  
  const aQuestion = a.question.toLowerCase().includes(query) ? 0 : 1;
  const bQuestion = b.question.toLowerCase().includes(query) ? 0 : 1;
  if (aQuestion !== bQuestion) return aQuestion - bQuestion;
  
  return a.priority - b.priority;
});
        
        return categories.map(category => ({
          category,
          faqs: matchingFaqs.filter(faq => faq.category_id === category.id)
        })).filter(group => group.faqs.length > 0);
      }, [categories, faqs, searchQuery]);
      
      const totalMatches = useMemo(() => {
        return filteredData.reduce((sum, group) => sum + group.faqs.length, 0);
      }, [filteredData]);
      
      const toggleItem = useCallback((faqId) => {
        setOpenItems(prev => {
          const next = new Set(prev);
          if (next.has(faqId)) {
            next.delete(faqId);
          } else {
            next.add(faqId);
          }
          return next;
        });
      }, []);
      
      const clearSearch = useCallback(() => {
        setSearchQuery('');
      }, []);
      
      return (
        <div className="page-container">
          <Sidebar />
          <Header user={user} profile={profile} />
          
          <main className="faq-content">
            {/* Breadcrumb */}
            <div className="faq-breadcrumb">
              <a href="index.html">Home</a>
              <ChevronIcon />
              <span>FAQ</span>
            </div>
            
            <div className="faq-header">
              <h1 className="faq-title">Frequently Asked Questions</h1>
              <p className="faq-subtitle">Find answers to common questions about Society Arts</p>
            </div>
            
            <div className="faq-search">
              <div className="faq-search-wrapper">
                <span className="faq-search-icon"><SearchIcon /></span>
                <input
                  type="text"
                  className="faq-search-input"
                  placeholder="Search questions..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button 
                  className={`faq-search-clear ${searchQuery ? 'visible' : ''}`}
                  onClick={clearSearch}
                  aria-label="Clear search"
                >
                  <XIcon />
                </button>
              </div>
              {searchQuery && searchQuery.length >= 2 && (
                <div className="faq-search-info">
                  Found <strong>{totalMatches}</strong> result{totalMatches !== 1 ? 's' : ''} for "{searchQuery}"
                </div>
              )}
            </div>
            
            {loading && (
              <div className="faq-loading">
                <div className="faq-loading-spinner"></div>
                <p className="faq-loading-text">Loading FAQs...</p>
              </div>
            )}
            
            {error && !loading && (
              <div className="faq-error">
                <p className="faq-error-title">Unable to load FAQs</p>
                <p className="faq-error-text">{error}</p>
              </div>
            )}
            
            {!loading && !error && filteredData.length === 0 && (
              <div className="faq-no-results">
                <div className="faq-no-results-icon"><SearchOffIcon /></div>
                <h3 className="faq-no-results-title">No results found</h3>
                <p className="faq-no-results-text">
                  Try searching with different keywords or browse all questions below.
                </p>
              </div>
            )}
            
            {!loading && !error && filteredData.length > 0 && (
              <div className="faq-sections">
                {filteredData.map(({ category, faqs: categoryFaqs }) => (
                  <div key={category.id} className="faq-section">
                    <div className="faq-section-header">
                      <h2 className="faq-section-title">{category.name}</h2>
                      {category.description && (
                        <p className="faq-section-desc">{category.description}</p>
                      )}
                    </div>
                    <div className="faq-list">
                      {categoryFaqs.map(faq => (
                        <FAQItem
                          key={faq.id}
                          faq={faq}
                          searchQuery={searchQuery}
                          isOpen={openItems.has(faq.id)}
                          onToggle={() => toggleItem(faq.id)}
                        />
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {!loading && !error && (
              <div className="faq-cta">
                <h3 className="faq-cta-title">Still have questions?</h3>
                <p className="faq-cta-text">We're here to help you create beautiful art from your memories.</p>
                <a href="mailto:support@societyarts.com" className="faq-cta-link">
                  Contact Support <ArrowRightIcon />
                </a>
              </div>
            )}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    
    function waitForComponents(callback, maxAttempts = 50) {
      let attempts = 0;
      const check = () => {
        attempts++;
        if (window.SocietyArts?.Sidebar && window.SocietyArts?.Header && window.SocietyArts?.useAuth) {
          callback();
        } else if (attempts < maxAttempts) {
          setTimeout(check, 100);
        } else {
          console.error('Components failed to load');
          callback();
        }
      };
      check();
    }
    
    waitForComponents(() => {
      root.render(<FAQPage />);
    });
  </script>
</body>
</html>
