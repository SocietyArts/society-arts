<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collections - Society Arts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Familjen+Grotesk:wght@400;500;600;700&family=Domine:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  
  <style>
    /* ===================================================
       COLLECTIONS PAGE - TYPOGRAPHIC SYSTEM
       Inspired by Art Center College of Design principles
       =================================================== */
    
    /* === Page Layout === */
    .collections-content {
      flex: 1;
      padding: var(--space-2xl);
      max-width: 1100px;
      overflow-y: auto;
    }
    
    /* === Breadcrumb Navigation === */
    .collections-breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.01em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-lg);
    }
    
    .collections-breadcrumb a {
      color: var(--color-text-muted);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .collections-breadcrumb a:hover {
      color: var(--color-accent);
    }
    
    .collections-breadcrumb span:last-child {
      color: var(--color-text-primary);
    }
    
    /* === Page Header === */
    .collections-header {
      margin-bottom: var(--space-3xl);
    }
    
    .collections-title {
      font-family: var(--font-serif);
      font-size: clamp(32px, 5vw, 42px);
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1.1;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .collections-subtitle {
      font-family: var(--font-sans);
      font-size: 16px;
      font-weight: 400;
      letter-spacing: 0.005em;
      line-height: 1.5;
      color: var(--color-text-muted);
      margin: 0;
    }
    
    /* === Collections Toolbar === */
    .collections-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
      padding: var(--space-md) 0;
    }
    
    .collections-toolbar-left {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .collections-toolbar-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    /* Add Collection Button */
    .btn-add-collection {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .btn-add-collection:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: rgba(192, 113, 91, 0.04);
    }
    
    .btn-add-collection svg {
      width: 16px;
      height: 16px;
    }
    
    /* Sort Dropdown */
    .sort-dropdown {
      position: relative;
    }
    
    .sort-dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .sort-dropdown-trigger:hover {
      border-color: var(--color-text-muted);
    }
    
    .sort-dropdown-trigger svg {
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }
    
    .sort-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 1000;
      animation: menuDropDown 0.15s ease;
      overflow: hidden;
    }
    
    .sort-dropdown-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--color-text-secondary);
      cursor: pointer;
      text-align: left;
      transition: background-color 0.1s ease;
    }
    
    .sort-dropdown-item:hover {
      background-color: var(--color-surface-alt);
    }
    
    .sort-dropdown-item.active {
      color: var(--color-accent);
      font-weight: 500;
    }
    
    .sort-dropdown-item svg {
      width: 14px;
      height: 14px;
      color: var(--color-accent);
    }
    
    /* View Toggle */
    .view-toggle {
      display: flex;
      align-items: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .view-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      background: white;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .view-toggle-btn:not(:last-child) {
      border-right: 1px solid var(--color-border);
    }
    
    .view-toggle-btn:hover {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }
    
    .view-toggle-btn.active {
      background: var(--color-tan-10);
      color: var(--color-accent);
    }
    
    .view-toggle-btn svg {
      width: 18px;
      height: 18px;
    }
    
    /* Responsive Toolbar */
    @media (max-width: 600px) {
      .collections-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
      }
      
      .collections-toolbar-left {
        justify-content: center;
      }
      
      .collections-toolbar-right {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .btn-add-collection {
        width: 100%;
        justify-content: center;
      }
      
      .sort-dropdown {
        flex: 1;
        min-width: 140px;
      }
      
      .sort-dropdown-trigger {
        width: 100%;
        justify-content: space-between;
      }
    }
    
    /* === View Transition Animations === */
    .collections-grid,
    .collections-table {
      animation: viewFadeIn 0.2s ease;
    }
    
    @keyframes viewFadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* === Focus States for Accessibility === */
    .btn-add-collection:focus-visible,
    .sort-dropdown-trigger:focus-visible,
    .view-toggle-btn:focus-visible,
    .collection-card:focus-visible,
    .table-kebab-btn:focus-visible,
    .collection-card-kebab:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    
    .sort-dropdown-item:focus-visible {
      outline: none;
      background-color: var(--color-surface-alt);
    }
    
    .collections-table tbody tr:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: -2px;
    }
    
    /* Make cards focusable */
    .collection-card {
      outline: none;
    }
    
    .collection-card:focus-visible {
      box-shadow: 0 0 0 3px var(--color-accent);
    }
    
    /* === Collection Grid === */
    .collections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: var(--space-lg);
    }
    
    /* Grid for Compact View */
    .collections-grid.view-compact {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    /* Grid for Gallery View */
    .collections-grid.view-gallery {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: var(--space-xl);
    }
    
    /* === Collection Card (Spotify-Inspired) === */
    .collection-card {
      position: relative;
      aspect-ratio: 1.1;
      min-height: 180px;
      border-radius: 8px;
      padding: var(--space-xl) var(--space-xl) var(--space-md) var(--space-xl);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                  box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .collection-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 8px;
      background: linear-gradient(
        180deg,
        transparent 0%,
        rgba(0, 0, 0, 0.03) 100%
      );
      pointer-events: none;
    }
    
    .collection-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.12),
        0 8px 16px rgba(0, 0, 0, 0.08);
    }
    
    /* Card Content Wrapper (title + description) */
    .collection-card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    /* Card Typography - Light text on dark backgrounds */
    .collection-card.text-light .collection-card-name,
    .collection-card.text-light .collection-card-meta {
      color: white;
    }
    
    .collection-card.text-light .collection-card-name {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .collection-card.text-light .collection-card-meta {
      color: rgba(255, 255, 255, 0.75);
    }
    
    /* Card Typography - Dark text on light backgrounds */
    .collection-card.text-dark .collection-card-name {
      color: var(--color-text-primary);
      text-shadow: none;
    }
    
    .collection-card.text-dark .collection-card-meta {
      color: rgba(62, 35, 24, 0.6);
    }
    
    /* Collection Name Typography */
    .collection-card-name {
      font-family: var(--font-serif);
      font-size: clamp(22px, 3vw, 26px);
      font-weight: 600;
      letter-spacing: -0.015em;
      line-height: 1.15;
      margin: 0;
      word-break: break-word;
      hyphens: auto;
      /* Limit to 2 lines when description present */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Collection Description (subtitle) */
    .collection-card-description {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 400;
      line-height: 1.4;
      margin: 6px 0 0 0;
      opacity: 0.85;
      /* Limit to 2 lines */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .collection-card.text-light .collection-card-description {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .collection-card.text-dark .collection-card-description {
      color: rgba(62, 35, 24, 0.7);
    }
    
    /* === COMPACT VIEW - Hide description === */
    .collection-card.view-compact .collection-card-description {
      display: none;
    }
    
    .collection-card.view-compact .collection-card-name {
      -webkit-line-clamp: 3;
    }
    
    /* === GALLERY VIEW - Vertical cards with 2x2 thumbnail grid === */
    .collection-card.view-gallery {
      aspect-ratio: auto;
      min-height: auto;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
    }
    
    .collection-card.view-gallery .collection-card-content {
      flex: 0 0 auto;
      margin-bottom: var(--space-md);
    }
    
    .collection-card.view-gallery .collection-card-name {
      font-size: clamp(18px, 2.5vw, 22px);
      margin-bottom: 4px;
    }
    
    .collection-card.view-gallery .collection-card-description {
      display: block;
      font-size: 13px;
      opacity: 0.85;
      -webkit-line-clamp: 2;
    }
    
    /* Gallery 2x2 Thumbnail Grid */
    .collection-card-thumbnails {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 6px;
      flex: 1;
      min-height: 140px;
    }
    
    .collection-card-thumbnail {
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.15);
    }
    
    .collection-card.text-dark .collection-card-thumbnail {
      background: rgba(0, 0, 0, 0.08);
    }
    
    .collection-card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .collection-card-thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.3);
    }
    
    .collection-card.text-dark .collection-card-thumbnail-placeholder {
      color: rgba(0, 0, 0, 0.15);
    }
    
    /* Gallery footer styling */
    .collection-card.view-gallery .collection-card-footer {
      margin-top: var(--space-md);
      padding-top: var(--space-sm);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .collection-card.view-gallery.text-dark .collection-card-footer {
      border-top-color: rgba(0, 0, 0, 0.1);
    }
    
    /* === TABLE VIEW === */
    .collections-table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--font-sans);
    }
    
    .collections-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      border-bottom: 1px solid var(--color-border);
      white-space: nowrap;
    }
    
    .collections-table th.sortable {
      cursor: pointer;
      user-select: none;
    }
    
    .collections-table th.sortable:hover {
      color: var(--color-text-secondary);
    }
    
    .collections-table th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    .collections-table th.sorted .sort-indicator {
      opacity: 1;
    }
    
    .collections-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--color-border);
      vertical-align: middle;
    }
    
    .collections-table tbody tr {
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    
    .collections-table tbody tr:hover {
      background-color: var(--color-surface-alt);
    }
    
    /* Table Columns */
    .table-col-color {
      width: 40px;
      padding-right: 0 !important;
    }
    
    .table-color-dot {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: inline-block;
    }
    
    .table-col-title {
      min-width: 180px;
    }
    
    .table-title {
      font-family: var(--font-serif);
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .table-title svg {
      width: 16px;
      height: 16px;
      opacity: 0.5;
      flex-shrink: 0;
    }
    
    .table-col-description {
      max-width: 300px;
    }
    
    .table-description {
      font-size: 13px;
      color: var(--color-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }
    
    .table-col-styles {
      width: 80px;
      text-align: center;
    }
    
    .table-styles-count {
      font-size: 13px;
      color: var(--color-text-secondary);
    }
    
    .table-col-date {
      width: 120px;
      white-space: nowrap;
    }
    
    .table-date {
      font-size: 13px;
      color: var(--color-text-muted);
    }
    
    .table-col-actions {
      width: 50px;
      text-align: right;
      padding-right: 8px !important;
    }
    
    /* Table Kebab Button */
    .table-kebab-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .table-kebab-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      transition: all 0.15s ease;
    }
    
    .table-kebab-btn:hover {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }
    
    .table-kebab-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 150px;
      z-index: 1000;
      animation: menuDropDown 0.15s ease;
    }
    
    /* Responsive Table */
    @media (max-width: 900px) {
      .table-col-description {
        display: none;
      }
    }
    
    @media (max-width: 700px) {
      .table-col-date.created {
        display: none;
      }
    }
    
    @media (max-width: 550px) {
      .table-col-date.modified {
        display: none;
      }
      
      .collections-table th,
      .collections-table td {
        padding: 10px 12px;
      }
    }
    
    /* Collection Meta (count) - Bottom Left */
    .collection-card-meta {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.02em;
      margin: 0;
      padding-bottom: 2px;
    }
    
    /* Card Footer - holds meta and kebab */
    .collection-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    
    /* Kebab Menu Button */
    .collection-card-kebab {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      color: white;
      margin-right: -6px;
      margin-bottom: -4px;
    }
    
    .collection-card-kebab:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    .collection-card.text-dark .collection-card-kebab {
      color: var(--color-text-primary);
    }
    
    .collection-card.text-dark .collection-card-kebab:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    
    /* Kebab Dropdown Menu */
    .collection-card-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      min-width: 160px;
      z-index: 1000;
      overflow: hidden;
      animation: menuDropDown 0.15s ease;
    }
    
    @keyframes menuDropDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .collection-card-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text-primary);
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .collection-card-menu-item:hover {
      background: #f5f5f5;
    }
    
    .collection-card-menu-divider {
      height: 1px;
      background: #e5e5e5;
      margin: 4px 0;
    }
    
    .collection-card-menu-item.delete {
      color: #dc2626;
    }
    
    .collection-card-menu-item.delete:hover {
      background: #fef2f2;
    }
    
    .collection-card-menu-item svg {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }
    
    /* Folder icon for collections with sub-collections */
    .collection-card-icon {
      position: absolute;
      top: var(--space-lg);
      right: var(--space-lg);
      opacity: 0.5;
    }
    
    .collection-card.text-light .collection-card-icon {
      color: white;
    }
    
    .collection-card.text-dark .collection-card-icon {
      color: var(--color-text-primary);
    }
    
    /* === New Collection Card === */
    .new-collection-card {
      aspect-ratio: 1.1;
      min-height: 180px;
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .new-collection-card:hover {
      border-color: var(--color-accent);
      background: rgba(192, 113, 91, 0.06);
      transform: translateY(-4px);
    }
    
    .new-collection-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--color-tan-10);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      transition: all 0.25s ease;
    }
    
    .new-collection-card:hover .new-collection-icon {
      background: var(--color-accent);
      color: white;
      transform: scale(1.1);
    }
    
    .new-collection-text {
      font-family: var(--font-sans);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: var(--color-text-muted);
    }
    
    .new-collection-card:hover .new-collection-text {
      color: var(--color-accent);
    }
    
    /* === Back Navigation (when inside collection) === */
    .collections-back-nav {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .collections-back-btn {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border: none;
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .collections-back-btn:hover {
      background: var(--color-tan-20);
      color: var(--color-text-primary);
    }
    
    /* === Section Headers (inside collection view) === */
    .collections-section-header {
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--color-text-muted);
      margin: var(--space-2xl) 0 var(--space-lg) 0;
    }
    
    .collections-section-header:first-of-type {
      margin-top: 0;
    }
    
    /* === COLLECTION DETAIL VIEW (Redesigned) === */
    
    /* Project Starter Section */
    .project-starter {
      background: linear-gradient(135deg, var(--color-surface-alt) 0%, white 100%);
      border: 2px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-xl) var(--space-2xl);
      margin-bottom: var(--space-2xl);
      position: relative;
      overflow: hidden;
    }
    
    .project-starter::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--collection-color, var(--color-accent));
    }
    
    .project-starter-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }
    
    .project-starter-title {
      font-family: var(--font-serif);
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-xs) 0;
    }
    
    .project-starter-subtitle {
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text-muted);
      margin: 0;
    }
    
    .project-starter-slots {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    
    .project-slot {
      aspect-ratio: 1;
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .project-slot:hover {
      border-color: var(--color-accent);
      background: var(--color-tan-10);
    }
    
    .project-slot.filled {
      border: none;
      cursor: default;
    }
    
    .project-slot.filled:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .project-slot-number {
      font-family: var(--font-sans);
      font-size: 24px;
      font-weight: 600;
      color: var(--color-border);
      margin-bottom: var(--space-xs);
    }
    
    .project-slot-label {
      font-family: var(--font-sans);
      font-size: 11px;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .project-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      inset: 0;
    }
    
    .project-slot-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-sm) var(--space-xs);
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 500;
      color: white;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .project-slot-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    
    .project-slot.filled:hover .project-slot-remove {
      opacity: 1;
    }
    
    .project-slot-remove:hover {
      background: rgba(200, 0, 0, 0.8);
    }
    
    .project-starter-action {
      text-align: center;
    }
    
    .btn-start-project {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 32px;
      background: var(--color-accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: var(--font-sans);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-start-project:hover {
      background: var(--color-accent-dark, #a85d45);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(192, 113, 91, 0.3);
    }
    
    .btn-start-project:disabled {
      background: var(--color-border);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-start-project svg {
      width: 18px;
      height: 18px;
    }
    
    /* Collection Info Bar */
    .collection-info-bar {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
      padding: var(--space-lg) 0;
      margin-bottom: var(--space-xl);
      border-bottom: 3px solid var(--collection-color, var(--color-accent));
    }
    
    .collection-info-content {
      flex: 1;
    }
    
    .collection-info-title {
      font-family: var(--font-serif);
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-xs) 0;
    }
    
    .collection-info-description {
      font-family: var(--font-sans);
      font-size: 15px;
      color: var(--color-text-muted);
      margin: 0;
      max-width: 600px;
    }
    
    .collection-info-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    /* Style Gallery (Large Cards) */
    .style-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-lg);
    }
    
    .style-gallery-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      background: var(--color-surface-alt);
    }
    
    .style-gallery-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }
    
    .style-gallery-card.in-project {
      box-shadow: 0 0 0 3px var(--color-accent);
    }
    
    .style-gallery-image {
      aspect-ratio: 1;
      overflow: hidden;
    }
    
    .style-gallery-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .style-gallery-card:hover .style-gallery-image img {
      transform: scale(1.05);
    }
    
    .style-gallery-info {
      padding: var(--space-md);
      background: white;
    }
    
    .style-gallery-name {
      font-family: var(--font-serif);
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0 0 4px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .style-gallery-id {
      font-family: var(--font-sans);
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .style-gallery-actions {
      position: absolute;
      top: var(--space-sm);
      right: var(--space-sm);
      display: flex;
      gap: var(--space-xs);
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    
    .style-gallery-card:hover .style-gallery-actions {
      opacity: 1;
    }
    
    .style-gallery-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
      transition: all 0.15s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .style-gallery-btn:hover {
      background: white;
      color: var(--color-accent);
      transform: scale(1.1);
    }
    
    .style-gallery-btn.remove:hover {
      color: #c00;
    }
    
    .style-gallery-btn.add-to-project {
      background: var(--color-accent);
      color: white;
    }
    
    .style-gallery-btn.add-to-project:hover {
      background: var(--color-accent-dark, #a85d45);
    }
    
    .style-gallery-badge {
      position: absolute;
      top: var(--space-sm);
      left: var(--space-sm);
      padding: 4px 8px;
      background: var(--color-accent);
      color: white;
      font-family: var(--font-sans);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: 4px;
    }
    
    /* Add Style Card */
    .style-gallery-add {
      aspect-ratio: 1;
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
    }
    
    .style-gallery-add:hover {
      border-color: var(--color-accent);
      background: var(--color-tan-10);
    }
    
    .style-gallery-add svg {
      width: 32px;
      height: 32px;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .style-gallery-add span {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-muted);
    }
    
    /* Section Header */
    .collection-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
    }
    
    .collection-section-title {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-muted);
      margin: 0;
    }
    
    .collection-section-count {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--color-text-light);
    }
    
    /* Responsive Project Starter */
    @media (max-width: 768px) {
      .project-starter-slots {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .style-gallery {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .collection-info-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    @media (max-width: 480px) {
      .project-starter {
        padding: var(--space-lg);
      }
      
      .project-starter-slots {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-sm);
      }
      
      .btn-start-project {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Legacy styles-grid (kept for backwards compatibility) */
    .styles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--space-md);
    }
    
    .style-thumbnail {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .style-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .style-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .style-thumbnail-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    
    .style-thumbnail:hover .style-thumbnail-remove {
      opacity: 1;
    }
    
    .style-thumbnail-remove:hover {
      background: rgba(200, 0, 0, 0.8);
    }
    
    /* === Empty States === */
    .empty-state {
      text-align: center;
      padding: var(--space-5xl) var(--space-xl);
    }
    
    .empty-icon {
      width: 88px;
      height: 88px;
      margin: 0 auto var(--space-xl);
      background: var(--color-tan-10);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
    }
    
    .empty-title {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 500;
      letter-spacing: -0.01em;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .empty-text {
      font-family: var(--font-sans);
      font-size: 15px;
      color: var(--color-text-muted);
      margin: 0 0 var(--space-xl) 0;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.5;
    }
    
    /* === Loading State === */
    .loading-state {
      text-align: center;
      padding: var(--space-5xl);
      color: var(--color-text-muted);
      font-family: var(--font-sans);
      animation: loadingPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes loadingPulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    
    /* === Login Prompt === */
    .login-prompt {
      text-align: center;
      padding: var(--space-5xl) var(--space-xl);
    }
    
    .login-prompt h2 {
      font-family: var(--font-serif);
      font-size: 26px;
      font-weight: 500;
      letter-spacing: -0.01em;
      margin: 0 0 var(--space-md) 0;
    }
    
    .login-prompt p {
      font-family: var(--font-sans);
      font-size: 15px;
      color: var(--color-text-muted);
      margin: 0 0 var(--space-xl) 0;
    }
    
    /* === Collection Explainer (What is a Collection) === */
    .collection-explainer {
      max-width: 800px;
      padding: var(--space-xl) 0;
    }
    
    .explainer-header {
      margin-bottom: var(--space-2xl);
    }
    
    .explainer-title {
      font-family: var(--font-serif);
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 500;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-sm) 0;
    }
    
    .explainer-subtitle {
      font-size: 16px;
      color: var(--color-text-muted);
      line-height: 1.6;
      margin: 0;
    }
    
    /* Analogy Section */
    .explainer-analogy {
      background: white;
      border: 1px solid var(--color-border-light);
      border-radius: 16px;
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
    }
    
    .analogy-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .analogy-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-tan-10);
      border-radius: 12px;
      color: var(--color-accent);
    }
    
    .analogy-icon svg {
      width: 28px;
      height: 28px;
    }
    
    .analogy-title {
      font-family: var(--font-serif);
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
    }
    
    .analogy-text {
      font-size: 15px;
      color: var(--color-text-secondary);
      line-height: 1.7;
      margin: 0;
    }
    
    /* Formula Section */
    .explainer-formula {
      background: var(--color-tan-10);
      border-radius: 16px;
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
    }
    
    .formula-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-lg);
      flex-wrap: wrap;
    }
    
    .formula-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .formula-icon {
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 14px;
      color: var(--color-text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    .formula-icon svg {
      width: 32px;
      height: 32px;
    }
    
    .formula-label {
      font-weight: 600;
      font-size: 13px;
      color: var(--color-text-secondary);
    }
    
    .formula-operator {
      font-family: var(--font-serif);
      font-size: 28px;
      color: var(--color-text-light);
    }
    
    .formula-result-icon {
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-accent);
      border-radius: 14px;
      color: white;
      box-shadow: 0 4px 12px rgba(192, 113, 91, 0.3);
    }
    
    .formula-result-icon svg {
      width: 32px;
      height: 32px;
    }
    
    /* Benefits Section */
    .explainer-benefits {
      margin-bottom: var(--space-2xl);
    }
    
    .benefits-title {
      font-family: var(--font-serif);
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-lg) 0;
    }
    
    .benefits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-lg);
    }
    
    .benefit-card {
      background: white;
      border: 1px solid var(--color-border-light);
      border-radius: 12px;
      padding: var(--space-lg);
    }
    
    .benefit-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-tan-10);
      border-radius: 10px;
      color: var(--color-accent);
      margin-bottom: var(--space-md);
    }
    
    .benefit-icon svg {
      width: 22px;
      height: 22px;
    }
    
    .benefit-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-xs) 0;
    }
    
    .benefit-text {
      font-size: 13px;
      color: var(--color-text-muted);
      line-height: 1.5;
      margin: 0;
    }
    
    /* CTA Section */
    .explainer-cta {
      background: var(--color-text-primary);
      border-radius: 16px;
      padding: var(--space-2xl);
      text-align: center;
    }
    
    .cta-title {
      font-family: var(--font-serif);
      font-size: 24px;
      color: white;
      margin: 0 0 var(--space-sm) 0;
    }
    
    .cta-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.7);
      margin: 0 0 var(--space-xl) 0;
    }
    
    .cta-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      background: var(--color-accent);
      color: white;
      border: none;
      border-radius: 100px;
      font-family: var(--font-sans);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .cta-button:hover {
      background: #a85d45;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(192, 113, 91, 0.4);
    }
    
    .cta-button svg {
      width: 18px;
      height: 18px;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .formula-row {
        flex-direction: column;
        gap: var(--space-md);
      }
      
      .formula-operator {
        transform: rotate(90deg);
      }
      
      .benefits-grid {
        grid-template-columns: 1fr;
      }
      
      .explainer-analogy,
      .explainer-formula,
      .explainer-cta {
        padding: var(--space-xl);
      }
    }
    
    /* === Modal Styles === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      position: relative;
      background: white;
      border-radius: 12px;
      padding: var(--space-2xl);
      width: 100%;
      max-width: 440px;
      margin: var(--space-md);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .modal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
      transition: all 0.15s ease;
    }
    
    .modal-close-btn:hover {
      background: rgba(0, 0, 0, 0.08);
      color: var(--color-text-primary);
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-title {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 500;
      letter-spacing: -0.01em;
      color: var(--color-text-primary);
      margin: 0;
      flex: 1;
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .modal-info-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      transition: all 0.15s ease;
      flex-shrink: 0;
      opacity: 0.5;
    }
    
    .modal-info-btn:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.08);
    }
    
    .modal-info-btn svg {
      width: 20px;
      height: 20px;
      fill: var(--color-text-secondary);
    }
    
    /* === Delete Confirmation Modal === */
    .delete-modal-content {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 100%;
      max-width: 420px;
      margin: var(--space-md);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .delete-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg) var(--space-xl);
      background: #FEF2F2;
      border-bottom: 1px solid #FECACA;
    }
    
    .delete-modal-icon {
      width: 44px;
      height: 44px;
      background: #FEE2E2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #DC2626;
    }
    
    .delete-modal-body {
      padding: var(--space-xl);
    }
    
    .delete-modal-title {
      font-family: var(--font-serif);
      font-size: 22px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-md) 0;
    }
    
    .delete-modal-message {
      font-family: var(--font-sans);
      font-size: 15px;
      line-height: 1.6;
      color: var(--color-text-secondary);
      margin: 0 0 var(--space-lg) 0;
    }
    
    .delete-modal-message strong {
      color: var(--color-text-primary);
      font-weight: 600;
    }
    
    .delete-modal-warning {
      display: flex;
      align-items: flex-start;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: #FFFBEB;
      border: 1px solid #FDE68A;
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
    }
    
    .delete-modal-warning svg {
      flex-shrink: 0;
      color: #D97706;
    }
    
    .delete-modal-warning p {
      font-size: 13px;
      color: #92400E;
      margin: 0;
      line-height: 1.5;
    }
    
    .delete-modal-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }
    
    .btn-delete {
      padding: 12px 24px;
      border: none;
      background: #DC2626;
      color: white;
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .btn-delete:hover {
      background: #B91C1C;
    }
    
    .btn-delete:disabled {
      background: #FCA5A5;
      cursor: not-allowed;
    }
    
    /* Delete Confirmation Input (Step 2) */
    .delete-confirm-input-wrapper {
      margin-bottom: var(--space-xl);
    }
    
    .delete-confirm-label {
      display: block;
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-sm);
    }
    
    .delete-confirm-label strong {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      background: #FEE2E2;
      color: #991B1B;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    
    .delete-confirm-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.1em;
      color: var(--color-text-primary);
      text-align: center;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .delete-confirm-input:focus {
      outline: none;
      border-color: #DC2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
    }
    
    .delete-confirm-input::placeholder {
      color: var(--color-text-light);
      font-weight: 400;
      letter-spacing: 0.05em;
    }
    
    .delete-confirm-input.valid {
      border-color: #16A34A;
      background: #F0FDF4;
    }
    
    .delete-confirm-input.valid:focus {
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.15);
    }
    
    /* === Share Modal === */
    .share-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: modalSlideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
    }
    
    .share-modal-header h3 {
      font-family: var(--font-sans);
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: var(--color-text-primary);
    }
    
    .share-modal-body {
      padding: 24px;
    }
    
    .share-collection-name {
      font-family: var(--font-serif);
      font-size: 20px;
      font-weight: 600;
      font-style: italic;
      color: var(--color-text-primary);
      margin: 0 0 20px 0;
    }
    
    .share-label {
      display: block;
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
    }
    
    .share-link-section {
      margin-bottom: 24px;
    }
    
    .share-link-row {
      display: flex;
      gap: 8px;
    }
    
    .share-link-input {
      flex: 1;
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text-primary);
      background: #f9f9f9;
    }
    
    .share-copy-btn {
      padding: 12px 20px;
      white-space: nowrap;
    }
    
    .share-options-section {
      margin-bottom: 8px;
    }
    
    .share-options-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    
    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 8px;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .share-option:hover {
      border-color: #C0715B;
      background: #FAF9F7;
    }
    
    .share-option span {
      font-family: var(--font-sans);
      font-size: 12px;
      color: var(--color-text-secondary);
    }
    
    .share-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .share-option-icon.email {
      background: #EA4335;
      color: white;
    }
    
    .share-option-icon.text {
      background: #34C759;
      color: white;
    }
    
    .share-option-icon.twitter {
      background: #000000;
      color: white;
    }
    
    .share-option-icon.facebook {
      background: #1877F2;
      color: white;
    }
    
    .share-option-icon.pinterest {
      background: #E60023;
      color: white;
    }
    
    @media (max-width: 480px) {
      .share-options-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .modal-label {
      display: block;
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-xs);
    }
    
    .modal-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: var(--font-sans);
      font-size: 15px;
      color: var(--color-text-primary);
      margin-bottom: var(--space-lg);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .modal-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(192, 113, 91, 0.15);
    }
    
    .modal-input::placeholder {
      color: #aaa;
    }
    
    /* Color Picker Grid */
    .color-picker {
      margin-bottom: var(--space-lg);
    }
    
    .color-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }
    
    .color-picker-swatch {
      aspect-ratio: 1;
      border-radius: 8px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease;
    }
    
    .color-picker-swatch:hover {
      transform: scale(1.1);
    }
    
    .color-picker-swatch.selected {
      border-color: var(--color-text-primary);
      transform: scale(1.1);
    }
    
    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: var(--space-xl);
    }
    
    .modal-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }
    
    /* === Collection Header (inside view) === */
    .collection-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-xl);
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .collection-header-info {
      flex: 1;
    }
    
    .collection-header-color {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .collection-header-title {
      font-family: var(--font-serif);
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1.1;
      color: var(--color-text-primary);
      margin: 0 0 var(--space-xs) 0;
    }
    
    .collection-header-meta {
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text-muted);
      margin: 0 0 var(--space-md) 0;
    }
    
    .collection-header-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .collection-action-btn {
      padding: 8px 16px;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 6px;
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .collection-action-btn:hover {
      border-color: var(--color-text-muted);
      color: var(--color-text-primary);
    }
    
    .collection-action-btn.danger:hover {
      border-color: #e53935;
      color: #e53935;
      background: #ffebee;
    }
    
    /* === Add Styles Card === */
    .add-style-card {
      aspect-ratio: 1;
      border: 2px dashed var(--color-border);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--color-text-muted);
    }
    
    .add-style-card:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: rgba(192, 113, 91, 0.04);
    }
    
    .add-style-card span {
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
    }
    
    /* === Responsive === */
    @media (max-width: 768px) {
      .collections-content {
        padding: var(--space-lg);
      }
      
      .collections-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-md);
      }
      
      /* Gallery view on tablet - 2 columns */
      .collections-grid.view-gallery {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-md);
      }
      
      .collection-card {
        min-height: 150px;
        padding: var(--space-lg);
      }
      
      .collection-card-name {
        font-size: 18px;
      }
      
      /* Smaller thumbnails on tablet */
      .collection-card-thumbnails {
        gap: 4px;
        min-height: 120px;
      }
      
      .collection-header {
        flex-direction: column-reverse;
        gap: var(--space-lg);
      }
      
      .collection-header-color {
        width: 60px;
        height: 60px;
      }
    }
    
    @media (max-width: 540px) {
      /* Single column for all views on small screens */
      .collections-grid,
      .collections-grid.view-compact,
      .collections-grid.view-gallery {
        grid-template-columns: 1fr;
      }
      
      .collection-card.view-gallery {
        min-height: auto;
      }
      
      .collection-card.view-gallery .collection-card-thumbnails {
        min-height: 160px;
      }
      
      /* Stack toolbar vertically */
      .collections-toolbar-right {
        width: 100%;
        justify-content: space-between;
      }
      
      /* Full width sort dropdown */
      .sort-dropdown {
        flex: 1;
      }
    }
    
    /* Print styles */
    @media print {
      .collections-toolbar,
      .collection-card-kebab,
      .table-kebab-wrapper {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared/supabase-client.js"></script>
  <script src="/js/shared/api.js"></script>
  <script src="/js/shared/auth.js"></script>
  <script src="/js/shared/header.js"></script>
  <script src="/js/style-finder/style-data.js"></script>
  <script src="/js/shared/style-detail-modal.js"></script>
  <script src="/js/shared/add-to-collection-modal.js"></script>
  <script src="/js/shared/info-modal.js"></script>
  
  <!-- Collections App -->
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ==========================================
    // ICONS
    // ==========================================
    
    const ChevronRightIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );
    
    const ChevronLeftIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );
    
    const PlusIcon = () => (
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    
    const FolderIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      </svg>
    );
    
    const LayersIcon = () => (
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
        <polyline points="2 17 12 22 22 17"></polyline>
        <polyline points="2 12 12 17 22 12"></polyline>
      </svg>
    );
    
    const XIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    
    const KebabIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="5" r="2"></circle>
        <circle cx="12" cy="12" r="2"></circle>
        <circle cx="12" cy="19" r="2"></circle>
      </svg>
    );
    
    const DuplicateIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );
    
    const EditIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );
    
    const TrashIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );
    
    const ShareIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="18" cy="5" r="3"></circle>
        <circle cx="6" cy="12" r="3"></circle>
        <circle cx="18" cy="19" r="3"></circle>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
      </svg>
    );
    
    // View Toggle Icons
    const CompactViewIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
      </svg>
    );
    
    const TableViewIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    );
    
    const GalleryViewIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="18" height="8" rx="1"></rect>
        <rect x="3" y="14" width="8" height="7" rx="1"></rect>
        <rect x="13" y="14" width="8" height="7" rx="1"></rect>
      </svg>
    );
    
    const ChevronDownIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );
    
    const SmallPlusIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    
    const ArrowRightIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    );

    // ==========================================
    // DEFAULT PALETTE (fallback)
    // ==========================================
    
    const DEFAULT_PALETTE = [
      { id: 1, name: "Coral", hex: "#E07A5F", text: "light" },
      { id: 2, name: "Sage", hex: "#81B29A", text: "light" },
      { id: 3, name: "Ocean", hex: "#3D5A80", text: "light" },
      { id: 4, name: "Sunset", hex: "#F2994A", text: "dark" },
      { id: 5, name: "Plum", hex: "#9B5DE5", text: "light" },
      { id: 6, name: "Gold", hex: "#D4A853", text: "dark" },
      { id: 7, name: "Rose", hex: "#C97B84", text: "light" },
      { id: 8, name: "Forest", hex: "#588157", text: "light" },
      { id: 9, name: "Slate", hex: "#5C677D", text: "light" },
      { id: 10, name: "Peach", hex: "#FFBE98", text: "dark" },
      { id: 11, name: "Indigo", hex: "#5E60CE", text: "light" },
      { id: 12, name: "Copper", hex: "#B87333", text: "light" }
    ];

    // ==========================================
    // COLLECTION CARD COMPONENT
    // ==========================================
    
    function CollectionCard({ collection, palette, onClick, onEdit, onDelete, onDuplicate, onShare, viewMode = 'compact' }) {
      const [menuOpen, setMenuOpen] = useState(false);
      const menuRef = React.useRef(null);
      
      const paletteColor = palette.find(c => c.hex === collection.color) || palette[0];
      const textClass = paletteColor.text === 'dark' ? 'text-dark' : 'text-light';
      
      const styleCount = collection.styles?.length || 0;
      const subCount = collection.subcollection_count || 0;
      
      let metaText = '';
      if (subCount > 0 && styleCount > 0) {
        metaText = `${subCount} folder${subCount !== 1 ? 's' : ''}  ${styleCount} style${styleCount !== 1 ? 's' : ''}`;
      } else if (subCount > 0) {
        metaText = `${subCount} folder${subCount !== 1 ? 's' : ''}`;
      } else {
        metaText = `${styleCount} style${styleCount !== 1 ? 's' : ''}`;
      }
      
      // Get thumbnail URL for a style
      const getStyleThumbnail = (styleId) => {
        return window.SocietyArts?.getStyleThumbnailUrl?.(styleId, 0) || 
               window.SocietyArts?.getAltStyleThumbnailUrl?.(styleId) ||
               `https://pub-acb560f551f141db830964aed1fa005f.r2.dev/${styleId}/${styleId}-00.webp`;
      };
      
      // Get up to 4 thumbnails for gallery view
      const thumbnailStyles = (collection.styles || []).slice(0, 4);
      const emptySlots = 4 - thumbnailStyles.length;
      
      // Close menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (menuRef.current && !menuRef.current.contains(e.target)) {
            setMenuOpen(false);
          }
        };
        if (menuOpen) {
          document.addEventListener('mousedown', handleClickOutside);
        }
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [menuOpen]);
      
      const handleKebabClick = (e) => {
        e.stopPropagation();
        setMenuOpen(!menuOpen);
      };
      
      const handleMenuAction = (e, action) => {
        e.stopPropagation();
        setMenuOpen(false);
        action(collection);
      };
      
      const handleKeyDown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onClick(collection);
        }
      };
      
      return (
        <div 
          className={`collection-card ${textClass} view-${viewMode}`}
          style={{ backgroundColor: collection.color || paletteColor.hex }}
          onClick={() => onClick(collection)}
          onKeyDown={handleKeyDown}
          tabIndex={0}
          role="button"
          aria-label={`${collection.name} collection with ${metaText}`}
        >
          {subCount > 0 && (
            <div className="collection-card-icon">
              <FolderIcon />
            </div>
          )}
          <div className="collection-card-content">
            <h3 className="collection-card-name">{collection.name}</h3>
            {collection.description && (
              <p className="collection-card-description">{collection.description}</p>
            )}
          </div>
          
          {/* Thumbnail strip for gallery view */}
          {viewMode === 'gallery' && (
            <div className="collection-card-thumbnails">
              {thumbnailStyles.map(styleId => (
                <div key={styleId} className="collection-card-thumbnail">
                  <img 
                    src={getStyleThumbnail(styleId)} 
                    alt=""
                    onError={e => e.target.style.opacity = 0}
                  />
                </div>
              ))}
              {[...Array(emptySlots)].map((_, i) => (
                <div key={`empty-${i}`} className="collection-card-thumbnail">
                  <div className="collection-card-thumbnail-placeholder">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          <div className="collection-card-footer">
            <p className="collection-card-meta">{metaText}</p>
            <div ref={menuRef} style={{ position: 'relative', zIndex: menuOpen ? 1000 : 1 }}>
              <button 
                className="collection-card-kebab"
                onClick={handleKebabClick}
                title="More options"
              >
                <KebabIcon />
              </button>
              {menuOpen && (
                <div className="collection-card-menu">
                  <button className="collection-card-menu-item" onClick={(e) => handleMenuAction(e, onDuplicate)}>
                    <DuplicateIcon /> Duplicate
                  </button>
                  <button className="collection-card-menu-item" onClick={(e) => handleMenuAction(e, onEdit)}>
                    <EditIcon /> Edit
                  </button>
                  <button className="collection-card-menu-item" onClick={(e) => handleMenuAction(e, onShare)}>
                    <ShareIcon /> Share
                  </button>
                  <div className="collection-card-menu-divider"></div>
                  <button className="collection-card-menu-item delete" onClick={(e) => handleMenuAction(e, onDelete)}>
                    <TrashIcon /> Delete
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // COLLECTIONS TABLE COMPONENT
    // ==========================================
    
    function CollectionsTable({ 
      collections, 
      palette, 
      onClick, 
      onEdit, 
      onDelete, 
      onDuplicate, 
      onShare,
      sortOption = 'modified-desc',
      onSortChange
    }) {
      const [openMenuId, setOpenMenuId] = useState(null);
      const menuRef = React.useRef(null);
      
      // Close menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (menuRef.current && !menuRef.current.contains(e.target)) {
            setOpenMenuId(null);
          }
        };
        if (openMenuId) {
          document.addEventListener('mousedown', handleClickOutside);
        }
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [openMenuId]);
      
      const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
      };
      
      const handleKebabClick = (e, collectionId) => {
        e.stopPropagation();
        setOpenMenuId(openMenuId === collectionId ? null : collectionId);
      };
      
      const handleMenuAction = (e, action, collection) => {
        e.stopPropagation();
        setOpenMenuId(null);
        action(collection);
      };
      
      // Handle header click for sorting
      const handleHeaderSort = (field) => {
        if (!onSortChange) return;
        const [currentField, currentDirection] = sortOption.split('-');
        if (currentField === field) {
          // Toggle direction
          const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
          onSortChange(`${field}-${newDirection}`);
        } else {
          // New field, default to desc (except name defaults to asc)
          const defaultDirection = field === 'name' ? 'asc' : 'desc';
          onSortChange(`${field}-${defaultDirection}`);
        }
      };
      
      // Get sort indicator for a column
      const getSortIndicator = (field) => {
        const [currentField, currentDirection] = sortOption.split('-');
        if (currentField !== field) return null;
        return currentDirection === 'asc' ? '' : '';
      };
      
      // Check if column is currently sorted
      const isColumnSorted = (field) => {
        return sortOption.startsWith(field + '-');
      };
      
      return (
        <table className="collections-table">
          <thead>
            <tr>
              <th className="table-col-color"></th>
              <th 
                className={`table-col-title sortable ${isColumnSorted('name') ? 'sorted' : ''}`}
                onClick={() => handleHeaderSort('name')}
              >
                Name
                <span className="sort-indicator">{getSortIndicator('name') || ''}</span>
              </th>
              <th className="table-col-description">Description</th>
              <th 
                className={`table-col-styles sortable ${isColumnSorted('styles') ? 'sorted' : ''}`}
                onClick={() => handleHeaderSort('styles')}
              >
                Styles
                <span className="sort-indicator">{getSortIndicator('styles') || ''}</span>
              </th>
              <th 
                className={`table-col-date created sortable ${isColumnSorted('created') ? 'sorted' : ''}`}
                onClick={() => handleHeaderSort('created')}
              >
                Created
                <span className="sort-indicator">{getSortIndicator('created') || ''}</span>
              </th>
              <th 
                className={`table-col-date modified sortable ${isColumnSorted('modified') ? 'sorted' : ''}`}
                onClick={() => handleHeaderSort('modified')}
              >
                Modified
                <span className="sort-indicator">{getSortIndicator('modified') || ''}</span>
              </th>
              <th className="table-col-actions"></th>
            </tr>
          </thead>
          <tbody>
            {collections.map(collection => {
              const styleCount = collection.styles?.length || 0;
              const subCount = collection.subcollection_count || 0;
              
              const handleRowKeyDown = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  onClick(collection);
                }
              };
              
              return (
                <tr 
                  key={collection.id} 
                  onClick={() => onClick(collection)}
                  onKeyDown={handleRowKeyDown}
                  tabIndex={0}
                  role="button"
                  aria-label={`${collection.name} collection with ${styleCount} styles`}
                >
                  <td className="table-col-color">
                    <span 
                      className="table-color-dot" 
                      style={{ backgroundColor: collection.color }}
                    />
                  </td>
                  <td className="table-col-title">
                    <span className="table-title">
                      {subCount > 0 && <FolderIcon />}
                      {collection.name}
                    </span>
                  </td>
                  <td className="table-col-description">
                    <span className="table-description">
                      {collection.description || ''}
                    </span>
                  </td>
                  <td className="table-col-styles">
                    <span className="table-styles-count">{styleCount}</span>
                  </td>
                  <td className="table-col-date created">
                    <span className="table-date">{formatDate(collection.created_at)}</span>
                  </td>
                  <td className="table-col-date modified">
                    <span className="table-date">{formatDate(collection.updated_at)}</span>
                  </td>
                  <td className="table-col-actions">
                    <div 
                      className="table-kebab-wrapper" 
                      ref={openMenuId === collection.id ? menuRef : null}
                    >
                      <button 
                        className="table-kebab-btn"
                        onClick={(e) => handleKebabClick(e, collection.id)}
                        title="More options"
                      >
                        <KebabIcon />
                      </button>
                      {openMenuId === collection.id && (
                        <div className="table-kebab-menu">
                          <button 
                            className="collection-card-menu-item" 
                            onClick={(e) => handleMenuAction(e, onDuplicate, collection)}
                          >
                            <DuplicateIcon /> Duplicate
                          </button>
                          <button 
                            className="collection-card-menu-item" 
                            onClick={(e) => handleMenuAction(e, onEdit, collection)}
                          >
                            <EditIcon /> Edit
                          </button>
                          <button 
                            className="collection-card-menu-item" 
                            onClick={(e) => handleMenuAction(e, onShare, collection)}
                          >
                            <ShareIcon /> Share
                          </button>
                          <div className="collection-card-menu-divider"></div>
                          <button 
                            className="collection-card-menu-item delete" 
                            onClick={(e) => handleMenuAction(e, onDelete, collection)}
                          >
                            <TrashIcon /> Delete
                          </button>
                        </div>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      );
    }

    // ==========================================
    // NEW COLLECTION CARD COMPONENT
    // ==========================================
    
    function NewCollectionCard({ onClick }) {
      return (
        <div className="new-collection-card" onClick={onClick}>
          <div className="new-collection-icon">
            <PlusIcon />
          </div>
          <span className="new-collection-text">New Collection</span>
        </div>
      );
    }

    // ==========================================
    // COLLECTIONS TOOLBAR COMPONENT
    // ==========================================
    
    function CollectionsToolbar({ onAddCollection, viewMode, onViewChange, sortOption = 'modified-desc', onSortChange }) {
      const [sortMenuOpen, setSortMenuOpen] = useState(false);
      const sortMenuRef = React.useRef(null);
      
      // Sort options configuration
      const sortOptions = [
        { value: 'name-asc', label: 'Name (A-Z)' },
        { value: 'name-desc', label: 'Name (Z-A)' },
        { value: 'created-desc', label: 'Date Created (Newest)' },
        { value: 'created-asc', label: 'Date Created (Oldest)' },
        { value: 'modified-desc', label: 'Date Modified (Newest)' },
        { value: 'modified-asc', label: 'Date Modified (Oldest)' },
        { value: 'styles-desc', label: 'Style Count (Most)' },
        { value: 'styles-asc', label: 'Style Count (Least)' },
      ];
      
      // Get display label for current sort
      const getCurrentSortLabel = () => {
        const option = sortOptions.find(o => o.value === sortOption);
        if (!option) return 'Modified';
        // Shortened labels for button
        const shortLabels = {
          'name-asc': 'Name A-Z',
          'name-desc': 'Name Z-A',
          'created-desc': 'Created ',
          'created-asc': 'Created ',
          'modified-desc': 'Modified ',
          'modified-asc': 'Modified ',
          'styles-desc': 'Styles ',
          'styles-asc': 'Styles ',
        };
        return shortLabels[sortOption] || 'Modified';
      };
      
      // Close menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (sortMenuRef.current && !sortMenuRef.current.contains(e.target)) {
            setSortMenuOpen(false);
          }
        };
        if (sortMenuOpen) {
          document.addEventListener('mousedown', handleClickOutside);
        }
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [sortMenuOpen]);
      
      // Close menu on Escape key
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'Escape' && sortMenuOpen) {
            setSortMenuOpen(false);
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [sortMenuOpen]);
      
      const handleSortSelect = (value) => {
        onSortChange(value);
        setSortMenuOpen(false);
      };
      
      return (
        <div className="collections-toolbar">
          <div className="collections-toolbar-left">
            <button 
              className="btn-add-collection" 
              onClick={onAddCollection}
              aria-label="Add new collection"
            >
              <SmallPlusIcon />
              Add Collection
            </button>
          </div>
          
          <div className="collections-toolbar-right">
            {/* Sort Dropdown */}
            <div className="sort-dropdown" ref={sortMenuRef}>
              <button 
                className="sort-dropdown-trigger"
                onClick={() => setSortMenuOpen(!sortMenuOpen)}
                aria-haspopup="listbox"
                aria-expanded={sortMenuOpen}
                aria-label={`Sort collections. Currently sorted by ${getCurrentSortLabel()}`}
              >
                Sort: {getCurrentSortLabel()}
                <ChevronDownIcon />
              </button>
              {sortMenuOpen && (
                <div className="sort-dropdown-menu" role="listbox" aria-label="Sort options">
                  {sortOptions.map(option => (
                    <button
                      key={option.value}
                      className={`sort-dropdown-item ${sortOption === option.value ? 'active' : ''}`}
                      onClick={() => handleSortSelect(option.value)}
                      role="option"
                      aria-selected={sortOption === option.value}
                    >
                      {option.label}
                      {sortOption === option.value && (
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      )}
                    </button>
                  ))}
                </div>
              )}
            </div>
            
            {/* View Toggle */}
            <div className="view-toggle" role="group" aria-label="View options">
              <button 
                className={`view-toggle-btn ${viewMode === 'gallery' ? 'active' : ''}`}
                onClick={() => onViewChange('gallery')}
                title="Gallery Cards"
                aria-label="Gallery Cards view"
                aria-pressed={viewMode === 'gallery'}
              >
                <GalleryViewIcon />
              </button>
              <button 
                className={`view-toggle-btn ${viewMode === 'compact' ? 'active' : ''}`}
                onClick={() => onViewChange('compact')}
                title="Compact Cards"
                aria-label="Compact Cards view"
                aria-pressed={viewMode === 'compact'}
              >
                <CompactViewIcon />
              </button>
              <button 
                className={`view-toggle-btn ${viewMode === 'table' ? 'active' : ''}`}
                onClick={() => onViewChange('table')}
                title="Table View"
                aria-label="Table view"
                aria-pressed={viewMode === 'table'}
              >
                <TableViewIcon />
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // CREATE/EDIT MODAL COMPONENT
    // ==========================================
    
    function CollectionModal({ 
      isOpen, 
      onClose, 
      onSave, 
      collection = null, 
      palette,
      parentId = null 
    }) {
      const [name, setName] = useState(collection?.name || '');
      const [description, setDescription] = useState(collection?.description || '');
      const [selectedColor, setSelectedColor] = useState(collection?.color || palette[0]?.hex);
      const mouseDownOnOverlay = React.useRef(false);
      const nameInputRef = React.useRef(null);
      
      useEffect(() => {
        if (collection) {
          setName(collection.name || '');
          setDescription(collection.description || '');
          setSelectedColor(collection.color || palette[0]?.hex);
        } else {
          setName('');
          setDescription('');
          // Auto-assign next color in rotation
          setSelectedColor(palette[0]?.hex);
        }
      }, [collection, palette]);
      
      // Focus name input when modal opens
      useEffect(() => {
        if (isOpen && nameInputRef.current) {
          setTimeout(() => nameInputRef.current?.focus(), 50);
        }
      }, [isOpen]);
      
      const handleSave = () => {
        if (!name.trim()) return;
        onSave({
          id: collection?.id,
          name: name.trim(),
          description: description.trim(),
          color: selectedColor,
          parent_id: parentId
        });
        onClose();
      };
      
      // Only close if both mousedown and mouseup happened on overlay
      const handleOverlayMouseDown = (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          mouseDownOnOverlay.current = true;
        }
      };
      
      const handleOverlayMouseUp = (e) => {
        if (e.target.classList.contains('modal-overlay') && mouseDownOnOverlay.current) {
          onClose();
        }
        mouseDownOnOverlay.current = false;
      };
      
      if (!isOpen) return null;
      
      return (
        <div 
          className="modal-overlay" 
          onMouseDown={handleOverlayMouseDown}
          onMouseUp={handleOverlayMouseUp}
        >
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            {/* Close button - top right */}
            <button className="modal-close-btn" onClick={onClose} title="Close">
              <XIcon />
            </button>
            
            <div className="modal-header">
              <h2 className="modal-title">
                {collection ? 'Edit Collection' : 'New Collection'}
              </h2>
            </div>
            
            <label className="modal-label">Name</label>
            <input 
              ref={nameInputRef}
              type="text"
              className="modal-input"
              placeholder="Collection Name"
              value={name}
              onChange={e => setName(e.target.value)}
              maxLength={50}
            />
            
            <label className="modal-label">Description (optional)</label>
            <input 
              type="text"
              className="modal-input"
              placeholder="Brief description of this collection..."
              value={description}
              onChange={e => setDescription(e.target.value)}
              maxLength={200}
            />
            
            <div className="color-picker">
              <label className="modal-label">Color</label>
              <div className="color-picker-grid">
                {palette.map(color => (
                  <div
                    key={color.id}
                    className={`color-picker-swatch ${selectedColor === color.hex ? 'selected' : ''}`}
                    style={{ backgroundColor: color.hex }}
                    onClick={() => setSelectedColor(color.hex)}
                    title={color.name}
                  />
                ))}
              </div>
            </div>
            
            <div className="modal-footer">
              {/* Info button - bottom left */}
              <button 
                className="modal-info-btn"
                onClick={() => window.SocietyArts?.openInfoModal?.('collections-new')}
                title="Help"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
              </button>
              
              <div className="modal-actions">
                <button className="btn btn-ghost" onClick={onClose}>
                  Cancel
                </button>
                <button 
                  className="btn btn-primary" 
                  onClick={handleSave}
                  disabled={!name.trim()}
                >
                  {collection ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // DELETE CONFIRMATION MODAL COMPONENT
    // ==========================================
    
    function DeleteConfirmationModal({ 
      isOpen, 
      onClose, 
      onConfirm, 
      collection,
      subCollectionCount = 0
    }) {
      const [step, setStep] = useState(1); // 1 = warning, 2 = type DELETE
      const [confirmText, setConfirmText] = useState('');
      
      // Reset state when modal opens/closes or collection changes
      useEffect(() => {
        if (isOpen) {
          setStep(1);
          setConfirmText('');
        }
      }, [isOpen, collection?.id]);
      
      if (!isOpen || !collection) return null;
      
      const hasSubCollections = subCollectionCount > 0;
      const styleCount = collection.styles?.length || 0;
      const isHighValue = styleCount > 0; // Collections with 1+ styles require extra confirmation
      const isDeleteMatch = confirmText === 'DELETE';
      
      const handleProceed = () => {
        if (isHighValue) {
          setStep(2);
        } else {
          onConfirm();
        }
      };
      
      const handleFinalDelete = () => {
        if (isDeleteMatch) {
          onConfirm();
        }
      };
      
      const handleClose = () => {
        setStep(1);
        setConfirmText('');
        onClose();
      };
      
      return (
        <div className="modal-overlay" onClick={handleClose}>
          <div className="delete-modal-content" onClick={e => e.stopPropagation()}>
            <div className="delete-modal-header">
              <div className="delete-modal-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
              </div>
              <button 
                className="modal-info-btn"
                onClick={() => window.SocietyArts?.openInfoModal?.('collections-delete')}
                title="Help"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
              </button>
            </div>
            
            <div className="delete-modal-body">
              {step === 1 ? (
                <>
                  <h3 className="delete-modal-title">Delete Collection?</h3>
                  
                  <p className="delete-modal-message">
                    You're about to delete <strong>{collection.name}</strong>.
                    {hasSubCollections && (
                      <> This will also remove {subCollectionCount} sub-collection{subCollectionCount !== 1 ? 's' : ''} inside it.</>
                    )}
                    {styleCount > 0 && (
                      <> This collection contains <strong>{styleCount} style{styleCount !== 1 ? 's' : ''}</strong>.</>
                    )}
                  </p>
                  
                  <div className="delete-modal-warning">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                      <line x1="12" y1="9" x2="12" y2="13"></line>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <p>This action cannot be undone. The styles saved in this collection will remain in your library, but the collection itself will be permanently removed.</p>
                  </div>
                  
                  <div className="delete-modal-actions">
                    <button className="btn btn-ghost" onClick={handleClose}>
                      Keep Collection
                    </button>
                    <button className="btn-delete" onClick={handleProceed}>
                      {isHighValue ? 'Continue' : 'Yes, Delete'}
                    </button>
                  </div>
                </>
              ) : (
                <>
                  <h3 className="delete-modal-title">Confirm Deletion</h3>
                  
                  <p className="delete-modal-message">
                    You're about to permanently delete <strong>{collection.name}</strong> and its {styleCount} saved style{styleCount !== 1 ? 's' : ''}.
                  </p>
                  
                  <div className="delete-confirm-input-wrapper">
                    <label className="delete-confirm-label">
                      Type <strong>DELETE</strong> to confirm
                    </label>
                    <input
                      type="text"
                      className={`delete-confirm-input ${isDeleteMatch ? 'valid' : ''}`}
                      placeholder="DELETE"
                      value={confirmText}
                      onChange={e => setConfirmText(e.target.value.toUpperCase())}
                      autoFocus
                      autoComplete="off"
                      spellCheck="false"
                    />
                  </div>
                  
                  <div className="delete-modal-actions">
                    <button className="btn btn-ghost" onClick={() => setStep(1)}>
                      Go Back
                    </button>
                    <button 
                      className="btn-delete" 
                      onClick={handleFinalDelete}
                      disabled={!isDeleteMatch}
                    >
                      Delete Forever
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // SHARE MODAL COMPONENT
    // ==========================================
    
    function ShareModal({ isOpen, onClose, collection }) {
      if (!isOpen || !collection) return null;
      
      const shareUrl = `${window.location.origin}/collections.html?id=${collection.id}`;
      const shareText = `Check out my collection "${collection.name}" on Society Arts`;
      
      const handleCopyLink = async () => {
        try {
          await navigator.clipboard.writeText(shareUrl);
          alert('Link copied to clipboard!');
        } catch (err) {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = shareUrl;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('Link copied to clipboard!');
        }
      };
      
      const handleEmailShare = () => {
        const subject = encodeURIComponent(`Check out my collection: ${collection.name}`);
        const body = encodeURIComponent(`${shareText}\n\n${shareUrl}`);
        window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
      };
      
      const handleTextShare = () => {
        // For mobile devices with SMS capability
        const body = encodeURIComponent(`${shareText} ${shareUrl}`);
        window.open(`sms:?body=${body}`, '_blank');
      };
      
      const handleTwitterShare = () => {
        const text = encodeURIComponent(shareText);
        const url = encodeURIComponent(shareUrl);
        window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
      };
      
      const handleFacebookShare = () => {
        const url = encodeURIComponent(shareUrl);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=420');
      };
      
      const handlePinterestShare = () => {
        const url = encodeURIComponent(shareUrl);
        const description = encodeURIComponent(shareText);
        window.open(`https://pinterest.com/pin/create/button/?url=${url}&description=${description}`, '_blank', 'width=550,height=420');
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="share-modal" onClick={e => e.stopPropagation()}>
            <div className="share-modal-header">
              <h3>Share Collection</h3>
              <button className="modal-close-btn" onClick={onClose}>
                <XIcon />
              </button>
            </div>
            
            <div className="share-modal-body">
              <p className="share-collection-name">{collection.name}</p>
              
              <div className="share-link-section">
                <label className="share-label">Collection Link</label>
                <div className="share-link-row">
                  <input 
                    type="text" 
                    className="share-link-input" 
                    value={shareUrl} 
                    readOnly 
                  />
                  <button className="btn btn-primary share-copy-btn" onClick={handleCopyLink}>
                    Copy
                  </button>
                </div>
              </div>
              
              <div className="share-options-section">
                <label className="share-label">Share via</label>
                <div className="share-options-grid">
                  <button className="share-option" onClick={handleEmailShare}>
                    <div className="share-option-icon email">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                      </svg>
                    </div>
                    <span>Email</span>
                  </button>
                  
                  <button className="share-option" onClick={handleTextShare}>
                    <div className="share-option-icon text">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                    </div>
                    <span>Text</span>
                  </button>
                  
                  <button className="share-option" onClick={handleTwitterShare}>
                    <div className="share-option-icon twitter">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                      </svg>
                    </div>
                    <span>X</span>
                  </button>
                  
                  <button className="share-option" onClick={handleFacebookShare}>
                    <div className="share-option-icon facebook">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                      </svg>
                    </div>
                    <span>Facebook</span>
                  </button>
                  
                  <button className="share-option" onClick={handlePinterestShare}>
                    <div className="share-option-icon pinterest">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.373 0 0 5.372 0 12c0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.632-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24 12 24c6.627 0 12-5.373 12-12 0-6.628-5.373-12-12-12z"/>
                      </svg>
                    </div>
                    <span>Pinterest</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // COLLECTION EXPLAINER COMPONENT
    // ==========================================
    
    // Icons for explainer
    const PlaylistIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <path d="M21 15V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14l4-4h10"></path>
        <line x1="9" y1="9" x2="15" y2="9"></line>
        <line x1="9" y1="13" x2="13" y2="13"></line>
      </svg>
    );
    
    const ThemeIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 2a7 7 0 0 0 0 14 7 7 0 0 1 0 6"></path>
      </svg>
    );
    
    const HeartIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    );
    
    const ClockIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );
    
    const SparkleIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"></path>
        <path d="M5 19l.5 1.5L7 21l-1.5.5L5 23l-.5-1.5L3 21l1.5-.5L5 19z"></path>
        <path d="M19 5l.5 1.5L21 7l-1.5.5L19 9l-.5-1.5L17 7l1.5-.5L19 5z"></path>
      </svg>
    );
    
    const CollectionStackIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
        <rect x="7" y="7" width="6" height="6" rx="1"></rect>
        <line x1="16" y1="7" x2="16" y2="13"></line>
        <line x1="7" y1="16" x2="17" y2="16"></line>
      </svg>
    );
    
    const RocketIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
        <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
        <path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
        <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
        <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
      </svg>
    );
    
    function CollectionExplainer({ isLoggedIn, onCreateAccount, onCreateCollection }) {
      return (
        <div className="collection-explainer">
          {/* Header */}
          <div className="explainer-header">
            <h1 className="explainer-title">What is a Collection?</h1>
            <p className="explainer-subtitle">
              Organize your favorite art styles into personalized groups, making it effortless to create beautiful artwork.
            </p>
          </div>
          
          {/* Analogy */}
          <div className="explainer-analogy">
            <div className="analogy-header">
              <div className="analogy-icon">
                <PlaylistIcon />
              </div>
              <h2 className="analogy-title">Think of it as a playlist for art</h2>
            </div>
            <p className="analogy-text">
              Just like you create music playlists for different moods, activities, or people in your life, 
              Collections let you group art styles together. Create one for "Grandma's Kitchen Memories," 
              another for "Beach House Vibes," or "Kids' Room Adventures." When you're ready to create art, 
              your perfect styles are already gathered in one place  no more searching through thousands of options.
            </p>
          </div>
          
          {/* Formula */}
          <div className="explainer-formula">
            <div className="formula-row">
              <div className="formula-item">
                <div className="formula-icon"><ThemeIcon /></div>
                <span className="formula-label">Your Theme</span>
              </div>
              <span className="formula-operator">+</span>
              <div className="formula-item">
                <div className="formula-icon"><HeartIcon /></div>
                <span className="formula-label">Saved Styles</span>
              </div>
              <span className="formula-operator">=</span>
              <div className="formula-item">
                <div className="formula-result-icon"><CollectionStackIcon /></div>
                <span className="formula-label">Your Collection</span>
              </div>
            </div>
          </div>
          
          {/* Benefits */}
          <div className="explainer-benefits">
            <h3 className="benefits-title">Why You'll Love Collections</h3>
            <div className="benefits-grid">
              <div className="benefit-card">
                <div className="benefit-icon"><ThemeIcon /></div>
                <h4 className="benefit-title">Organize by Theme</h4>
                <p className="benefit-text">
                  Group styles by person, place, room, or aesthetic  whatever makes sense for you.
                </p>
              </div>
              <div className="benefit-card">
                <div className="benefit-icon"><ClockIcon /></div>
                <h4 className="benefit-title">Save Time Creating</h4>
                <p className="benefit-text">
                  Skip the search. Your curated styles are ready when inspiration strikes.
                </p>
              </div>
              <div className="benefit-card">
                <div className="benefit-icon"><SparkleIcon /></div>
                <h4 className="benefit-title">Better Results</h4>
                <p className="benefit-text">
                  Pre-selected styles that match your vision lead to artwork you'll love.
                </p>
              </div>
            </div>
          </div>
          
          {/* CTA */}
          <div className="explainer-cta">
            <h2 className="cta-title">
              {isLoggedIn ? 'Ready to Get Organized?' : 'Start Building Your Collection'}
            </h2>
            <p className="cta-text">
              {isLoggedIn 
                ? 'Create your first collection and start curating styles.'
                : 'Create a free account to save and organize your favorite art styles.'}
            </p>
            <button 
              className="cta-button"
              onClick={isLoggedIn ? onCreateCollection : onCreateAccount}
            >
              {isLoggedIn ? 'Create Your First Collection' : 'Create Free Account'}
              <RocketIcon />
            </button>
          </div>
        </div>
      );
    }

    // ==========================================
    // COLLECTION VIEW COMPONENT
    // ==========================================
    
    function CollectionView({ 
      collection, 
      subCollections, 
      palette, 
      onBack, 
      onEdit, 
      onDelete,
      onDuplicate,
      onShare,
      onCollectionClick,
      onCreateSubCollection,
      onRemoveStyle,
      viewMode,
      onViewModeChange,
      sortOption,
      onSortChange,
      sortCollections
    }) {
      const styles = collection.styles || [];
      const styleCount = styles.length;
      
      // Project starter slots - auto-populate with first 4 styles
      const [projectSlots, setProjectSlots] = useState(() => {
        const initial = [null, null, null, null];
        styles.slice(0, 4).forEach((styleId, i) => {
          initial[i] = styleId;
        });
        return initial;
      });
      
      // Update slots when styles change
      useEffect(() => {
        const newSlots = [null, null, null, null];
        styles.slice(0, 4).forEach((styleId, i) => {
          newSlots[i] = styleId;
        });
        setProjectSlots(newSlots);
      }, [styles.join(',')]);
      
      const getStyleThumbnail = (styleId) => {
        return window.SocietyArts?.getStyleThumbnailUrl?.(styleId, 0) || 
               window.SocietyArts?.getAltStyleThumbnailUrl?.(styleId) ||
               `https://pub-acb560f551f141db830964aed1fa005f.r2.dev/${styleId}/${styleId}-00.webp`;
      };
      
      // Get human-readable style name
      const getStyleName = (styleId) => {
        // Try to get from style data
        const styleData = window.SocietyArts?.styleData?.[styleId] || 
                         window.styleIndex?.find(s => s.id === styleId);
        if (styleData?.name) return styleData.name;
        // Fallback: convert ID to title case
        return styleId.split('-').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
      };
      
      const handleStyleClick = (styleId) => {
        if (window.SocietyArts?.openStyleDetailModal) {
          window.SocietyArts.openStyleDetailModal(styleId, {
            collectionId: collection.id,
            collectionName: collection.name,
            onRemove: () => window.location.reload()
          });
        }
      };
      
      const handleAddToProject = (styleId) => {
        // Find first empty slot
        const emptyIndex = projectSlots.findIndex(slot => slot === null);
        if (emptyIndex !== -1) {
          const newSlots = [...projectSlots];
          newSlots[emptyIndex] = styleId;
          setProjectSlots(newSlots);
        }
      };
      
      const handleRemoveFromProject = (index) => {
        const newSlots = [...projectSlots];
        newSlots[index] = null;
        setProjectSlots(newSlots);
      };
      
      const handleStartProject = () => {
        // Get filled slots
        const selectedStyles = projectSlots.filter(s => s !== null);
        if (selectedStyles.length === 0) return;
        
        // Navigate to StoryBuilder with styles
        const stylesParam = selectedStyles.join(',');
        window.location.href = `/story-builder.html?styles=${stylesParam}&collection=${collection.id}`;
      };
      
      const filledSlotCount = projectSlots.filter(s => s !== null).length;
      const isStyleInProject = (styleId) => projectSlots.includes(styleId);
      
      return (
        <>
          {/* Back Navigation */}
          <div className="collections-back-nav">
            <button className="collections-back-btn" onClick={onBack}>
              <ChevronLeftIcon />
              Back
            </button>
          </div>
          
          {/* Project Starter */}
          <div 
            className="project-starter"
            style={{ '--collection-color': collection.color }}
          >
            <div className="project-starter-header">
              <h2 className="project-starter-title">Start a Project</h2>
              <p className="project-starter-subtitle">
                {filledSlotCount === 0 
                  ? 'Select up to 4 styles from your collection' 
                  : `${filledSlotCount} style${filledSlotCount !== 1 ? 's' : ''} selected`}
              </p>
            </div>
            
            <div className="project-starter-slots">
              {projectSlots.map((styleId, index) => (
                <div 
                  key={index}
                  className={`project-slot ${styleId ? 'filled' : ''}`}
                  onClick={() => !styleId && document.querySelector('.style-gallery')?.scrollIntoView({ behavior: 'smooth' })}
                >
                  {styleId ? (
                    <>
                      <img 
                        src={getStyleThumbnail(styleId)} 
                        alt={getStyleName(styleId)}
                        onError={e => e.target.style.opacity = 0.3}
                      />
                      <span className="project-slot-name">{getStyleName(styleId)}</span>
                      <button 
                        className="project-slot-remove"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleRemoveFromProject(index);
                        }}
                        title="Remove from project"
                      >
                        <XIcon />
                      </button>
                    </>
                  ) : (
                    <>
                      <span className="project-slot-number">{index + 1}</span>
                      <span className="project-slot-label">Add style</span>
                    </>
                  )}
                </div>
              ))}
            </div>
            
            <div className="project-starter-action">
              <button 
                className="btn-start-project"
                onClick={handleStartProject}
                disabled={filledSlotCount === 0}
              >
                Start Project
                <ArrowRightIcon />
              </button>
            </div>
          </div>
          
          {/* Collection Info Bar */}
          <div 
            className="collection-info-bar"
            style={{ '--collection-color': collection.color }}
          >
            <div className="collection-info-content">
              <h1 className="collection-info-title">{collection.name}</h1>
              {collection.description && (
                <p className="collection-info-description">{collection.description}</p>
              )}
            </div>
            <div className="collection-info-actions">
              <button className="collection-action-btn" onClick={() => onEdit(collection)}>
                Edit
              </button>
              <button className="collection-action-btn danger" onClick={() => onDelete(collection)}>
                Delete
              </button>
            </div>
          </div>
          
          {/* Styles Gallery */}
          <div className="collection-section-header">
            <h4 className="collection-section-title">Your Styles</h4>
            <span className="collection-section-count">{styleCount} style{styleCount !== 1 ? 's' : ''}</span>
          </div>
          
          <div className="style-gallery">
            {styles.map(styleId => {
              const inProject = isStyleInProject(styleId);
              const canAddToProject = !inProject && projectSlots.some(s => s === null);
              
              return (
                <div 
                  key={styleId} 
                  className={`style-gallery-card ${inProject ? 'in-project' : ''}`}
                  onClick={() => handleStyleClick(styleId)}
                >
                  {inProject && (
                    <span className="style-gallery-badge">In Project</span>
                  )}
                  
                  <div className="style-gallery-actions">
                    {canAddToProject && (
                      <button 
                        className="style-gallery-btn add-to-project"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleAddToProject(styleId);
                        }}
                        title="Add to project"
                      >
                        <PlusIcon />
                      </button>
                    )}
                    <button 
                      className="style-gallery-btn remove"
                      onClick={(e) => {
                        e.stopPropagation();
                        onRemoveStyle(collection.id, styleId);
                      }}
                      title="Remove from collection"
                    >
                      <XIcon />
                    </button>
                  </div>
                  
                  <div className="style-gallery-image">
                    <img 
                      src={getStyleThumbnail(styleId)} 
                      alt={getStyleName(styleId)}
                      onError={e => e.target.style.opacity = 0.3}
                    />
                  </div>
                  
                  <div className="style-gallery-info">
                    <h3 className="style-gallery-name">{getStyleName(styleId)}</h3>
                    <span className="style-gallery-id">{styleId}</span>
                  </div>
                </div>
              );
            })}
            
            {/* Add Styles Card */}
            <div 
              className="style-gallery-add"
              onClick={() => window.location.href = '/style-finder.html'}
            >
              <PlusIcon />
              <span>Add Styles</span>
            </div>
          </div>
        </>
      );
    }

    // ==========================================
    // MAIN COLLECTIONS PAGE COMPONENT
    // ==========================================
    
    function CollectionsPage() {
      const { Header, Sidebar } = window.SocietyArts || {};
      
      if (!Sidebar || !Header) {
        return React.createElement('div', { className: 'loading-state' }, 'Loading...');
      }
      
      const { user, profile, isLoading: authLoading } = window.SocietyArts.useAuth();
      const [collections, setCollections] = useState([]);
      const [palette, setPalette] = useState(DEFAULT_PALETTE);
      const [isLoading, setIsLoading] = useState(true);
      const [authChecked, setAuthChecked] = useState(false);
      const [authModalOpen, setAuthModalOpen] = useState(false);
      const [createModalOpen, setCreateModalOpen] = useState(false);
      const [editingCollection, setEditingCollection] = useState(null);
      const [currentView, setCurrentView] = useState(null); // null = root, or collection object
      const [breadcrumbs, setBreadcrumbs] = useState([]);
      const [createParentId, setCreateParentId] = useState(null);
      const [deleteModalOpen, setDeleteModalOpen] = useState(false);
      const [collectionToDelete, setCollectionToDelete] = useState(null);
      const [shareModalOpen, setShareModalOpen] = useState(false);
      const [collectionToShare, setCollectionToShare] = useState(null);
      
      // View mode state - load from localStorage or default to 'compact'
      const [viewMode, setViewMode] = useState(() => {
        const saved = localStorage.getItem('collections-view-mode');
        return saved || 'compact';
      });
      
      // Handle view mode change with persistence
      const handleViewModeChange = (mode) => {
        setViewMode(mode);
        localStorage.setItem('collections-view-mode', mode);
      };
      
      // Sort state - load from localStorage or default to 'modified-desc'
      const [sortOption, setSortOption] = useState(() => {
        const saved = localStorage.getItem('collections-sort-option');
        return saved || 'modified-desc';
      });
      
      // Handle sort change with persistence
      const handleSortChange = (option) => {
        setSortOption(option);
        localStorage.setItem('collections-sort-option', option);
      };
      
      // Sort collections based on current sort option
      const sortCollections = (collectionsToSort) => {
        if (!collectionsToSort || collectionsToSort.length === 0) return [];
        
        const sorted = [...collectionsToSort];
        const [field, direction] = sortOption.split('-');
        const isAsc = direction === 'asc';
        
        sorted.sort((a, b) => {
          let comparison = 0;
          
          switch (field) {
            case 'name':
              comparison = (a.name || '').localeCompare(b.name || '');
              break;
            case 'created':
              comparison = new Date(a.created_at || 0) - new Date(b.created_at || 0);
              break;
            case 'modified':
              comparison = new Date(a.updated_at || 0) - new Date(b.updated_at || 0);
              break;
            case 'styles':
              comparison = (a.styles?.length || 0) - (b.styles?.length || 0);
              break;
            default:
              comparison = 0;
          }
          
          return isAsc ? comparison : -comparison;
        });
        
        return sorted;
      };

      // Get Supabase client
      const getSupabase = () => {
        return window.SocietyArts?.supabase || window.supabaseClient || window.supabase;
      };

      // Wait for auth to properly initialize before showing login prompt
      useEffect(() => {
        const checkAuth = async () => {
          // If authLoading is true, wait for it
          if (authLoading) return;
          
          // Double-check session directly from Supabase
          const supabase = getSupabase();
          if (supabase) {
            try {
              const { data: { session } } = await supabase.auth.getSession();
              // If there's a session but no user yet, wait a bit for useAuth to catch up
              if (session && !user) {
                setTimeout(() => setAuthChecked(true), 100);
                return;
              }
            } catch (e) {
              console.log('Session check error:', e);
            }
          }
          
          setAuthChecked(true);
        };
        
        checkAuth();
      }, [authLoading, user]);

      // Load palette from admin_settings
      useEffect(() => {
        const loadPalette = async () => {
          try {
            const supabase = getSupabase();
            if (!supabase?.from) {
              console.log('Supabase client not ready, using default palette');
              return;
            }
            const { data, error } = await supabase
              .from('admin_settings')
              .select('value')
              .eq('key', 'collection_palette')
              .single();
            
            if (data?.value?.colors) {
              setPalette(data.value.colors);
            }
          } catch (err) {
            console.log('Using default palette');
          }
        };
        loadPalette();
      }, []);

      // Load collections
      const loadCollections = useCallback(async () => {
        if (!user) return;
        
        setIsLoading(true);
        try {
          const supabase = getSupabase();
          if (!supabase?.from) {
            console.error('Supabase client not available');
            setIsLoading(false);
            return;
          }
          
          const { data, error } = await supabase
            .from('user_collections')
            .select('*')
            .eq('user_id', user.id)
            .order('sort_order', { ascending: true })
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          // Calculate subcollection counts
          const withCounts = (data || []).map(col => ({
            ...col,
            subcollection_count: (data || []).filter(c => c.parent_id === col.id).length
          }));
          
          setCollections(withCounts);
        } catch (err) {
          console.error('Error loading collections:', err);
        } finally {
          setIsLoading(false);
        }
      }, [user]);

      useEffect(() => {
        if (user) {
          loadCollections();
        } else if (authChecked && !authLoading) {
          // No user after auth check - stop loading
          setIsLoading(false);
        }
      }, [user, authChecked, authLoading, loadCollections]);

      // Get root collections (no parent)
      const rootCollections = collections.filter(c => !c.parent_id);
      
      // Get sub-collections for current view
      const getSubCollections = (parentId) => {
        return collections.filter(c => c.parent_id === parentId);
      };

      // Handle create/update collection
      const handleSaveCollection = async (collectionData) => {
        try {
          const supabase = getSupabase();
          if (!supabase?.from) {
            throw new Error('Supabase client not available');
          }
          
          if (collectionData.id) {
            // Update existing
            const { error } = await supabase
              .from('user_collections')
              .update({
                name: collectionData.name,
                description: collectionData.description,
                color: collectionData.color,
                updated_at: new Date().toISOString()
              })
              .eq('id', collectionData.id)
              .eq('user_id', user.id);
            
            if (error) throw error;
            
            // Update currentView if we're editing the currently viewed collection
            if (currentView?.id === collectionData.id) {
              setCurrentView(prev => ({
                ...prev,
                name: collectionData.name,
                description: collectionData.description,
                color: collectionData.color
              }));
            }
          } else {
            // Create new
            const { error } = await supabase
              .from('user_collections')
              .insert({
                user_id: user.id,
                name: collectionData.name,
                description: collectionData.description,
                color: collectionData.color,
                parent_id: collectionData.parent_id,
                styles: []
              });
            
            if (error) throw error;
          }
          
          await loadCollections();
          setEditingCollection(null);
          setCreateParentId(null);
        } catch (err) {
          console.error('Error saving collection:', err);
          alert('Failed to save collection. Please try again.');
        }
      };

      // Handle delete collection - opens confirmation modal
      const handleDeleteCollection = (collection) => {
        setCollectionToDelete(collection);
        setDeleteModalOpen(true);
      };

      // Confirm delete - actually performs the deletion
      const confirmDeleteCollection = async () => {
        if (!collectionToDelete) return;
        
        try {
          const supabase = getSupabase();
          if (!supabase?.from) {
            throw new Error('Supabase client not available');
          }
          
          const { error } = await supabase
            .from('user_collections')
            .delete()
            .eq('id', collectionToDelete.id);
          
          if (error) throw error;
          
          await loadCollections();
          
          // If we deleted the current view, go back
          if (currentView?.id === collectionToDelete.id) {
            handleBack();
          }
          
          // Close modal and reset state
          setDeleteModalOpen(false);
          setCollectionToDelete(null);
        } catch (err) {
          console.error('Error deleting collection:', err);
          alert('Failed to delete collection. Please try again.');
        }
      };

      // Get sub-collection count for delete modal
      const getSubCollectionCount = (collection) => {
        if (!collection) return 0;
        return collections.filter(c => c.parent_id === collection.id).length;
      };

      // Handle edit collection - opens edit modal
      const handleEditCollection = (collection) => {
        setEditingCollection(collection);
        setCreateModalOpen(true);
      };

      // Handle duplicate collection
      // Handle duplicate collection - deep copy including all contents
      const handleDuplicateCollection = async (collection) => {
        try {
          const supabase = getSupabase();
          
          if (!supabase?.from || !user) {
            throw new Error('Not authenticated');
          }
          
          // Recursive function to duplicate a collection and all its contents
          const duplicateRecursive = async (sourceCollection, newParentId, isRoot = false) => {
            // Create the new collection with styles copied directly
            const { data: newCollection, error: createError } = await supabase
              .from('user_collections')
              .insert({
                user_id: user.id,
                name: isRoot ? `Copy of ${sourceCollection.name}` : sourceCollection.name,
                description: sourceCollection.description,
                color: sourceCollection.color,
                parent_id: newParentId,
                styles: sourceCollection.styles || [] // Copy styles array directly
              })
              .select()
              .single();
            
            if (createError) throw createError;
            
            // Find and duplicate all sub-collections (folders)
            const subCollections = collections.filter(c => c.parent_id === sourceCollection.id);
            
            for (const subCollection of subCollections) {
              // Recursively duplicate each sub-collection with the new parent
              await duplicateRecursive(subCollection, newCollection.id, false);
            }
            
            return newCollection;
          };
          
          // Start the recursive duplication from the selected collection
          await duplicateRecursive(collection, collection.parent_id, true);
          
          await loadCollections();
        } catch (err) {
          console.error('Error duplicating collection:', err);
          alert('Failed to duplicate collection. Please try again.');
        }
      };

      // Handle share collection - opens share modal
      const handleShareCollection = (collection) => {
        setCollectionToShare(collection);
        setShareModalOpen(true);
      };

      // Handle collection click
      const handleCollectionClick = (collection) => {
        setBreadcrumbs(prev => [...prev, currentView].filter(Boolean));
        setCurrentView(collection);
      };

      // Handle back navigation
      const handleBack = () => {
        const prevView = breadcrumbs[breadcrumbs.length - 1] || null;
        setBreadcrumbs(prev => prev.slice(0, -1));
        setCurrentView(prevView);
      };

      // Handle create sub-collection
      const handleCreateSubCollection = () => {
        setCreateParentId(currentView?.id || null);
        setCreateModalOpen(true);
      };

      // Handle remove style from collection
      const handleRemoveStyle = async (collectionId, styleId) => {
        try {
          const supabase = getSupabase();
          if (!supabase?.from) {
            throw new Error('Supabase client not available');
          }
          
          const collection = collections.find(c => c.id === collectionId);
          if (!collection) return;
          
          const updatedStyles = (collection.styles || []).filter(s => s !== styleId);
          
          const { error } = await supabase
            .from('user_collections')
            .update({ 
              styles: updatedStyles,
              updated_at: new Date().toISOString()
            })
            .eq('id', collectionId);
          
          if (error) throw error;
          
          await loadCollections();
          
          // Update current view if we're viewing this collection
          if (currentView?.id === collectionId) {
            setCurrentView(prev => ({ ...prev, styles: updatedStyles }));
          }
        } catch (err) {
          console.error('Error removing style:', err);
        }
      };

      // Build breadcrumb path
      const buildBreadcrumbPath = () => {
        const path = [{ name: 'Collections', onClick: () => { setCurrentView(null); setBreadcrumbs([]); }}];
        
        breadcrumbs.forEach((crumb, index) => {
          if (crumb) {
            path.push({
              name: crumb.name,
              onClick: () => {
                setBreadcrumbs(prev => prev.slice(0, index));
                setCurrentView(crumb);
              }
            });
          }
        });
        
        if (currentView) {
          path.push({ name: currentView.name, onClick: null });
        }
        
        return path;
      };

      const AuthModal = window.SocietyArts?.AuthModal;

      return (
        <div className="page-container">
          <Sidebar />
          <Header user={user} profile={profile} />
          
          <main className="collections-content">
            {/* Breadcrumb */}
            <div className="collections-breadcrumb">
              <a href="index.html">Home</a>
              <ChevronRightIcon />
              {buildBreadcrumbPath().map((crumb, index, arr) => (
                <React.Fragment key={index}>
                  {crumb.onClick ? (
                    <a href="#" onClick={e => { e.preventDefault(); crumb.onClick(); }}>
                      {crumb.name}
                    </a>
                  ) : (
                    <span>{crumb.name}</span>
                  )}
                  {index < arr.length - 1 && <ChevronRightIcon />}
                </React.Fragment>
              ))}
            </div>
            
            {/* Page Header (only on root view) */}
            {!currentView && (
              <div className="collections-header">
                <h1 className="collections-title">Collections</h1>
                <p className="collections-subtitle">Organize and save your favorite art styles</p>
              </div>
            )}
            
            {/* Main Content */}
            {authLoading || isLoading || !authChecked ? (
              <div className="loading-state">Loading...</div>
            ) : !user ? (
              // Not logged in - show explainer with sign up CTA
              <CollectionExplainer 
                isLoggedIn={false}
                onCreateAccount={() => setAuthModalOpen(true)}
                onCreateCollection={() => setCreateModalOpen(true)}
              />
            ) : currentView ? (
              // Collection Detail View
              <CollectionView
                collection={currentView}
                subCollections={getSubCollections(currentView.id)}
                palette={palette}
                onBack={handleBack}
                onEdit={handleEditCollection}
                onDelete={handleDeleteCollection}
                onDuplicate={handleDuplicateCollection}
                onShare={handleShareCollection}
                onCollectionClick={handleCollectionClick}
                onCreateSubCollection={handleCreateSubCollection}
                onRemoveStyle={handleRemoveStyle}
                viewMode={viewMode}
                onViewModeChange={handleViewModeChange}
                sortOption={sortOption}
                onSortChange={handleSortChange}
                sortCollections={sortCollections}
              />
            ) : rootCollections.length === 0 ? (
              // Empty State - logged in but no collections
              <CollectionExplainer 
                isLoggedIn={true}
                onCreateAccount={() => setAuthModalOpen(true)}
                onCreateCollection={() => setCreateModalOpen(true)}
              />
            ) : (
              // Root Collections Grid
              <>
                <CollectionsToolbar 
                  onAddCollection={() => setCreateModalOpen(true)}
                  viewMode={viewMode}
                  onViewChange={handleViewModeChange}
                  sortOption={sortOption}
                  onSortChange={handleSortChange}
                />
                {viewMode === 'table' ? (
                  <CollectionsTable
                    collections={sortCollections(rootCollections)}
                    palette={palette}
                    onClick={handleCollectionClick}
                    onEdit={handleEditCollection}
                    onDelete={handleDeleteCollection}
                    onDuplicate={handleDuplicateCollection}
                    onShare={handleShareCollection}
                    sortOption={sortOption}
                    onSortChange={handleSortChange}
                  />
                ) : (
                  <div className={`collections-grid view-${viewMode}`}>
                    {sortCollections(rootCollections).map(collection => (
                      <CollectionCard 
                        key={collection.id}
                        collection={collection}
                        palette={palette}
                        onClick={handleCollectionClick}
                        onEdit={handleEditCollection}
                        onDelete={handleDeleteCollection}
                        onDuplicate={handleDuplicateCollection}
                        onShare={handleShareCollection}
                        viewMode={viewMode}
                      />
                    ))}
                  </div>
                )}
              </>
            )}
          </main>
          
          {/* Auth Modal */}
          {authModalOpen && AuthModal && (
            <AuthModal 
              isOpen={authModalOpen}
              onClose={() => setAuthModalOpen(false)}
            />
          )}
          
          {/* Create/Edit Modal */}
          <CollectionModal
            isOpen={createModalOpen || !!editingCollection}
            onClose={() => {
              setCreateModalOpen(false);
              setEditingCollection(null);
              setCreateParentId(null);
            }}
            onSave={handleSaveCollection}
            collection={editingCollection}
            palette={palette}
            parentId={createParentId}
          />
          
          {/* Delete Confirmation Modal */}
          <DeleteConfirmationModal
            isOpen={deleteModalOpen}
            onClose={() => {
              setDeleteModalOpen(false);
              setCollectionToDelete(null);
            }}
            onConfirm={confirmDeleteCollection}
            collection={collectionToDelete}
            subCollectionCount={getSubCollectionCount(collectionToDelete)}
          />
          
          {/* Share Modal */}
          <ShareModal
            isOpen={shareModalOpen}
            onClose={() => {
              setShareModalOpen(false);
              setCollectionToShare(null);
            }}
            collection={collectionToShare}
          />
        </div>
      );
    }

    // ==========================================
    // INITIALIZE APP
    // ==========================================
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    
    function waitForComponents(callback, maxAttempts = 50) {
      let attempts = 0;
      const check = () => {
        attempts++;
        const hasComponents = window.SocietyArts?.Sidebar && window.SocietyArts?.Header && window.SocietyArts?.useAuth;
        const hasSupabase = window.SocietyArts?.supabase?.from || window.supabaseClient?.from || window.supabase?.from;
        
        if (hasComponents && hasSupabase) {
          callback();
        } else if (attempts < maxAttempts) {
          setTimeout(check, 100);
        } else {
          console.error('Components or Supabase failed to load');
          callback();
        }
      };
      check();
    }
    
    waitForComponents(() => {
      root.render(<CollectionsPage />);
    });
  </script>
</body>
</html>
