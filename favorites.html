<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Favorites - Society Arts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://pub-acb560f551f141db830964aed1fa005f.r2.dev/site-assets/SA_Monogram_Black%401x%201x1.png">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared/supabase-client.js"></script>
  
  <!-- Fonts - Familjen Grotesk + Domine -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/help-modals.css">
  
  <style>
    .favorites-content {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-2xl);
      width: 100%;
    }
    
    .favorites-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2xl);
    }
    
    .favorites-title {
      font-family: var(--font-serif);
      font-size: var(--text-3xl);
      font-weight: var(--weight-normal);
      margin: 0;
    }
    
    .favorites-count {
      color: var(--color-text-muted);
      font-size: var(--text-lg);
      margin-left: var(--space-md);
    }
    
    /* Table View */
    .favorites-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .favorites-table th {
      text-align: left;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 2px solid var(--color-border);
      font-weight: var(--weight-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .favorites-table td {
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border);
      vertical-align: middle;
    }
    
    .favorites-table tr:hover {
      background: var(--color-surface-alt);
    }
    
    .favorites-table tr {
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .favorite-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-md);
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .favorite-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .style-id-cell {
      font-family: monospace;
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    
    .style-name-cell {
      font-weight: var(--weight-medium);
    }
    
    .date-cell {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    
    .action-cell {
      text-align: right;
    }
    
    .favorite-heart {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #dc2626;
      transition: all 0.2s;
    }
    
    .favorite-heart:hover {
      background: #fee2e2;
      transform: scale(1.1);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-5xl) var(--space-xl);
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      background: var(--color-surface-alt);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-xl);
      color: var(--color-text-muted);
    }
    
    .empty-title {
      font-family: var(--font-serif);
      font-size: var(--text-xl);
      margin-bottom: var(--space-sm);
    }
    
    .empty-text {
      color: var(--color-text-muted);
      margin-bottom: var(--space-xl);
    }
    
    .loading-state {
      text-align: center;
      padding: var(--space-5xl);
      color: var(--color-text-muted);
    }
    
    .login-prompt {
      text-align: center;
      padding: var(--space-5xl) var(--space-xl);
    }
    
    .login-prompt h2 {
      font-family: var(--font-serif);
      margin-bottom: var(--space-md);
    }
    
    .login-prompt p {
      color: var(--color-text-muted);
      margin-bottom: var(--space-xl);
    }
    
    @media (max-width: 768px) {
      .favorites-table th:nth-child(1),
      .favorites-table td:nth-child(1) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Shared Components -->
  <script src="/js/shared/api.js"></script>
  <script src="/js/shared/auth.js"></script>
  <script src="/js/shared/projects.js"></script>
  <script src="/js/shared/header.js"></script>
  <script src="/js/style-finder/style-data.js"></script>
  
  <!-- Favorites App -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function FavoritesPage() {
      // Get shared components inside the function to ensure they're loaded
      const { Header, Sidebar, Footer, Icons } = window.SocietyArts || {};
      
      // Loading check
      if (!Sidebar || !Header) {
        return React.createElement('div', { className: 'loading-state' }, 'Loading...');
      }
      
      const { user, profile, isLoading: authLoading } = window.SocietyArts.useAuth();
      const { favorites, isStyleFavorited, removeFavorite, loadFavorites } = window.SocietyArts.useFavorites();
      const [styles, setStyles] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [authModalOpen, setAuthModalOpen] = useState(false);

      useEffect(() => {
        if (user) {
          loadFavoritesData();
        }
      }, [user]);

      const loadFavoritesData = async () => {
        setIsLoading(true);
        const loadedFavorites = await loadFavorites();
        
        // Get unique style IDs
        const favoriteIds = loadedFavorites.map(f => f.style_id);
        
        if (favoriteIds.length > 0 && window.SocietyArts.supabase) {
          const { data } = await window.SocietyArts.supabase
            .from('styles')
            .select('id, name, image_urls')
            .in('id', favoriteIds);
          
          if (data) {
            // Merge style data with favorite data (for dates)
            const stylesWithDates = data.map(style => {
              const fav = loadedFavorites.find(f => f.style_id === style.id);
              return {
                ...style,
                created_at: fav?.created_at,
                style_name: fav?.style_name || style.name
              };
            });
            setStyles(stylesWithDates);
          }
        }
        setIsLoading(false);
      };

      const handleRemoveFavorite = async (e, styleId) => {
        e.stopPropagation();
        await removeFavorite(styleId);
        setStyles(prev => prev.filter(s => s.id !== styleId));
      };

      const handleStyleClick = (styleId) => {
        window.location.href = `/style-finder.html?style=${styleId}`;
      };

      const getStyleImage = (styleId) => {
        const style = styles.find(s => s.id === styleId);
        if (style?.image_urls?.length > 0) {
          return style.image_urls[0];
        }
        return window.SocietyArts.getAltStyleThumbnailUrl(styleId);
      };

      const formatDate = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric'
        });
      };

      return (
        <div className="page-container">
          <Sidebar />
          <Header />
          
          <main className="main-content favorites-content">
            {authLoading ? (
              <div className="loading-state">Loading...</div>
            ) : !user ? (
              <div className="login-prompt">
                <h2>Sign in to view your favorites</h2>
                <p>Create an account or sign in to save and manage your favorite styles.</p>
                <button 
                  className="btn btn-primary"
                  onClick={() => setAuthModalOpen(true)}
                >
                  Sign In
                </button>
              </div>
            ) : (
              <>
                <div className="favorites-header">
                  <h1 className="favorites-title">
                    My Favorites
                    <span className="favorites-count">({styles.length})</span>
                  </h1>
                </div>

                {isLoading ? (
                  <div className="loading-state">Loading favorites...</div>
                ) : styles.length === 0 ? (
                  <div className="empty-state">
                    <div className="empty-icon">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                      </svg>
                    </div>
                    <h3 className="empty-title">No favorites yet</h3>
                    <p className="empty-text">Browse styles and click the heart icon to add them to your favorites.</p>
                    <a href="/style-finder.html" className="btn btn-primary">
                      Browse Styles
                      <Icons.arrowRight />
                    </a>
                  </div>
                ) : (
                  <table className="favorites-table">
                    <thead>
                      <tr>
                        <th style={{width: '80px'}}></th>
                        <th>Style ID</th>
                        <th>Title</th>
                        <th>Date Added</th>
                        <th style={{width: '60px'}}></th>
                      </tr>
                    </thead>
                    <tbody>
                      {styles.map(style => (
                        <tr 
                          key={style.id}
                          onClick={() => handleStyleClick(style.id)}
                        >
                          <td>
                            <div className="favorite-thumbnail">
                              <img loading="lazy"
                                src={getStyleImage(style.id)}
                                alt={style.name}
                                onError={e => {
                                  e.target.src = window.SocietyArts.getAltStyleThumbnailUrl(style.id);
                                }}
                              />
                            </div>
                          </td>
                          <td className="style-id-cell">{style.id}</td>
                          <td className="style-name-cell">{style.name}</td>
                          <td className="date-cell">{formatDate(style.created_at)}</td>
                          <td className="action-cell">
                            <button
                              className="favorite-heart"
                              onClick={(e) => handleRemoveFavorite(e, style.id)}
                              title="Remove from favorites"
                            >
                              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                              </svg>
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </>
            )}
          </main>
          
          <Footer />
          
          {/* Auth Modal */}
          <window.SocietyArts.AuthModal 
            isOpen={authModalOpen}
            onClose={() => setAuthModalOpen(false)}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    
    // Wait for all components to be loaded and auth initialized
    function waitForComponents(callback, maxAttempts = 50) {
      let attempts = 0;
      const check = () => {
        attempts++;
        if (window.SocietyArts?.Sidebar && window.SocietyArts?.Header && window.SocietyArts?.useAuth) {
          // Initialize auth before rendering
          if (window.initializeAuth && !window.AuthState?.initialized) {
            window.initializeAuth().then(callback);
          } else {
            callback();
          }
        } else if (attempts < maxAttempts) {
          setTimeout(check, 100);
        } else {
          console.error('Components failed to load');
          callback();
        }
      };
      check();
    }
    
    waitForComponents(() => {
      root.render(<FavoritesPage />);
    });
  </script>
</body>
</html>
